

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    
    <title>Optimizing mining operations &#8212; DOcplex.MP: Mathematical Programming Modeling for Python V2.8 documentation</title>
    
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     'V2.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The Nurse Assignment Problem" href="nurses_pandas.html" />
    <link rel="prev" title="How to make targeted offers to customers?" href="marketing_campaign.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="nurses_pandas.html" title="The Nurse Assignment Problem"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="marketing_campaign.html" title="How to make targeted offers to customers?"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="samples.html" accesskey="U">Examples of mathematical programming</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Optimizing mining operations</a><ul>
<li><a class="reference internal" href="#describe-the-business-problem">Describe the business problem</a><ul>
<li><a class="reference internal" href="#business-constraints">Business constraints</a></li>
<li><a class="reference internal" href="#objective-and-kpis">Objective and KPIs</a><ul>
<li><a class="reference internal" href="#total-actualized-revenue">Total actualized revenue</a></li>
<li><a class="reference internal" href="#total-expected-royalties">Total expected royalties</a></li>
<li><a class="reference internal" href="#business-objective">Business objective</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-decision-optimization-can-help">How decision optimization can help</a></li>
<li><a class="reference internal" href="#checking-minimum-requirements">Checking minimum requirements</a></li>
<li><a class="reference internal" href="#use-decision-optimization">Use decision optimization</a><ul>
<li><a class="reference internal" href="#step-1-download-the-library">Step 1: Download the library</a></li>
<li><a class="reference internal" href="#step-2-model-the-data">Step 2: Model the data</a><ul>
<li><a class="reference internal" href="#mining-data">Mining Data</a></li>
<li><a class="reference internal" href="#blend-quality-data">Blend quality data</a></li>
<li><a class="reference internal" href="#additional-global-data">Additional (global) data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-3-prepare-the-data">Step 3: Prepare the data</a></li>
<li><a class="reference internal" href="#step-4-set-up-the-prescriptive-model">Step 4: Set up the prescriptive model</a><ul>
<li><a class="reference internal" href="#create-docplex-model">Create DOcplex model</a></li>
<li><a class="reference internal" href="#define-the-decision-variables">Define the decision variables</a></li>
<li><a class="reference internal" href="#express-the-business-constraints">Express the business constraints</a><ul>
<li><a class="reference internal" href="#constraint-1-only-open-mines-can-be-worked">Constraint 1: Only open mines can be worked.</a></li>
<li><a class="reference internal" href="#constraint-2-once-closed-a-mine-stays-closed">Constraint 2: Once closed, a mine stays closed.</a></li>
<li><a class="reference internal" href="#constraint-3-the-number-of-worked-mines-each-year-is-limited">Constraint 3: The number of worked mines each year is limited.</a></li>
<li><a class="reference internal" href="#constraint-4-the-quantity-extracted-is-limited">Constraint 4: The quantity extracted is limited.</a></li>
<li><a class="reference internal" href="#blend-constraints">Blend constraints</a></li>
<li><a class="reference internal" href="#minimum-average-blend-quality-constraint">Minimum average blend quality constraint</a></li>
</ul>
</li>
<li><a class="reference internal" href="#kpis-and-objective">KPIs and objective</a><ul>
<li><a class="reference internal" href="#the-discount-rate-array">The discount rate array</a></li>
<li><a class="reference internal" href="#id1">Total actualized revenue</a></li>
<li><a class="reference internal" href="#total-actualized-royalty-cost">Total actualized royalty cost</a></li>
</ul>
</li>
<li><a class="reference internal" href="#express-the-objective">Express the objective</a></li>
<li><a class="reference internal" href="#solve-with-the-decision-optimization-solve-service">Solve with the Decision Optimization solve service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-5-investigate-the-solution-and-then-run-an-example-analysis">Step 5: Investigate the solution and then run an example analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-operational-constraints">Adding operational constraints.</a></li>
<li><a class="reference internal" href="#using-an-heuristic-start-solution">Using an heuristic start solution</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="marketing_campaign.html"
                        title="previous chapter">How to make targeted offers to customers?</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nurses_pandas.html"
                        title="next chapter">The Nurse Assignment Problem</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="optimizing-mining-operations">
<h1>Optimizing mining operations<a class="headerlink" href="#optimizing-mining-operations" title="Permalink to this headline">&para;</a></h1>
<p>This tutorial includes everything you need to set up IBM Decision
Optimization CPLEX Modeling for Python (DOcplex), build a Mathematical
Programming model, and get its solution by solving the model on Cloud
with IBM ILOG CPLEX Optimizer.</p>
<p>When you finish this tutorial, you&#8217;ll have a foundational knowledge of
<em>Prescriptive Analytics</em>.</p>
<blockquote>
<div><p>This notebook is part of <a class="reference external" href="https://rawgit.com/IBMDecisionOptimization/docplex-doc/master/docs/index.html">Prescriptive Analytics for
Python</a>.</p>
<p>Running the sample requires the installation of
<a class="reference external" href="https://www.ibm.com/products/ilog-cplex-optimization-studio">CPLEX Optimization studio</a>
(Commercial or free
<a class="reference external" href="https://www.ibm.com/account/reg/us-en/signup?formid=urx-20028">CPLEX Community edition</a>).
You  can also just <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">cplex</span></code> to install
<em>CPLEX Community edition</em> and start exploring.</p>
</div></blockquote>
<p>Table of contents:</p>
<ul class="simple">
<li><a class="reference internal" href="#describe-the-business-problem">Describe the business problem</a></li>
<li><a class="reference internal" href="#how-decision-optimization-can-help">How  decision optimization can help</a></li>
<li><a class="reference internal" href="#use-decision-optimization">Use decision optimization</a><ul>
<li><a class="reference internal" href="#step-1-download-the-library">Step 1: Download the library</a></li>
<li><a class="reference internal" href="#step-2-model-the-data">Step 2: Model the data</a></li>
<li><a class="reference internal" href="#step-3-prepare-the-data">Step 3: Prepare the data</a></li>
<li><a class="reference internal" href="#step-4-set-up-the-prescriptive-model">Step 4: Set up the prescriptive model</a><ul>
<li><a class="reference internal" href="#define-the-decision-variables">Define the decision variables</a></li>
<li><a class="reference internal" href="#express-the-business-constraints">Express the business constraints</a></li>
<li><a class="reference internal" href="#express-the-objective">Express the objective</a></li>
<li><a class="reference internal" href="#solve-with-the-decision-optimization-solve-service">Solve with the Decision Optimization solve service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-5-investigate-the-solution-and-then-run-an-example-analysis">Step 5: Investigate the solution and then run an example analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
<hr class="docutils" />
<div class="section" id="describe-the-business-problem">
<h2>Describe the business problem<a class="headerlink" href="#describe-the-business-problem" title="Permalink to this headline">&para;</a></h2>
<p>This mining operations optimization problem is an implementation of
Problem 7 from &#8220;Model Building in Mathematical Programming&#8221; by H.P.
Williams. The operational decisions that need to be made are which mines
should be operated each year and how much each mine should produce.</p>
<div class="section" id="business-constraints">
<h3>Business constraints<a class="headerlink" href="#business-constraints" title="Permalink to this headline">&para;</a></h3>
<ul class="simple">
<li>A mine that is closed cannot be worked.</li>
<li>Once closed, a mine stays closed until the end of the horizon.</li>
<li>Each year, a maximum number of mines can be worked.</li>
<li>For each mine and year, the quantity extracted is limited by the
mine&#8217;s maximum extracted quantity.</li>
<li>The average blend quality must be greater than or equal to the
requirement of the year.</li>
</ul>
</div>
<div class="section" id="objective-and-kpis">
<h3>Objective and KPIs<a class="headerlink" href="#objective-and-kpis" title="Permalink to this headline">&para;</a></h3>
<div class="section" id="total-actualized-revenue">
<h4>Total actualized revenue<a class="headerlink" href="#total-actualized-revenue" title="Permalink to this headline">&para;</a></h4>
<p>Each year, the total revenue is equal to the total quantity extracted
multiplied by the blend price. The time series of revenues is aggregated
in one expected revenue by applying the discount rate; in other terms, a
revenue of $1000 next year is counted as $900 actualized, $810 if the
revenue is expected in two years, etc.</p>
</div>
<div class="section" id="total-expected-royalties">
<h4>Total expected royalties<a class="headerlink" href="#total-expected-royalties" title="Permalink to this headline">&para;</a></h4>
<p>A mine that stays open must pay royalties (see the column <strong>royalties</strong>
in the DataFrame). Again, royalties from different years are actualized
using the discount rate.</p>
</div>
<div class="section" id="business-objective">
<h4>Business objective<a class="headerlink" href="#business-objective" title="Permalink to this headline">&para;</a></h4>
<p>The business objective is to maximize the net actualized profit, that is
the difference between the total actualized revenue and total actualized
royalties.</p>
</div>
</div>
</div>
<div class="section" id="how-decision-optimization-can-help">
<h2>How decision optimization can help<a class="headerlink" href="#how-decision-optimization-can-help" title="Permalink to this headline">&para;</a></h2>
<ul>
<li><p class="first">Prescriptive analytics (decision optimization) technology recommends
actions that are based on desired outcomes. It takes into account
specific scenarios, resources, and knowledge of past and current
events. With this insight, your organization can make better
decisions and have greater control of business outcomes.</p>
</li>
<li><p class="first">Prescriptive analytics is the next step on the path to insight-based
actions. It creates value through synergy with predictive analytics,
which analyzes data to predict future outcomes.</p>
</li>
<li><div class="first line-block">
<div class="line">Prescriptive analytics takes that insight to the next level by
suggesting the optimal way to handle that future situation.
Organizations that can act fast in dynamic conditions and make
superior decisions in uncertain environments gain a strong
competitive advantage.</div>
<div class="line"><br /></div>
</div>
</li>
</ul>
<p>With prescriptive analytics, you can:</p>
<ul class="simple">
<li>Automate the complex decisions and trade-offs to better manage your
limited resources.</li>
<li>Take advantage of a future opportunity or mitigate a future risk.</li>
<li>Proactively update recommendations based on changing events.</li>
<li>Meet operational goals, increase customer loyalty, prevent threats
and fraud, and optimize business processes.</li>
</ul>
</div>
<div class="section" id="checking-minimum-requirements">
<h2>Checking minimum requirements<a class="headerlink" href="#checking-minimum-requirements" title="Permalink to this headline">&para;</a></h2>
<p>This notebook uses some features of pandas that are available in version
0.17.1 or above.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pip</span>
<span class="n">REQUIRED_MINIMUM_PANDAS_VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.17.1&#39;</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">key</span> <span class="p">:</span> <span class="n">pkg</span><span class="o">.</span><span class="n">version</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">pip</span><span class="o">.</span><span class="n">get_installed_distributions</span><span class="p">()}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pandas&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">REQUIRED_MINIMUM_PANDAS_VERSION</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Version &quot;</span> <span class="o">+</span> <span class="n">REQUIRED_MINIMUM_PANDAS_VERSION</span> <span class="o">+</span> <span class="s2">&quot; or above of Pandas is required to run this notebook&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="use-decision-optimization">
<h2>Use decision optimization<a class="headerlink" href="#use-decision-optimization" title="Permalink to this headline">&para;</a></h2>
<div class="section" id="step-1-download-the-library">
<h3>Step 1: Download the library<a class="headerlink" href="#step-1-download-the-library" title="Permalink to this headline">&para;</a></h3>
<p>Run the following code to install the Decision Optimization CPLEX
Modeling library. The <em>DOcplex</em> library contains the two modeling
packages, Mathematical Programming and Constraint Programming, referred
to earlier.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>import sys
try:
    import docplex.mp
except:
    if hasattr(sys, &#39;real_prefix&#39;):
        #we are in a virtual env.
        !pip install docplex
    else:
        !pip install --user docplex
</pre></div>
</div>
<p>If <em>CPLEX</em> is not installed, install CPLEX Community edition.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>try:
    import cplex
except:
    if hasattr(sys, &#39;real_prefix&#39;):
        #we are in a virtual env.
        !pip install cplex
    else:
        !pip install --user cplex
</pre></div>
</div>
</div>
<div class="section" id="step-2-model-the-data">
<h3>Step 2: Model the data<a class="headerlink" href="#step-2-model-the-data" title="Permalink to this headline">&para;</a></h3>
<div class="section" id="mining-data">
<h4>Mining Data<a class="headerlink" href="#mining-data" title="Permalink to this headline">&para;</a></h4>
<p>The mine data is provided as a <em>pandas</em> DataFrame. For each mine, we are
given the amount of royalty to pay when operating the mine, its ore
quality, and the maximum quantity that we can extract from the mine.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># If needed, install the module pandas prior to executing this cell</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df_mines</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;royalties&quot;</span><span class="p">:</span>   <span class="p">[</span> <span class="mi">5</span>  <span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span>  <span class="p">],</span>
                      <span class="s2">&quot;ore_quality&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                      <span class="s2">&quot;max_extract&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="mi">2</span>  <span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">3</span>  <span class="p">]})</span>
<span class="n">nb_mines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_mines</span><span class="p">)</span>
<span class="n">df_mines</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;range_mines&#39;</span>
<span class="n">df_mines</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>max_extract</th>
      <th>ore_quality</th>
      <th>royalties</th>
    </tr>
    <tr>
      <th>range_mines</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2.0</td>
      <td>1.0</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2.5</td>
      <td>0.7</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.3</td>
      <td>1.5</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0.5</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="blend-quality-data">
<h4>Blend quality data<a class="headerlink" href="#blend-quality-data" title="Permalink to this headline">&para;</a></h4>
<p>Each year, the average blend quality of all ore extracted from the mines
must be greater than a minimum quality. This data is provided as a
<em>pandas</em> Series, the length of which is the plan horizon in years.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">blend_qualities</span> <span class="o">=</span> <span class="n">Series</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">nb_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blend_qualities</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Planning mining operations for: </span><span class="si">{}</span><span class="s2"> years&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_years</span><span class="p">))</span>
<span class="n">blend_qualities</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">Planning</span> <span class="n">mining</span> <span class="n">operations</span> <span class="k">for</span><span class="p">:</span> <span class="mi">5</span> <span class="n">years</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">5.000000</span>
<span class="n">mean</span>     <span class="mf">0.900000</span>
<span class="n">std</span>      <span class="mf">0.223607</span>
<span class="nb">min</span>      <span class="mf">0.600000</span>
<span class="mi">25</span><span class="o">%</span>      <span class="mf">0.800000</span>
<span class="mi">50</span><span class="o">%</span>      <span class="mf">0.900000</span>
<span class="mi">75</span><span class="o">%</span>      <span class="mf">1.000000</span>
<span class="nb">max</span>      <span class="mf">1.200000</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-global-data">
<h4>Additional (global) data<a class="headerlink" href="#additional-global-data" title="Permalink to this headline">&para;</a></h4>
<p>We need extra global data to run our planning model:</p>
<ul class="simple">
<li>a blend price (supposedly flat),</li>
<li>a maximum number of worked mines for any given years (typically 3),
and</li>
<li>a discount rate to compute the actualized revenue over the horizon.</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># global data</span>
<span class="n">blend_price</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_worked_mines</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># work no more than 3 mines each year</span>
<span class="n">discount_rate</span> <span class="o">=</span> <span class="mf">0.10</span>  <span class="c1"># 10% interest rate each year</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-3-prepare-the-data">
<h3>Step 3: Prepare the data<a class="headerlink" href="#step-3-prepare-the-data" title="Permalink to this headline">&para;</a></h3>
<p>The data is clean and does not need any cleansing.</p>
</div>
<div class="section" id="step-4-set-up-the-prescriptive-model">
<h3>Step 4: Set up the prescriptive model<a class="headerlink" href="#step-4-set-up-the-prescriptive-model" title="Permalink to this headline">&para;</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.environment</span> <span class="k">import</span> <span class="n">Environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">system</span> <span class="ow">is</span><span class="p">:</span> <span class="n">Windows</span> <span class="mi">64</span><span class="n">bit</span>
<span class="o">*</span> <span class="n">Python</span> <span class="ow">is</span> <span class="n">present</span><span class="p">,</span> <span class="n">version</span> <span class="ow">is</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">11</span>
<span class="o">*</span> <span class="n">docplex</span> <span class="ow">is</span> <span class="n">present</span><span class="p">,</span> <span class="n">version</span> <span class="ow">is</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">113</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="create-docplex-model">
<h4>Create DOcplex model<a class="headerlink" href="#create-docplex-model" title="Permalink to this headline">&para;</a></h4>
<p>The model contains all the business constraints and defines the
objective.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.model</span> <span class="k">import</span> <span class="n">Model</span>

<span class="n">mm</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="s2">&quot;mining_pandas&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>What are the decisions we need to make?</p>
<ul class="simple">
<li>What mines do we work each year? (a yes/no decision)</li>
<li>What mine do we keep open each year? (again a yes/no decision)</li>
<li>What quantity is extracted from each mine, each year? (a positive
number)</li>
</ul>
<p>We need to define some decision variables and add constraints to our
model related to these decisions.</p>
</div>
<div class="section" id="define-the-decision-variables">
<h4>Define the decision variables<a class="headerlink" href="#define-the-decision-variables" title="Permalink to this headline">&para;</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># auxiliary data: ranges</span>
<span class="n">range_mines</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_mines</span><span class="p">)</span>
<span class="n">range_years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_years</span><span class="p">)</span>

<span class="c1"># binary decisions: work the mine or not</span>
<span class="n">work_vars</span>  <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">binary_var_matrix</span><span class="p">(</span><span class="n">keys1</span><span class="o">=</span><span class="n">range_mines</span><span class="p">,</span> <span class="n">keys2</span><span class="o">=</span><span class="n">range_years</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;work&#39;</span><span class="p">)</span>
<span class="c1"># open the mine or not</span>
<span class="n">open_vars</span>  <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">binary_var_matrix</span><span class="p">(</span><span class="n">range_mines</span><span class="p">,</span> <span class="n">range_years</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
<span class="c1"># quantity to extract</span>
<span class="n">ore_vars</span>   <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">continuous_var_matrix</span><span class="p">(</span><span class="n">range_mines</span><span class="p">,</span> <span class="n">range_years</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ore&#39;</span><span class="p">)</span>
<span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">60</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">20</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">0</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
</pre></div>
</div>
</div>
<div class="section" id="express-the-business-constraints">
<h4>Express the business constraints<a class="headerlink" href="#express-the-business-constraints" title="Permalink to this headline">&para;</a></h4>
<div class="section" id="constraint-1-only-open-mines-can-be-worked">
<h5>Constraint 1: Only open mines can be worked.<a class="headerlink" href="#constraint-1-only-open-mines-can-be-worked" title="Permalink to this headline">&para;</a></h5>
<p>In order to take advantage of the <em>pandas</em> operations to create the
optimization model, decision variables are organized in a DataFrame
which is automatically indexed by <em>&#8216;range_mines&#8217;</em> and <em>&#8216;range_years&#8217;</em>
(that is, the same keys as the dictionary created by the
<em>binary_var_matrix()</em> method).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Organize all decision variables in a DataFrame indexed by &#39;range_mines&#39; and &#39;range_years&#39;</span>
<span class="n">df_decision_vars</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;work&#39;</span><span class="p">:</span> <span class="n">work_vars</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">open_vars</span><span class="p">,</span> <span class="s1">&#39;ore&#39;</span><span class="p">:</span> <span class="n">ore_vars</span><span class="p">})</span>
<span class="c1"># Set index names</span>
<span class="n">df_decision_vars</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;range_mines&#39;</span><span class="p">,</span> <span class="s1">&#39;range_years&#39;</span><span class="p">]</span>

<span class="c1"># Display rows of &#39;df_decision_vars&#39; DataFrame for first mine</span>
<span class="n">df_decision_vars</span><span class="p">[:</span><span class="n">nb_years</span><span class="p">]</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>open</th>
      <th>ore</th>
      <th>work</th>
    </tr>
    <tr>
      <th>range_mines</th>
      <th>range_years</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>open_0_0</td>
      <td>ore_0_0</td>
      <td>work_0_0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_0_1</td>
      <td>ore_0_1</td>
      <td>work_0_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_0_2</td>
      <td>ore_0_2</td>
      <td>work_0_2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_0_3</td>
      <td>ore_0_3</td>
      <td>work_0_3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_0_4</td>
      <td>ore_0_4</td>
      <td>work_0_4</td>
    </tr>
  </tbody>
</table>
</div><p>Now, let&#8217;s iterate over rows of the DataFrame <em>&#8220;df_decision_vars&#8221;</em> and
enforce the desired constraint.</p>
<p>The <em>pandas</em> method <em>itertuples()</em> returns a named tuple for each row of
a DataFrame. This method is efficient and convenient for iterating over
all rows.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mm</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">work</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="o">.</span><span class="n">open</span>
                  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">itertuples</span><span class="p">())</span>
<span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">60</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">20</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">20</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
</pre></div>
</div>
</div>
<div class="section" id="constraint-2-once-closed-a-mine-stays-closed">
<h5>Constraint 2: Once closed, a mine stays closed.<a class="headerlink" href="#constraint-2-once-closed-a-mine-stays-closed" title="Permalink to this headline">&para;</a></h5>
<p>These constraints are a little more complex: we state that the series of
<em>open_vars[m,y]</em> for a given mine <strong>m</strong> is decreasing. In other terms,
once some <em>open_vars[m,y]</em> is zero, all subsequent values for future
years are also zero.</p>
<p>Let&#8217;s use the <em>pandas</em> <em>groupby</em> operation to collect all <em>&#8220;open&#8221;</em>
decision variables for each mine in separate <em>pandas</em> Series. Then, we
iterate over the mines and invoke the <em>aggregate()</em> method, passing the
<em>postOpenCloseConstraint()</em> function as the argument. The <em>pandas</em>
<em>aggregate()</em> method invokes <em>postOpenCloseConstraint()</em> for each mine,
passing the associated Series of <em>&#8220;open&#8221;</em> decision variables as
argument. The <em>postOpenCloseConstraint()</em> function posts a set of
constraints on the sequence of <em>&#8220;open&#8221;</em> decision variables to enforce
that a mine cannot re-open.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Once closed, a mine stays closed</span>
<span class="k">def</span> <span class="nf">postOpenCloseConstraint</span><span class="p">(</span><span class="n">openDVars</span><span class="p">):</span>
    <span class="n">mm</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">open_next</span> <span class="o">&lt;=</span> <span class="n">open_curr</span>
                      <span class="k">for</span> <span class="p">(</span><span class="n">open_next</span><span class="p">,</span> <span class="n">open_curr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">openDVars</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">openDVars</span><span class="p">))</span>
    <span class="c1"># Optionally: return a string to display information regarding the aggregate operation in the Output cell</span>
    <span class="k">return</span> <span class="s2">&quot;posted &quot;</span><span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">openDVars</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; constraints&quot;</span>

<span class="c1"># Constraints on sequences of decision variables are posted for each mine, using pandas&#39; &quot;groupby&quot; operation.</span>
<span class="n">df_decision_vars</span><span class="o">.</span><span class="n">open</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;range_mines&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">postOpenCloseConstraint</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">range_mines</span>
<span class="mi">0</span>    <span class="n">posted</span> <span class="mi">4</span> <span class="n">constraints</span>
<span class="mi">1</span>    <span class="n">posted</span> <span class="mi">4</span> <span class="n">constraints</span>
<span class="mi">2</span>    <span class="n">posted</span> <span class="mi">4</span> <span class="n">constraints</span>
<span class="mi">3</span>    <span class="n">posted</span> <span class="mi">4</span> <span class="n">constraints</span>
<span class="n">Name</span><span class="p">:</span> <span class="nb">open</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
</div>
<div class="section" id="constraint-3-the-number-of-worked-mines-each-year-is-limited">
<h5>Constraint 3: The number of worked mines each year is limited.<a class="headerlink" href="#constraint-3-the-number-of-worked-mines-each-year-is-limited" title="Permalink to this headline">&para;</a></h5>
<p>This time, we use the <em>pandas</em> <em>groupby</em> operation to collect all
<em>&#8220;work&#8221;</em> decision variables for each <strong>year</strong> in separate <em>pandas</em>
Series. Each Series contains the <em>&#8220;work&#8221;</em> decision variables for all
mines. Then, the maximum number of worked mines constraint is enforced
by making sure that the sum of all the terms of each Series is smaller
or equal to the maximum number of worked mines. The <em>aggregate()</em> method
is used to post this constraint for each <em>year</em>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Maximum number of worked mines each year</span>
<span class="n">df_decision_vars</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;range_years&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">works</span><span class="p">:</span> <span class="n">mm</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">works</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_worked_mines</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">range_years</span>
<span class="mi">0</span>    <span class="n">work_0_0</span><span class="o">+</span><span class="n">work_1_0</span><span class="o">+</span><span class="n">work_2_0</span><span class="o">+</span><span class="n">work_3_0</span> <span class="o">&lt;=</span> <span class="mi">3</span>
<span class="mi">1</span>    <span class="n">work_0_1</span><span class="o">+</span><span class="n">work_1_1</span><span class="o">+</span><span class="n">work_3_1</span><span class="o">+</span><span class="n">work_2_1</span> <span class="o">&lt;=</span> <span class="mi">3</span>
<span class="mi">2</span>    <span class="n">work_0_2</span><span class="o">+</span><span class="n">work_1_2</span><span class="o">+</span><span class="n">work_2_2</span><span class="o">+</span><span class="n">work_3_2</span> <span class="o">&lt;=</span> <span class="mi">3</span>
<span class="mi">3</span>    <span class="n">work_0_3</span><span class="o">+</span><span class="n">work_1_3</span><span class="o">+</span><span class="n">work_3_3</span><span class="o">+</span><span class="n">work_2_3</span> <span class="o">&lt;=</span> <span class="mi">3</span>
<span class="mi">4</span>    <span class="n">work_0_4</span><span class="o">+</span><span class="n">work_1_4</span><span class="o">+</span><span class="n">work_3_4</span><span class="o">+</span><span class="n">work_2_4</span> <span class="o">&lt;=</span> <span class="mi">3</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">work</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
</div>
<div class="section" id="constraint-4-the-quantity-extracted-is-limited">
<h5>Constraint 4: The quantity extracted is limited.<a class="headerlink" href="#constraint-4-the-quantity-extracted-is-limited" title="Permalink to this headline">&para;</a></h5>
<p>This constraint expresses two things: * Only a worked mine can give
ore. (Note that there is no minimum on the quantity extracted, this
model is very simplified). * The quantity extracted is less than the
mine&#8217;s maximum extracted quantity.</p>
<p>To illustrate the <em>pandas</em> <em>join</em> operation, let&#8217;s build a DataFrame
that joins the <em>&#8220;df_decision_vars&#8221;</em> DataFrame and the
<em>&#8220;df_mines.max_extract&#8221;</em> Series such that each row contains the
information to enforce the quantity extracted limit constraint. The
default behaviour of the <em>pandas</em> <em>join</em> operation is to look at the
index of <em>left</em> DataFrame and to append columns of the <em>right</em> Series or
DataFrame which have same index. Here is the result of this operation in
our case:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Display rows of &#39;df_decision_vars&#39; joined with &#39;df_mines.max_extract&#39; Series for first two mines</span>
<span class="n">df_decision_vars</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_mines</span><span class="o">.</span><span class="n">max_extract</span><span class="p">)[:(</span><span class="n">nb_years</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)]</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>open</th>
      <th>ore</th>
      <th>work</th>
      <th>max_extract</th>
    </tr>
    <tr>
      <th>range_mines</th>
      <th>range_years</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>open_0_0</td>
      <td>ore_0_0</td>
      <td>work_0_0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_0_1</td>
      <td>ore_0_1</td>
      <td>work_0_1</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_0_2</td>
      <td>ore_0_2</td>
      <td>work_0_2</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_0_3</td>
      <td>ore_0_3</td>
      <td>work_0_3</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_0_4</td>
      <td>ore_0_4</td>
      <td>work_0_4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th>0</th>
      <td>open_1_0</td>
      <td>ore_1_0</td>
      <td>work_1_0</td>
      <td>2.5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_1_1</td>
      <td>ore_1_1</td>
      <td>work_1_1</td>
      <td>2.5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_1_2</td>
      <td>ore_1_2</td>
      <td>work_1_2</td>
      <td>2.5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_1_3</td>
      <td>ore_1_3</td>
      <td>work_1_3</td>
      <td>2.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_1_4</td>
      <td>ore_1_4</td>
      <td>work_1_4</td>
      <td>2.5</td>
    </tr>
  </tbody>
</table>
</div><p>Now, the constraint to limit quantity extracted is easily created by
iterating over all rows of the joined DataFrames:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># quantity extracted is limited</span>
<span class="n">mm</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ore</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="o">.</span><span class="n">max_extract</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">work</span>
                  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_mines</span><span class="o">.</span><span class="n">max_extract</span><span class="p">)</span><span class="o">.</span><span class="n">itertuples</span><span class="p">())</span>
<span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">60</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">20</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">61</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
</pre></div>
</div>
</div>
<div class="section" id="blend-constraints">
<h5>Blend constraints<a class="headerlink" href="#blend-constraints" title="Permalink to this headline">&para;</a></h5>
<p>We need to compute the total production of each year, stored in
auxiliary variables.</p>
<p>Again, we use the <em>pandas</em> <em>groupby</em> operation, this time to collect all
<em>&#8220;ore&#8221;</em> decision variables for each <strong>year</strong> in separate <em>pandas</em>
Series. The <em>&#8220;blend&#8221;</em> variable for a given year is the sum of <em>&#8220;ore&#8221;</em>
decision variables for the corresponding Series.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># blend variables</span>
<span class="n">blend_vars</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">continuous_var_list</span><span class="p">(</span><span class="n">nb_years</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;blend&#39;</span><span class="p">)</span>

<span class="c1"># define blend variables as sum of extracted quantities</span>
<span class="n">mm</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ores</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="n">blend_vars</span><span class="p">[</span><span class="n">year</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">ores</span> <span class="ow">in</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">ore</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;range_years&#39;</span><span class="p">))</span>
<span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">65</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">25</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">66</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
</pre></div>
</div>
</div>
<div class="section" id="minimum-average-blend-quality-constraint">
<h5>Minimum average blend quality constraint<a class="headerlink" href="#minimum-average-blend-quality-constraint" title="Permalink to this headline">&para;</a></h5>
<p>The average quality of the blend is the weighted sum of extracted
quantities, divided by the total extracted quantity. Because we cannot
use division here, we transform the inequality:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Quality requirement on blended ore</span>
<span class="n">mm</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ores</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">df_mines</span><span class="o">.</span><span class="n">ore_quality</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">blend_qualities</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">*</span> <span class="n">blend_vars</span><span class="p">[</span><span class="n">year</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">ores</span> <span class="ow">in</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">ore</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;range_years&#39;</span><span class="p">))</span>
<span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">65</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">25</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">71</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="kpis-and-objective">
<h4>KPIs and objective<a class="headerlink" href="#kpis-and-objective" title="Permalink to this headline">&para;</a></h4>
<p>Since both revenues and royalties are actualized using the same rate, we
compute an auxiliary discount rate array.</p>
<div class="section" id="the-discount-rate-array">
<h5>The discount rate array<a class="headerlink" href="#the-discount-rate-array" title="Permalink to this headline">&para;</a></h5>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">actualization</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">discount_rate</span>
<span class="k">assert</span> <span class="n">actualization</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">actualization</span> <span class="o">&lt;=</span> <span class="mi">1</span>
<span class="c1">#</span>
<span class="n">s_discounts</span> <span class="o">=</span> <span class="n">Series</span><span class="p">((</span><span class="n">actualization</span> <span class="o">**</span> <span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">range_years</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">range_years</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;discounts&#39;</span><span class="p">)</span>
<span class="n">s_discounts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;range_years&#39;</span>
<span class="c1"># e.g. [1, 0.9, 0.81, ... 0.9**y...]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s_discounts</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">range_years</span>
<span class="mi">0</span>    <span class="mf">1.0000</span>
<span class="mi">1</span>    <span class="mf">0.9000</span>
<span class="mi">2</span>    <span class="mf">0.8100</span>
<span class="mi">3</span>    <span class="mf">0.7290</span>
<span class="mi">4</span>    <span class="mf">0.6561</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">discounts</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h5>Total actualized revenue<a class="headerlink" href="#id1" title="Permalink to this headline">&para;</a></h5>
<p>Total expected revenue is the sum of actualized yearly revenues,
computed as total extracted quantities multiplied by the blend price
(assumed to be constant over the years in this simplified model).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">expected_revenue</span> <span class="o">=</span> <span class="n">blend_price</span> <span class="o">*</span> <span class="n">mm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">blend_vars</span><span class="p">,</span> <span class="n">s_discounts</span><span class="p">)</span>
<span class="n">mm</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">expected_revenue</span><span class="p">,</span> <span class="s2">&quot;Total Actualized Revenue&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DecisionKPI</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">Total</span> <span class="n">Actualized</span> <span class="n">Revenue</span><span class="p">,</span><span class="n">expr</span><span class="o">=</span><span class="mi">10</span><span class="n">blend_0</span><span class="o">+</span><span class="mi">9</span><span class="n">blend_1</span><span class="o">+</span><span class="mf">7.290</span><span class="n">blend_3</span><span class="o">+</span><span class="mf">8.100</span><span class="n">blend_2</span><span class="o">+</span><span class="mf">6.561</span><span class="n">blend_4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="total-actualized-royalty-cost">
<h5>Total actualized royalty cost<a class="headerlink" href="#total-actualized-royalty-cost" title="Permalink to this headline">&para;</a></h5>
<p>The total actualized royalty cost is computed for all open mines, also
actualized using the discounts array.</p>
<p>This time, we use the <em>pandas</em> <em>join</em> operation twice to build a
DataFrame that joins the <em>&#8220;df_decision_vars&#8221;</em> DataFrame with the
<em>&#8220;df_mines.royalties&#8221;</em> and <em>&#8220;s_discounts&#8221;</em> Series such that each row
contains the relevant information to calculate its contribution to the
total actualized royalty cost. The join with the <em>&#8220;df_mines.royalties&#8221;</em>
Series is performed by looking at the common <em>&#8220;range_mines&#8221;</em> index,
while the join with the <em>&#8220;s_discounts&#8221;</em> Series is performed by looking
at the common <em>&#8220;range_years&#8221;</em> index.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df_royalties_data</span> <span class="o">=</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_mines</span><span class="o">.</span><span class="n">royalties</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s_discounts</span><span class="p">)</span>
<span class="n">df_royalties_data</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>open</th>
      <th>ore</th>
      <th>work</th>
      <th>royalties</th>
      <th>discounts</th>
    </tr>
    <tr>
      <th>range_mines</th>
      <th>range_years</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>open_0_0</td>
      <td>ore_0_0</td>
      <td>work_0_0</td>
      <td>5</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_0_1</td>
      <td>ore_0_1</td>
      <td>work_0_1</td>
      <td>5</td>
      <td>0.9000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_0_2</td>
      <td>ore_0_2</td>
      <td>work_0_2</td>
      <td>5</td>
      <td>0.8100</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_0_3</td>
      <td>ore_0_3</td>
      <td>work_0_3</td>
      <td>5</td>
      <td>0.7290</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_0_4</td>
      <td>ore_0_4</td>
      <td>work_0_4</td>
      <td>5</td>
      <td>0.6561</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th>0</th>
      <td>open_1_0</td>
      <td>ore_1_0</td>
      <td>work_1_0</td>
      <td>4</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_1_1</td>
      <td>ore_1_1</td>
      <td>work_1_1</td>
      <td>4</td>
      <td>0.9000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_1_2</td>
      <td>ore_1_2</td>
      <td>work_1_2</td>
      <td>4</td>
      <td>0.8100</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_1_3</td>
      <td>ore_1_3</td>
      <td>work_1_3</td>
      <td>4</td>
      <td>0.7290</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_1_4</td>
      <td>ore_1_4</td>
      <td>work_1_4</td>
      <td>4</td>
      <td>0.6561</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">2</th>
      <th>0</th>
      <td>open_2_0</td>
      <td>ore_2_0</td>
      <td>work_2_0</td>
      <td>4</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_2_1</td>
      <td>ore_2_1</td>
      <td>work_2_1</td>
      <td>4</td>
      <td>0.9000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_2_2</td>
      <td>ore_2_2</td>
      <td>work_2_2</td>
      <td>4</td>
      <td>0.8100</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_2_3</td>
      <td>ore_2_3</td>
      <td>work_2_3</td>
      <td>4</td>
      <td>0.7290</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_2_4</td>
      <td>ore_2_4</td>
      <td>work_2_4</td>
      <td>4</td>
      <td>0.6561</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">3</th>
      <th>0</th>
      <td>open_3_0</td>
      <td>ore_3_0</td>
      <td>work_3_0</td>
      <td>5</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>open_3_1</td>
      <td>ore_3_1</td>
      <td>work_3_1</td>
      <td>5</td>
      <td>0.9000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>open_3_2</td>
      <td>ore_3_2</td>
      <td>work_3_2</td>
      <td>5</td>
      <td>0.8100</td>
    </tr>
    <tr>
      <th>3</th>
      <td>open_3_3</td>
      <td>ore_3_3</td>
      <td>work_3_3</td>
      <td>5</td>
      <td>0.7290</td>
    </tr>
    <tr>
      <th>4</th>
      <td>open_3_4</td>
      <td>ore_3_4</td>
      <td>work_3_4</td>
      <td>5</td>
      <td>0.6561</td>
    </tr>
  </tbody>
</table>
</div><p>The total royalty is now calculated by multiplying the columns <em>&#8220;open&#8221;</em>,
<em>&#8220;royalties&#8221;</em> and <em>&#8220;discounts&#8221;</em>, and to sum over all rows. Using
<em>pandas</em> constructs, this can be written in a very compact way as
follows:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">total_royalties</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">df_royalties_data</span><span class="o">.</span><span class="n">open</span> <span class="o">*</span> <span class="n">df_royalties_data</span><span class="o">.</span><span class="n">royalties</span> <span class="o">*</span> <span class="n">df_royalties_data</span><span class="o">.</span><span class="n">discounts</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">mm</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_royalties</span><span class="p">,</span> <span class="s2">&quot;Total Actualized Royalties&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DecisionKPI</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">Total</span> <span class="n">Actualized</span> <span class="n">Royalties</span><span class="p">,</span><span class="n">expr</span><span class="o">=</span><span class="mf">4.050</span><span class="n">open_0_2</span><span class="o">+</span><span class="mf">3.600</span><span class="n">open_1_1</span><span class="o">+</span><span class="mf">2.916</span><span class="n">open_1_3</span><span class="o">+</span><span class="mf">2.916</span><span class="n">open_2_3</span><span class="o">+</span><span class="mi">4</span><span class="n">open_1_0</span><span class="o">+</span><span class="mi">5</span><span class="n">open_0_0</span><span class="o">+</span><span class="mi">4</span><span class="n">open_2_0</span><span class="o">+</span><span class="mf">3.240</span><span class="n">open_2_2</span><span class="o">+</span><span class="mi">5</span><span class="n">open_3_0</span><span class="o">+</span><span class="mf">3.240</span><span class="n">open_1_2</span><span class="o">+</span><span class="mf">3.280</span><span class="n">open_0_4</span><span class="o">+</span><span class="mf">4.500</span><span class="n">open_0_1</span><span class="o">+</span><span class="mf">4.050</span><span class="n">open_3_2</span><span class="o">+</span><span class="mf">2.624</span><span class="n">open_1_4</span><span class="o">+</span><span class="mf">3.645</span><span class="n">open_3_3</span><span class="o">+</span><span class="mf">3.645</span><span class="n">open_0_3</span><span class="o">+</span><span class="mf">2.624</span><span class="n">open_2_4</span><span class="o">+</span><span class="mf">3.280</span><span class="n">open_3_4</span><span class="o">+</span><span class="mf">3.600</span><span class="n">open_2_1</span><span class="o">+</span><span class="mf">4.500</span><span class="n">open_3_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="express-the-objective">
<h4>Express the objective<a class="headerlink" href="#express-the-objective" title="Permalink to this headline">&para;</a></h4>
<p>The business objective is to maximize the expected net profit, which is
the difference between revenue and royalties.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mm</span><span class="o">.</span><span class="n">maximize</span><span class="p">(</span><span class="n">expected_revenue</span> <span class="o">-</span> <span class="n">total_royalties</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="solve-with-the-decision-optimization-solve-service">
<h4>Solve with the Decision Optimization solve service<a class="headerlink" href="#solve-with-the-decision-optimization-solve-service" title="Permalink to this headline">&para;</a></h4>
<p>Solve the model on the cloud.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>

<span class="k">assert</span> <span class="n">mm</span><span class="o">.</span><span class="n">solve</span><span class="p">(),</span> <span class="s2">&quot;!!! Solve of the model fails&quot;</span>
<span class="n">mm</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">65</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">25</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">71</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
<span class="o">*</span> <span class="n">model</span> <span class="n">solved</span> <span class="k">with</span> <span class="n">objective</span><span class="p">:</span> <span class="mf">161.438</span>
<span class="o">*</span> <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">Actualized</span> <span class="n">Revenue</span><span class="o">=</span><span class="mf">214.674</span>
<span class="o">*</span> <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">Actualized</span> <span class="n">Royalties</span><span class="o">=</span><span class="mf">53.236</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-5-investigate-the-solution-and-then-run-an-example-analysis">
<h3>Step 5: Investigate the solution and then run an example analysis<a class="headerlink" href="#step-5-investigate-the-solution-and-then-run-an-example-analysis" title="Permalink to this headline">&para;</a></h3>
<p>To analyze the results, we again leverage pandas, by storing the
solution value of the <em>ore</em> variables in a new DataFrame. Note that we
use the <em>float</em> function of Python to convert the variable to its
solution value. Of course, this requires that the model be successfully
solved. For convenience, we want to organize the <em>ore</em> solution values
in a pivot table with <em>years</em> as row index and <em>mines</em> as columns. The
<em>pandas</em> <em>unstack</em> operation does this for us.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mine_labels</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;mine</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">range_mines</span><span class="p">]</span>
<span class="n">ylabels</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;y</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">range_years</span><span class="p">]</span>
<span class="c1"># Add a column to DataFrame containing &#39;ore&#39; decision variables value and create a pivot table by (years, mines)</span>
<span class="n">df_decision_vars</span><span class="p">[</span><span class="s1">&#39;ore_values&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">ore</span><span class="p">)</span>

<span class="c1"># Create a pivot table by (years, mines), using pandas&#39; &quot;unstack&quot; method to transform the &#39;range_mines&#39; row index</span>
<span class="c1">#  into columns</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">ore_values</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;range_mines&#39;</span><span class="p">)</span>

<span class="c1"># Set user-friendly labels for column and row indices</span>
<span class="n">df_res</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">mine_labels</span>
<span class="n">df_res</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ylabels</span>

<span class="n">df_res</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mine1</th>
      <th>mine2</th>
      <th>mine3</th>
      <th>mine4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>y1</th>
      <td>2.00</td>
      <td>2.500000</td>
      <td>1.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>y2</th>
      <td>2.00</td>
      <td>2.500000</td>
      <td>1.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>y3</th>
      <td>1.95</td>
      <td>0.000000</td>
      <td>1.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>y4</th>
      <td>2.00</td>
      <td>2.500000</td>
      <td>1.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>y5</th>
      <td>2.00</td>
      <td>2.166667</td>
      <td>1.3</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">df_res</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">4.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ore&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span> <span class="n">at</span> <span class="mh">0xac53240</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="_images/mining_pandas_61_1.png" src="_images/mining_pandas_61_1.png" />
</div>
</div>
<div class="section" id="adding-operational-constraints">
<h2>Adding operational constraints.<a class="headerlink" href="#adding-operational-constraints" title="Permalink to this headline">&para;</a></h2>
<p>What if we wish to add operational constraints? For example, let us
forbid work on certain pairs of (mines, years). Let&#8217;s see how this
impacts the profit.</p>
<p>First, we add extra constraints to forbid work on those tuples.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># a list of (mine, year) tuples on which work is not possible.</span>
<span class="n">forced_stops</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>

<span class="n">mm</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">work_vars</span><span class="p">[</span><span class="n">stop_m</span><span class="p">,</span> <span class="n">stop_y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                 <span class="k">for</span> <span class="n">stop_m</span><span class="p">,</span> <span class="n">stop_y</span> <span class="ow">in</span> <span class="n">forced_stops</span><span class="p">)</span>
<span class="n">mm</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">mining_pandas</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">65</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">25</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">77</span>
 <span class="o">-</span>   <span class="n">LE</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">EQ</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">GE</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">RNG</span><span class="o">=</span><span class="mi">0</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
</pre></div>
</div>
<p>The previous solution does not satisfy these constraints; for example
(0, 1) means mine 1 should not be worked on year 2, but it was in fact
worked in the above solution. To help CPLEX find a feasible solution, we
will build a heuristic feasible solution and pass it to CPLEX.</p>
</div>
<div class="section" id="using-an-heuristic-start-solution">
<h2>Using an heuristic start solution<a class="headerlink" href="#using-an-heuristic-start-solution" title="Permalink to this headline">&para;</a></h2>
<p>In this section, we show how one can provide a start solution to CPLEX,
based on heuristics.</p>
<p>First, we build a solution in which mines are worked whenever possible,
that is for all couples <em>(m,y)</em> except for those in <em>forced_stops</em>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.solution</span> <span class="k">import</span> <span class="n">SolveSolution</span>

<span class="n">full_mining</span> <span class="o">=</span> <span class="n">SolveSolution</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">range_mines</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">range_years</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">forced_stops</span><span class="p">:</span>
            <span class="n">full_mining</span><span class="o">.</span><span class="n">add_var_value</span><span class="p">(</span><span class="n">work_vars</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1">#full_mining.display()</span>
</pre></div>
</div>
<p>Then we pass this solution to the model as a MIP start solution and
re-solve, this time with CPLEX logging turned on.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mm</span><span class="o">.</span><span class="n">add_mip_start</span><span class="p">(</span><span class="n">full_mining</span><span class="p">)</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">log_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># turns on CPLEX logging</span>
<span class="k">assert</span> <span class="n">s3</span><span class="p">,</span> <span class="s2">&quot;solve failed&quot;</span>
<span class="n">mm</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2</span> <span class="n">of</span> <span class="mi">5</span> <span class="n">MIP</span> <span class="n">starts</span> <span class="n">provided</span> <span class="n">solutions</span><span class="o">.</span>
<span class="n">MIP</span> <span class="n">start</span> <span class="s1">&#39;m5&#39;</span> <span class="n">defined</span> <span class="n">initial</span> <span class="n">solution</span> <span class="k">with</span> <span class="n">objective</span> <span class="mf">157.9355</span><span class="o">.</span>
<span class="n">Tried</span> <span class="n">aggregator</span> <span class="mi">5</span> <span class="n">times</span><span class="o">.</span>
<span class="n">MIP</span> <span class="n">Presolve</span> <span class="n">eliminated</span> <span class="mi">41</span> <span class="n">rows</span> <span class="ow">and</span> <span class="mi">29</span> <span class="n">columns</span><span class="o">.</span>
<span class="n">MIP</span> <span class="n">Presolve</span> <span class="n">modified</span> <span class="mi">29</span> <span class="n">coefficients</span><span class="o">.</span>
<span class="n">Aggregator</span> <span class="n">did</span> <span class="mi">36</span> <span class="n">substitutions</span><span class="o">.</span>
<span class="n">All</span> <span class="n">rows</span> <span class="ow">and</span> <span class="n">columns</span> <span class="n">eliminated</span><span class="o">.</span>
<span class="n">Presolve</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.17</span> <span class="n">ticks</span><span class="p">)</span>

<span class="n">Root</span> <span class="n">node</span> <span class="n">processing</span> <span class="p">(</span><span class="n">before</span> <span class="n">b</span><span class="o">&amp;</span><span class="n">c</span><span class="p">):</span>
  <span class="n">Real</span> <span class="n">time</span>             <span class="o">=</span>    <span class="mf">0.02</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.33</span> <span class="n">ticks</span><span class="p">)</span>
<span class="n">Parallel</span> <span class="n">b</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">8</span> <span class="n">threads</span><span class="p">:</span>
  <span class="n">Real</span> <span class="n">time</span>             <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">ticks</span><span class="p">)</span>
  <span class="n">Sync</span> <span class="n">time</span> <span class="p">(</span><span class="n">average</span><span class="p">)</span>   <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span>
  <span class="n">Wait</span> <span class="n">time</span> <span class="p">(</span><span class="n">average</span><span class="p">)</span>   <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span>
                          <span class="o">------------</span>
<span class="n">Total</span> <span class="p">(</span><span class="n">root</span><span class="o">+</span><span class="n">branch</span><span class="o">&amp;</span><span class="n">cut</span><span class="p">)</span> <span class="o">=</span>    <span class="mf">0.02</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.33</span> <span class="n">ticks</span><span class="p">)</span>
<span class="o">*</span> <span class="n">model</span> <span class="n">solved</span> <span class="k">with</span> <span class="n">objective</span><span class="p">:</span> <span class="mf">157.936</span>
<span class="o">*</span> <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">Actualized</span> <span class="n">Revenue</span><span class="o">=</span><span class="mf">228.367</span>
<span class="o">*</span> <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">Actualized</span> <span class="n">Royalties</span><span class="o">=</span><span class="mf">70.431</span>
</pre></div>
</div>
<p>You can see in the CPLEX log above, that our MIP start solution provided
a good start for CPLEX, defining an initial solution with objective
157.9355</p>
<p>Now we can again visualize the results with <em>pandas</em> and <em>matplotlib</em>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Add a column to DataFrame containing &#39;ore&#39; decision variables value and create a pivot table by (years, mines)</span>
<span class="n">df_decision_vars</span><span class="p">[</span><span class="s1">&#39;ore_values2&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">ore</span><span class="p">)</span>
<span class="n">df_res2</span> <span class="o">=</span> <span class="n">df_decision_vars</span><span class="o">.</span><span class="n">ore_values2</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;range_mines&#39;</span><span class="p">)</span>
<span class="n">df_res2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">mine_labels</span>
<span class="n">df_res2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ylabels</span>

<span class="n">df_res2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">4.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ore&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span> <span class="n">at</span> <span class="mh">0xca93128</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="_images/mining_pandas_70_1.png" src="_images/mining_pandas_70_1.png" />
<p>As expected, mine1 is not worked in year 2: there is no blue bar at y2.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">&para;</a></h2>
<p>You learned how to set up and use IBM Decision Optimization CPLEX
Modeling for Python to formulate a Mathematical Programming model and
solve it with CPLEX.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">&para;</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://rawgit.com/IBMDecisionOptimization/docplex-doc/master/docs/index.html">CPLEX Modeling for Python
documentation</a></li>
<li><a class="reference external" href="https://developer.ibm.com/docloud/">Decision Optimization on
Cloud</a></li>
<li>Need help with DOcplex or to report a bug? Please go
<a class="reference external" href="https://developer.ibm.com/answers/smartspace/docloud">here</a>.</li>
<li>Contact us at <a class="reference external" href="mailto:dofeedback&#37;&#52;&#48;wwpdl&#46;vnet&#46;ibm&#46;com">dofeedback<span>&#64;</span>wwpdl<span>&#46;</span>vnet<span>&#46;</span>ibm<span>&#46;</span>com</a>.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="nurses_pandas.html" title="The Nurse Assignment Problem"
             >next</a> |</li>
        <li class="right" >
          <a href="marketing_campaign.html" title="How to make targeted offers to customers?"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="samples.html" >Examples of mathematical programming</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2018, IBM&reg;.
    </div>
  </body>
</html>