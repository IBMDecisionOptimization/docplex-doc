<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    
    <title>The Nurse Assignment Problem &mdash; DOcplex.MP: Mathematical Programming Modeling for Python V2.0 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     'V2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="DOcplex.MP: Mathematical Programming Modeling for Python V2.0 documentation" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-nurse-assignment-problem">
<h1>The Nurse Assignment Problem<a class="headerlink" href="#the-nurse-assignment-problem" title="Permalink to this headline">&para;</a></h1>
<p>This tutorial includes everything you need to set up IBM Decision
Optimization CPLEX Modeling for Python (DOcplex), build a Mathematical
Programming model, and get its solution by solving the model on the
cloud with IBM ILOG CPLEX Optimizer.</p>
<p>When you finish this tutorial, you&#8217;ll have a foundational knowledge of
<em>Prescriptive Analytics</em>.</p>
<blockquote>
<div><p>This notebook is part of <a class="reference external" href="https://rawgit.com/IBMDecisionOptimization/docplex-doc/master/docs/index.html">Prescriptive Analytics for
Python</a>.</p>
<p>It requires a valid subscription to <strong>Decision Optimization on
Cloud</strong>. Try it for free
<a class="reference external" href="https://developer.ibm.com/docloud">here</a>.</p>
</div></blockquote>
<p>Table of contents:</p>
<ul class="simple">
<li><a class="reference internal" href="#describe-the-business-problem">Describe the business problem</a></li>
<li><a class="reference internal" href="#how-decision-optimization-can-help">How  decision optimization can help</a></li>
<li><a class="reference internal" href="#use-decision-optimization">Use decision optimization</a><ul>
<li><a class="reference internal" href="#step-1-download-the-library">Step 1: Download the library</a></li>
<li><a class="reference internal" href="#step-2-set-up-the-prescriptive-engine">Step 2: Set up the prescriptive engine</a></li>
<li><a class="reference internal" href="#step-3-model-the-data">Step 3: Model the data</a></li>
<li><a class="reference internal" href="#step-4-prepare-the-data">Step 4: Prepare the data</a></li>
<li><a class="reference internal" href="#step-5-set-up-the-prescriptive-model">Step 5: Set up the prescriptive model</a><ul>
<li><a class="reference internal" href="#define-the-decision-variables">Define the decision variables</a></li>
<li><a class="reference internal" href="#express-the-business-constraints">Express the business constraints</a></li>
<li><a class="reference internal" href="#express-the-objective">Express the objective</a></li>
<li><a class="reference internal" href="#solve-with-the-decision-optimization-solve-service">Solve with the Decision Optimization solve service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-6-investigate-the-solution-and-then-run-an-example-analysis">Step 6: Investigate the solution and then run an example analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
<hr class="docutils" />
<div class="section" id="describe-the-business-problem">
<h2>Describe the business problem<a class="headerlink" href="#describe-the-business-problem" title="Permalink to this headline">&para;</a></h2>
<p>This notebook describes how to use CPLEX Modeling for Python together
with <em>pandas</em> to manage the assignment of nurses to shifts in a
hospital.</p>
<p>Nurses must be assigned to hospital shifts in accordance with various
skill and staffing constraints.</p>
<p>The goal of the model is to find an efficient balance between the
different objectives:</p>
<ul class="simple">
<li>minimize the overall cost of the plan and</li>
<li>assign shifts as fairly as possible.</li>
</ul>
</div>
<div class="section" id="how-decision-optimization-can-help">
<h2>How decision optimization can help<a class="headerlink" href="#how-decision-optimization-can-help" title="Permalink to this headline">&para;</a></h2>
<ul>
<li><p class="first">Prescriptive analytics (decision optimization) technology recommends
actions that are based on desired outcomes. It takes into account
specific scenarios, resources, and knowledge of past and current
events. With this insight, your organization can make better
decisions and have greater control of business outcomes.</p>
</li>
<li><p class="first">Prescriptive analytics is the next step on the path to insight-based
actions. It creates value through synergy with predictive analytics,
which analyzes data to predict future outcomes.</p>
</li>
<li><div class="first line-block">
<div class="line">Prescriptive analytics takes that insight to the next level by
suggesting the optimal way to handle that future situation.
Organizations that can act fast in dynamic conditions and make
superior decisions in uncertain environments gain a strong
competitive advantage.</div>
<div class="line"><br /></div>
</div>
</li>
</ul>
<p>With prescriptive analytics, you can:</p>
<ul class="simple">
<li>Automate the complex decisions and trade-offs to better manage your
limited resources.</li>
<li>Take advantage of a future opportunity or mitigate a future risk.</li>
<li>Proactively update recommendations based on changing events.</li>
<li>Meet operational goals, increase customer loyalty, prevent threats
and fraud, and optimize business processes.</li>
</ul>
</div>
<div class="section" id="checking-minimum-requirements">
<h2>Checking minimum requirements<a class="headerlink" href="#checking-minimum-requirements" title="Permalink to this headline">&para;</a></h2>
<p>This notebook uses some features of pandas that are available in version
0.17.1 or above.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pip</span>
<span class="n">REQUIRED_MINIMUM_PANDAS_VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.17.1&#39;</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">key</span> <span class="p">:</span> <span class="n">pkg</span><span class="o">.</span><span class="n">version</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">pip</span><span class="o">.</span><span class="n">get_installed_distributions</span><span class="p">()}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pandas&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">REQUIRED_MINIMUM_PANDAS_VERSION</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Version &quot;</span> <span class="o">+</span> <span class="n">REQUIRED_MINIMUM_PANDAS_VERSION</span> <span class="o">+</span> <span class="s2">&quot; or above of Pandas is required to run this notebook&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="use-decision-optimization">
<h2>Use decision optimization<a class="headerlink" href="#use-decision-optimization" title="Permalink to this headline">&para;</a></h2>
<div class="section" id="step-1-download-the-library">
<h3>Step 1: Download the library<a class="headerlink" href="#step-1-download-the-library" title="Permalink to this headline">&para;</a></h3>
<p>Run the following code to install the Decision Optimization CPLEX
Modeling library. The <em>DOcplex</em> library contains the two modeling
packages, Mathematical Programming (docplex.mp) and Constraint
Programming (docplex.cp).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span>import sys
try:
    import docplex.mp
except:
    if hasattr(sys, &#39;real_prefix&#39;):
        #we are in a virtual env.
        !pip install docplex
    else:
        !pip install --user docplex
</pre></div>
</div>
</div>
<div class="section" id="step-2-set-up-the-prescriptive-engine">
<h3>Step 2: Set up the prescriptive engine<a class="headerlink" href="#step-2-set-up-the-prescriptive-engine" title="Permalink to this headline">&para;</a></h3>
<ul class="simple">
<li>Subscribe to the <a class="reference external" href="https://developer.ibm.com/docloud">Decision Optimization on Cloud solve
service</a>.</li>
<li>Get the service URL and your personal API key and enter your
credentials here:</li>
</ul>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;ENTER YOUR URL HERE&quot;</span>
<span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;ENTER YOUR KEY HERE&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-model-the-data">
<h3>Step 3: Model the data<a class="headerlink" href="#step-3-model-the-data" title="Permalink to this headline">&para;</a></h3>
<p>The input data consists of several tables:</p>
<ul class="simple">
<li>The Departments table lists all departments in the scope of the
assignment.</li>
<li>The Skills table list all skills.</li>
<li>The Shifts table lists all shifts to be staffed. A shift contains a
department, a day in the week, plus the start and end times.</li>
<li>The Nurses table lists all nurses, identified by their names.</li>
<li>The NurseSkills table gives the skills of each nurse.</li>
<li>The SkillRequirements table lists the minimum number of persons
required for a given department and skill.</li>
<li>The NurseVacations table lists days off for each nurse.</li>
<li>The NurseAssociations table lists pairs of nurses who wish to work
together.</li>
<li>The NurseIncompatibilities table lists pairs of nurses who do not
want to work together.</li>
</ul>
<div class="section" id="loading-data-from-excel-with-pandas">
<h4>Loading data from Excel with pandas<a class="headerlink" href="#loading-data-from-excel-with-pandas" title="Permalink to this headline">&para;</a></h4>
<p>We load the data from an Excel file using <em>pandas</em>. Each sheet is read
into a separate <em>pandas</em> DataFrame.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span># This notebook requires pandas to work
import pandas as pd
from pandas import DataFrame

# Make sure that xlrd package, which is a pandas optional dependency, is installed
# This package is required for Excel I/O
try:
    import xlrd
except:
    if hasattr(sys, &#39;real_prefix&#39;):
        #we are in a virtual env.
        !pip install xlrd
    else:
        !pip install --user xlrd

# Use pandas to read the file, one tab for each table.
nurse_xls_file = pd.ExcelFile(&#39;nurses_data.xls&#39;)
df_skills = nurse_xls_file.parse(&#39;Skills&#39;)
df_depts  = nurse_xls_file.parse(&#39;Departments&#39;)
df_shifts = nurse_xls_file.parse(&#39;Shifts&#39;)
# Rename df_shifts index
df_shifts.index.name = &#39;shiftId&#39;

# Index is column 0: name
df_nurses = nurse_xls_file.parse(&#39;Nurses&#39;, header=0, index_col=0)
df_nurse_skilles = nurse_xls_file.parse(&#39;NurseSkills&#39;)
df_vacations = nurse_xls_file.parse(&#39;NurseVacations&#39;)
df_associations = nurse_xls_file.parse(&#39;NurseAssociations&#39;)
df_incompatibilities = nurse_xls_file.parse(&#39;NurseIncompatibilities&#39;)

# Display the nurses dataframe
print(&quot;#nurses = {}&quot;.format(len(df_nurses)))
print(&quot;#shifts = {}&quot;.format(len(df_shifts)))
print(&quot;#vacations = {}&quot;.format(len(df_vacations)))
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#nurses = 32</span>
<span class="c1">#shifts = 41</span>
<span class="c1">#vacations = 59</span>
</pre></div>
</div>
<p>In addition, we introduce some extra global data:</p>
<ul class="simple">
<li>The maximum work time for each nurse.</li>
<li>The maximum and minimum number of shifts worked by a nurse in a week.</li>
</ul>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># maximum work time (in hours)</span>
<span class="n">max_work_time</span> <span class="o">=</span> <span class="mi">40</span>

<span class="c1"># maximum number of shifts worked in a week.</span>
<span class="n">max_nb_shifts</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Shifts are stored in a separate DataFrame.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">df_shifts</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>department</th>
      <th>day</th>
      <th>start_time</th>
      <th>end_time</th>
      <th>min_req</th>
      <th>max_req</th>
    </tr>
    <tr>
      <th>shiftId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Consultation</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Consultation</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Cardiac Care</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Cardiac Care</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Consultation</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Consultation</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Consultation</td>
      <td>Wednesday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Consultation</td>
      <td>Wednesday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Consultation</td>
      <td>Thursday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Consultation</td>
      <td>Thursday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>32</th>
      <td>Consultation</td>
      <td>Friday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Consultation</td>
      <td>Friday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>2</td>
      <td>12</td>
      <td>5</td>
      <td>7</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>12</td>
      <td>20</td>
      <td>7</td>
      <td>9</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>20</td>
      <td>2</td>
      <td>12</td>
      <td>12</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>2</td>
      <td>12</td>
      <td>5</td>
      <td>7</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>12</td>
      <td>20</td>
      <td>7</td>
      <td>9</td>
    </tr>
    <tr>
      <th>39</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>20</td>
      <td>2</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Geriatrics</td>
      <td>Sunday</td>
      <td>8</td>
      <td>10</td>
      <td>2</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="step-4-prepare-the-data">
<h3>Step 4: Prepare the data<a class="headerlink" href="#step-4-prepare-the-data" title="Permalink to this headline">&para;</a></h3>
<p>We need to precompute additional data for shifts. For each shift, we
need the start time and end time expressed in hours, counting from the
beginning of the week: Monday 8am is converted to 8, Tuesday 8am is
converted to 24+8 = 32, and so on.</p>
<div class="section" id="sub-step-1">
<h4>Sub-step #1<a class="headerlink" href="#sub-step-1" title="Permalink to this headline">&para;</a></h4>
<p>We start by adding an extra column <code class="docutils literal"><span class="pre">dow</span></code> (day of week) which converts
the string &#8220;day&#8221; into an integer in 0..6 (Monday is 0, Sunday is 6).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;monday&quot;</span><span class="p">,</span> <span class="s2">&quot;tuesday&quot;</span><span class="p">,</span> <span class="s2">&quot;wednesday&quot;</span><span class="p">,</span> <span class="s2">&quot;thursday&quot;</span><span class="p">,</span> <span class="s2">&quot;friday&quot;</span><span class="p">,</span> <span class="s2">&quot;saturday&quot;</span><span class="p">,</span> <span class="s2">&quot;sunday&quot;</span><span class="p">]</span>
<span class="n">day_of_weeks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>

<span class="c1"># utility to convert a day string e.g. &quot;Monday&quot; to an integer in 0..6</span>
<span class="k">def</span> <span class="nf">day_to_day_of_week</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">day_of_weeks</span><span class="p">[</span><span class="n">day</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="c1"># for each day name, we normalize it by stripping whitespace and converting it to lowercase</span>
<span class="c1"># &quot; Monday&quot; -&gt; &quot;monday&quot;</span>
<span class="n">df_shifts</span><span class="p">[</span><span class="s2">&quot;dow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">day_to_day_of_week</span><span class="p">)</span>
<span class="n">df_shifts</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>department</th>
      <th>day</th>
      <th>start_time</th>
      <th>end_time</th>
      <th>min_req</th>
      <th>max_req</th>
      <th>dow</th>
    </tr>
    <tr>
      <th>shiftId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Consultation</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Consultation</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Cardiac Care</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Cardiac Care</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Consultation</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>1</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Consultation</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>1</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>2</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>2</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Consultation</td>
      <td>Wednesday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>2</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Consultation</td>
      <td>Wednesday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>2</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>3</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>3</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Consultation</td>
      <td>Thursday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>3</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Consultation</td>
      <td>Thursday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>3</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>4</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>4</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>4</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>4</td>
    </tr>
    <tr>
      <th>32</th>
      <td>Consultation</td>
      <td>Friday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>4</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Consultation</td>
      <td>Friday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>2</td>
      <td>12</td>
      <td>5</td>
      <td>7</td>
      <td>5</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>12</td>
      <td>20</td>
      <td>7</td>
      <td>9</td>
      <td>5</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>20</td>
      <td>2</td>
      <td>12</td>
      <td>12</td>
      <td>5</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>2</td>
      <td>12</td>
      <td>5</td>
      <td>7</td>
      <td>6</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>12</td>
      <td>20</td>
      <td>7</td>
      <td>9</td>
      <td>6</td>
    </tr>
    <tr>
      <th>39</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>20</td>
      <td>2</td>
      <td>8</td>
      <td>12</td>
      <td>6</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Geriatrics</td>
      <td>Sunday</td>
      <td>8</td>
      <td>10</td>
      <td>2</td>
      <td>5</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="sub-step-2-compute-the-absolute-start-time-of-each-shift">
<h4>Sub-step #2 : Compute the absolute start time of each shift.<a class="headerlink" href="#sub-step-2-compute-the-absolute-start-time-of-each-shift" title="Permalink to this headline">&para;</a></h4>
<p>Computing the start time in the week is easy: just add <code class="docutils literal"><span class="pre">24*dow</span></code> to
column <code class="docutils literal"><span class="pre">start_time</span></code>. The result is stored in a new column <code class="docutils literal"><span class="pre">wstart</span></code>.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">df_shifts</span><span class="p">[</span><span class="s2">&quot;wstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">dow</span>
</pre></div>
</div>
</div>
<div class="section" id="sub-step-3-compute-the-absolute-end-time-of-each-shift">
<h4>Sub-Step #3 : Compute the absolute end time of each shift.<a class="headerlink" href="#sub-step-3-compute-the-absolute-end-time-of-each-shift" title="Permalink to this headline">&para;</a></h4>
<p>Computing the absolute end time is a little more complicated as certain
shifts span across midnight. For example, Shift #3 starts on Monday at
18:00 and ends Tuesday at 2:00 AM. The absolute end time of Shift #3 is
26, not 2. The general rule for computing absolute end time is:</p>
<p><code class="docutils literal"><span class="pre">abs_end_time</span> <span class="pre">=</span> <span class="pre">end_time</span> <span class="pre">+</span> <span class="pre">24</span> <span class="pre">*</span> <span class="pre">dow</span> <span class="pre">+</span> <span class="pre">(start_time&gt;=</span> <span class="pre">end_time</span> <span class="pre">?</span> <span class="pre">24</span> <span class="pre">:</span> <span class="pre">0)</span></code></p>
<p>Again, we use <em>pandas</em> to add a new calculated column <code class="docutils literal"><span class="pre">wend</span></code>. This is
done by using the <em>pandas</em> <code class="docutils literal"><span class="pre">apply</span></code> method with an anonymous <code class="docutils literal"><span class="pre">lambda</span></code>
function over rows. The <code class="docutils literal"><span class="pre">raw=True</span></code> parameter prevents the creation of
a <em>pandas</em> Series for each row, which improves the performance
significantly on large data sets.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># an auxiliary function to calculate absolute end time of a shift</span>
<span class="k">def</span> <span class="nf">calculate_absolute_endtime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">dow</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">24</span><span class="o">*</span><span class="n">dow</span> <span class="o">+</span> <span class="n">end</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="k">if</span> <span class="n">start</span><span class="o">&gt;=</span><span class="n">end</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># store the results in a new column</span>
<span class="n">df_shifts</span><span class="p">[</span><span class="s2">&quot;wend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_absolute_endtime</span><span class="p">(</span>
        <span class="n">row</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">dow</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sub-step-4-compute-the-duration-of-each-shift">
<h4>Sub-step #4 : Compute the duration of each shift.<a class="headerlink" href="#sub-step-4-compute-the-duration-of-each-shift" title="Permalink to this headline">&para;</a></h4>
<p>Computing the duration of each shift is now a straightforward difference
of columns. The result is stored in column <code class="docutils literal"><span class="pre">duration</span></code>.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">df_shifts</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">wend</span> <span class="o">-</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">wstart</span>
</pre></div>
</div>
</div>
<div class="section" id="sub-step-5-compute-the-minimum-demand-for-each-shift">
<h4>Sub-step #5 : Compute the minimum demand for each shift.<a class="headerlink" href="#sub-step-5-compute-the-minimum-demand-for-each-shift" title="Permalink to this headline">&para;</a></h4>
<p>Minimum demand is the product of duration (in hours) by the minimum
required number of nurses. Thus, in number of nurse-hours, this demand
is stored in another new column <code class="docutils literal"><span class="pre">min_demand</span></code>.</p>
<p>Finally, we display the updated shifts DataFrame with all calculated
columns.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># also compute minimum demand in nurse-hours</span>
<span class="n">df_shifts</span><span class="p">[</span><span class="s2">&quot;min_demand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">min_req</span> <span class="o">*</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">duration</span>

<span class="c1"># finally check the modified shifts dataframe</span>
<span class="n">df_shifts</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>department</th>
      <th>day</th>
      <th>start_time</th>
      <th>end_time</th>
      <th>min_req</th>
      <th>max_req</th>
      <th>dow</th>
      <th>wstart</th>
      <th>wend</th>
      <th>duration</th>
      <th>min_demand</th>
    </tr>
    <tr>
      <th>shiftId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>0</td>
      <td>2</td>
      <td>8</td>
      <td>6</td>
      <td>18</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>0</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>16</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>0</td>
      <td>12</td>
      <td>18</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Emergency</td>
      <td>Monday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>0</td>
      <td>18</td>
      <td>26</td>
      <td>8</td>
      <td>24</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Consultation</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>0</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>40</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Consultation</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>0</td>
      <td>12</td>
      <td>18</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Cardiac Care</td>
      <td>Monday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>0</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>40</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Cardiac Care</td>
      <td>Monday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>0</td>
      <td>12</td>
      <td>18</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>1</td>
      <td>32</td>
      <td>36</td>
      <td>4</td>
      <td>16</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>1</td>
      <td>36</td>
      <td>42</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Emergency</td>
      <td>Tuesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>1</td>
      <td>42</td>
      <td>50</td>
      <td>8</td>
      <td>24</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Consultation</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>1</td>
      <td>32</td>
      <td>36</td>
      <td>4</td>
      <td>40</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Consultation</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>1</td>
      <td>36</td>
      <td>42</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>1</td>
      <td>32</td>
      <td>36</td>
      <td>4</td>
      <td>16</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>1</td>
      <td>36</td>
      <td>42</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Cardiac Care</td>
      <td>Tuesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>1</td>
      <td>42</td>
      <td>50</td>
      <td>8</td>
      <td>24</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>2</td>
      <td>50</td>
      <td>56</td>
      <td>6</td>
      <td>18</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>2</td>
      <td>56</td>
      <td>60</td>
      <td>4</td>
      <td>16</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>2</td>
      <td>60</td>
      <td>66</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Emergency</td>
      <td>Wednesday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>2</td>
      <td>66</td>
      <td>74</td>
      <td>8</td>
      <td>24</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Consultation</td>
      <td>Wednesday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>2</td>
      <td>56</td>
      <td>60</td>
      <td>4</td>
      <td>40</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Consultation</td>
      <td>Wednesday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>2</td>
      <td>60</td>
      <td>66</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>3</td>
      <td>74</td>
      <td>80</td>
      <td>6</td>
      <td>18</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>3</td>
      <td>80</td>
      <td>84</td>
      <td>4</td>
      <td>16</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>3</td>
      <td>84</td>
      <td>90</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Emergency</td>
      <td>Thursday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>3</td>
      <td>90</td>
      <td>98</td>
      <td>8</td>
      <td>24</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Consultation</td>
      <td>Thursday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>3</td>
      <td>80</td>
      <td>84</td>
      <td>4</td>
      <td>40</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Consultation</td>
      <td>Thursday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>3</td>
      <td>84</td>
      <td>90</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>2</td>
      <td>8</td>
      <td>3</td>
      <td>5</td>
      <td>4</td>
      <td>98</td>
      <td>104</td>
      <td>6</td>
      <td>18</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>7</td>
      <td>4</td>
      <td>104</td>
      <td>108</td>
      <td>4</td>
      <td>16</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>12</td>
      <td>18</td>
      <td>2</td>
      <td>5</td>
      <td>4</td>
      <td>108</td>
      <td>114</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Emergency</td>
      <td>Friday</td>
      <td>18</td>
      <td>2</td>
      <td>3</td>
      <td>7</td>
      <td>4</td>
      <td>114</td>
      <td>122</td>
      <td>8</td>
      <td>24</td>
    </tr>
    <tr>
      <th>32</th>
      <td>Consultation</td>
      <td>Friday</td>
      <td>8</td>
      <td>12</td>
      <td>10</td>
      <td>13</td>
      <td>4</td>
      <td>104</td>
      <td>108</td>
      <td>4</td>
      <td>40</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Consultation</td>
      <td>Friday</td>
      <td>12</td>
      <td>18</td>
      <td>8</td>
      <td>12</td>
      <td>4</td>
      <td>108</td>
      <td>114</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>2</td>
      <td>12</td>
      <td>5</td>
      <td>7</td>
      <td>5</td>
      <td>122</td>
      <td>132</td>
      <td>10</td>
      <td>50</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>12</td>
      <td>20</td>
      <td>7</td>
      <td>9</td>
      <td>5</td>
      <td>132</td>
      <td>140</td>
      <td>8</td>
      <td>56</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Emergency</td>
      <td>Saturday</td>
      <td>20</td>
      <td>2</td>
      <td>12</td>
      <td>12</td>
      <td>5</td>
      <td>140</td>
      <td>146</td>
      <td>6</td>
      <td>72</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>2</td>
      <td>12</td>
      <td>5</td>
      <td>7</td>
      <td>6</td>
      <td>146</td>
      <td>156</td>
      <td>10</td>
      <td>50</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>12</td>
      <td>20</td>
      <td>7</td>
      <td>9</td>
      <td>6</td>
      <td>156</td>
      <td>164</td>
      <td>8</td>
      <td>56</td>
    </tr>
    <tr>
      <th>39</th>
      <td>Emergency</td>
      <td>Sunday</td>
      <td>20</td>
      <td>2</td>
      <td>8</td>
      <td>12</td>
      <td>6</td>
      <td>164</td>
      <td>170</td>
      <td>6</td>
      <td>48</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Geriatrics</td>
      <td>Sunday</td>
      <td>8</td>
      <td>10</td>
      <td>2</td>
      <td>5</td>
      <td>6</td>
      <td>152</td>
      <td>154</td>
      <td>2</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="step-5-set-up-the-prescriptive-model">
<h3>Step 5: Set up the prescriptive model<a class="headerlink" href="#step-5-set-up-the-prescriptive-model" title="Permalink to this headline">&para;</a></h3>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.environment</span> <span class="kn">import</span> <span class="n">Environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>* system is: Windows 64bit
* Python is present, version is 2.7.11
* docplex is present, version is (1, 0, 0)
</pre></div>
</div>
<div class="section" id="create-the-docplex-model">
<h4>Create the DOcplex model<a class="headerlink" href="#create-the-docplex-model" title="Permalink to this headline">&para;</a></h4>
<p>The model contains all the business constraints and defines the
objective.</p>
<p>We now use CPLEX Modeling for Python to build a Mixed Integer
Programming (MIP) model for this problem.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.model</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="n">mdl</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;nurses&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="define-the-decision-variables">
<h4>Define the decision variables<a class="headerlink" href="#define-the-decision-variables" title="Permalink to this headline">&para;</a></h4>
<p>For each (nurse, shift) pair, we create one binary variable that is
equal to 1 when the nurse is assigned to the shift.</p>
<p>We use the <code class="docutils literal"><span class="pre">binary_var_matrix</span></code> method of class <code class="docutils literal"><span class="pre">Model</span></code>, as each
binary variable is indexed by <em>two</em> objects: one nurse and one shift.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># first global collections to iterate upon</span>
<span class="n">all_nurses</span> <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
<span class="n">all_shifts</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># the assignment variables.</span>
<span class="n">assigned</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">binary_var_matrix</span><span class="p">(</span><span class="n">keys1</span><span class="o">=</span><span class="n">all_nurses</span><span class="p">,</span> <span class="n">keys2</span><span class="o">=</span><span class="n">all_shifts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;assign_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="express-the-business-constraints">
<h4>Express the business constraints<a class="headerlink" href="#express-the-business-constraints" title="Permalink to this headline">&para;</a></h4>
<div class="section" id="overlapping-shifts">
<h5>Overlapping shifts<a class="headerlink" href="#overlapping-shifts" title="Permalink to this headline">&para;</a></h5>
<p>Some shifts overlap in time, and thus cannot be assigned to the same
nurse. To check whether two shifts overlap in time, we start by ordering
all shifts with respect to their <em>wstart</em> and <em>duration</em> properties.
Then, for each shift, we iterate over the subsequent shifts in this
ordered list to easily compute the subset of overlapping shifts.</p>
<p>We use <em>pandas</em> operations to implement this algorithm. But first, we
organize all decision variables in a DataFrame.</p>
<p>For convenience, we also organize the decision variables in a pivot
table with <em>nurses</em> as row index and <em>shifts</em> as columns. The <em>pandas</em>
<em>unstack</em> operation does this.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Organize decision variables in a DataFrame</span>
<span class="n">df_assigned</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;assigned&#39;</span><span class="p">:</span> <span class="n">assigned</span><span class="p">})</span>
<span class="n">df_assigned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">,</span> <span class="s1">&#39;all_shifts&#39;</span><span class="p">]</span>

<span class="c1"># Re-organize the Data Frame as a pivot table with nurses as row index and shifts as columns:</span>
<span class="n">df_assigned_pivot</span> <span class="o">=</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_shifts&#39;</span><span class="p">)</span>

<span class="c1"># Create a pivot using nurses and shifts index as dimensions</span>
<span class="c1">#df_assigned_pivot = df_assigned.reset_index().pivot(index=&#39;all_nurses&#39;, columns=&#39;all_shifts&#39;, values=&#39;assigned&#39;)</span>

<span class="c1"># Display first rows of the pivot table</span>
<span class="n">df_assigned_pivot</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="21" halign="left">assigned</th>
    </tr>
    <tr>
      <th>all_shifts</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>31</th>
      <th>32</th>
      <th>33</th>
      <th>34</th>
      <th>35</th>
      <th>36</th>
      <th>37</th>
      <th>38</th>
      <th>39</th>
      <th>40</th>
    </tr>
    <tr>
      <th>all_nurses</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Anne</th>
      <td>assign_Anne_0</td>
      <td>assign_Anne_1</td>
      <td>assign_Anne_2</td>
      <td>assign_Anne_3</td>
      <td>assign_Anne_4</td>
      <td>assign_Anne_5</td>
      <td>assign_Anne_6</td>
      <td>assign_Anne_7</td>
      <td>assign_Anne_8</td>
      <td>assign_Anne_9</td>
      <td>...</td>
      <td>assign_Anne_31</td>
      <td>assign_Anne_32</td>
      <td>assign_Anne_33</td>
      <td>assign_Anne_34</td>
      <td>assign_Anne_35</td>
      <td>assign_Anne_36</td>
      <td>assign_Anne_37</td>
      <td>assign_Anne_38</td>
      <td>assign_Anne_39</td>
      <td>assign_Anne_40</td>
    </tr>
    <tr>
      <th>Bethanie</th>
      <td>assign_Bethanie_0</td>
      <td>assign_Bethanie_1</td>
      <td>assign_Bethanie_2</td>
      <td>assign_Bethanie_3</td>
      <td>assign_Bethanie_4</td>
      <td>assign_Bethanie_5</td>
      <td>assign_Bethanie_6</td>
      <td>assign_Bethanie_7</td>
      <td>assign_Bethanie_8</td>
      <td>assign_Bethanie_9</td>
      <td>...</td>
      <td>assign_Bethanie_31</td>
      <td>assign_Bethanie_32</td>
      <td>assign_Bethanie_33</td>
      <td>assign_Bethanie_34</td>
      <td>assign_Bethanie_35</td>
      <td>assign_Bethanie_36</td>
      <td>assign_Bethanie_37</td>
      <td>assign_Bethanie_38</td>
      <td>assign_Bethanie_39</td>
      <td>assign_Bethanie_40</td>
    </tr>
    <tr>
      <th>Betsy</th>
      <td>assign_Betsy_0</td>
      <td>assign_Betsy_1</td>
      <td>assign_Betsy_2</td>
      <td>assign_Betsy_3</td>
      <td>assign_Betsy_4</td>
      <td>assign_Betsy_5</td>
      <td>assign_Betsy_6</td>
      <td>assign_Betsy_7</td>
      <td>assign_Betsy_8</td>
      <td>assign_Betsy_9</td>
      <td>...</td>
      <td>assign_Betsy_31</td>
      <td>assign_Betsy_32</td>
      <td>assign_Betsy_33</td>
      <td>assign_Betsy_34</td>
      <td>assign_Betsy_35</td>
      <td>assign_Betsy_36</td>
      <td>assign_Betsy_37</td>
      <td>assign_Betsy_38</td>
      <td>assign_Betsy_39</td>
      <td>assign_Betsy_40</td>
    </tr>
    <tr>
      <th>Cathy</th>
      <td>assign_Cathy_0</td>
      <td>assign_Cathy_1</td>
      <td>assign_Cathy_2</td>
      <td>assign_Cathy_3</td>
      <td>assign_Cathy_4</td>
      <td>assign_Cathy_5</td>
      <td>assign_Cathy_6</td>
      <td>assign_Cathy_7</td>
      <td>assign_Cathy_8</td>
      <td>assign_Cathy_9</td>
      <td>...</td>
      <td>assign_Cathy_31</td>
      <td>assign_Cathy_32</td>
      <td>assign_Cathy_33</td>
      <td>assign_Cathy_34</td>
      <td>assign_Cathy_35</td>
      <td>assign_Cathy_36</td>
      <td>assign_Cathy_37</td>
      <td>assign_Cathy_38</td>
      <td>assign_Cathy_39</td>
      <td>assign_Cathy_40</td>
    </tr>
    <tr>
      <th>Cecilia</th>
      <td>assign_Cecilia_0</td>
      <td>assign_Cecilia_1</td>
      <td>assign_Cecilia_2</td>
      <td>assign_Cecilia_3</td>
      <td>assign_Cecilia_4</td>
      <td>assign_Cecilia_5</td>
      <td>assign_Cecilia_6</td>
      <td>assign_Cecilia_7</td>
      <td>assign_Cecilia_8</td>
      <td>assign_Cecilia_9</td>
      <td>...</td>
      <td>assign_Cecilia_31</td>
      <td>assign_Cecilia_32</td>
      <td>assign_Cecilia_33</td>
      <td>assign_Cecilia_34</td>
      <td>assign_Cecilia_35</td>
      <td>assign_Cecilia_36</td>
      <td>assign_Cecilia_37</td>
      <td>assign_Cecilia_38</td>
      <td>assign_Cecilia_39</td>
      <td>assign_Cecilia_40</td>
    </tr>
  </tbody>
</table>
<p>5 rows &times; 41 columns</p>
</div><p>We create a DataFrame representing a list of shifts sorted by <em>&#8220;wstart&#8221;</em>
and <em>&#8220;duration&#8221;</em>. This sorted list will be used to easily detect
overlapping shifts.</p>
<p>Note that indices are reset after sorting so that the DataFrame can be
indexed with respect to the index in the sorted list and not the
original unsorted list. This is the purpose of the <em>reset_index()</em>
operation which also adds a new column named <em>&#8220;shiftId&#8221;</em> with the
original index.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create a Data Frame representing a list of shifts sorted by wstart and duration.</span>
<span class="c1"># One keeps only the three relevant columns: &#39;shiftId&#39;, &#39;wstart&#39; and &#39;wend&#39; in the resulting Data Frame</span>
<span class="n">df_sorted_shifts</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;wstart&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;shiftId&#39;</span><span class="p">,</span> <span class="s1">&#39;wstart&#39;</span><span class="p">,</span> <span class="s1">&#39;wend&#39;</span><span class="p">]]</span>

<span class="c1"># Display the first rows of the newly created Data Frame</span>
<span class="n">df_sorted_shifts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>shiftId</th>
      <th>wstart</th>
      <th>wend</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6</td>
      <td>8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>12</td>
      <td>18</td>
    </tr>
  </tbody>
</table>
</div><p>Next, we state that for any pair of shifts that overlap in time, a nurse
can be assigned to only one of the two.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">number_of_incompatible_shift_constraints</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">df_sorted_shifts</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="c1"># Iterate over following shifts</span>
    <span class="c1"># &#39;shift[0]&#39; contains the index of the current shift in the df_sorted_shifts Data Frame</span>
    <span class="k">for</span> <span class="n">shift_2</span> <span class="ow">in</span> <span class="n">df_sorted_shifts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shift_2</span><span class="o">.</span><span class="n">wstart</span> <span class="o">&lt;</span> <span class="n">shift</span><span class="o">.</span><span class="n">wend</span><span class="p">):</span>
            <span class="c1"># Iterate over all nurses to force incompatible assignment for the current pair of overlapping shifts</span>
            <span class="k">for</span> <span class="n">nurse_assignments</span> <span class="ow">in</span> <span class="n">df_assigned_pivot</span><span class="p">[[</span><span class="n">shift</span><span class="o">.</span><span class="n">shiftId</span><span class="p">,</span> <span class="n">shift_2</span><span class="o">.</span><span class="n">shiftId</span><span class="p">]]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                <span class="c1"># this is actually a logical OR</span>
                <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">nurse_assignments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">nurse_assignments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">number_of_incompatible_shift_constraints</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No need to test overlap with following shifts</span>
            <span class="k">break</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;#incompatible shift constraints: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_of_incompatible_shift_constraints</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#incompatible shift constraints: 640</span>
</pre></div>
</div>
</div>
<div class="section" id="vacations">
<h5>Vacations<a class="headerlink" href="#vacations" title="Permalink to this headline">&para;</a></h5>
<p>When the nurse is on vacation, he cannot be assigned to any shift
starting that day.</p>
<p>We use the <em>pandas</em> <em>merge</em> operation to create a join between the
<em>&#8220;df_vacations&#8221;</em>, <em>&#8220;df_shifts&#8221;</em>, and <em>&#8220;df_assigned&#8221;</em> DataFrames. Each
row of the resulting DataFrame contains the assignment decision variable
corresponding to the matching (nurse, shift) pair.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Add &#39;day of week&#39; column to vacations Data Frame</span>
<span class="n">df_vacations</span><span class="p">[</span><span class="s1">&#39;dow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_vacations</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">day_to_day_of_week</span><span class="p">)</span>

<span class="c1"># Join &#39;df_vacations&#39;, &#39;df_shifts&#39; and &#39;df_assigned&#39; Data Frames to create the list of &#39;forbidden&#39; assigments.</span>
<span class="c1"># The &#39;reset_index()&#39; function is invoked to move &#39;shiftId&#39; index as a column in &#39;df_shifts&#39; Data Frame, and</span>
<span class="c1"># to move the index pair (&#39;all_nurses&#39;, &#39;all_shifts&#39;) as columns in &#39;df_assigned&#39; Data Frame.</span>
<span class="c1"># &#39;reset_index()&#39; is invoked so that a join can be performed between Data Frame, based on column names.</span>
<span class="n">df_assigned_reindexed</span> <span class="o">=</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_vacation_forbidden_assignments</span> <span class="o">=</span> <span class="n">df_vacations</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_shifts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;dow&#39;</span><span class="p">,</span> <span class="s1">&#39;shiftId&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_assigned_reindexed</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nurse&#39;</span><span class="p">,</span> <span class="s1">&#39;shiftId&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">,</span> <span class="s1">&#39;all_shifts&#39;</span><span class="p">])</span>

<span class="c1"># Here are the first few rows of the resulting Data Frames joins</span>
<span class="n">df_vacation_forbidden_assignments</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nurse</th>
      <th>day</th>
      <th>dow</th>
      <th>shiftId</th>
      <th>all_nurses</th>
      <th>all_shifts</th>
      <th>assigned</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Anne</td>
      <td>Friday</td>
      <td>4</td>
      <td>28</td>
      <td>Anne</td>
      <td>28</td>
      <td>assign_Anne_28</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Anne</td>
      <td>Friday</td>
      <td>4</td>
      <td>29</td>
      <td>Anne</td>
      <td>29</td>
      <td>assign_Anne_29</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Anne</td>
      <td>Friday</td>
      <td>4</td>
      <td>30</td>
      <td>Anne</td>
      <td>30</td>
      <td>assign_Anne_30</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Anne</td>
      <td>Friday</td>
      <td>4</td>
      <td>31</td>
      <td>Anne</td>
      <td>31</td>
      <td>assign_Anne_31</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Anne</td>
      <td>Friday</td>
      <td>4</td>
      <td>32</td>
      <td>Anne</td>
      <td>32</td>
      <td>assign_Anne_32</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">forbidden_assignment</span> <span class="ow">in</span> <span class="n">df_vacation_forbidden_assignments</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="c1"># to forbid an assignment just set the variable to zero.</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">forbidden_assignment</span><span class="o">.</span><span class="n">assigned</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;# vacation forbids: {} assignments&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_vacation_forbidden_assignments</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># vacation forbids: 342 assignments</span>
</pre></div>
</div>
</div>
<div class="section" id="associations">
<h5>Associations<a class="headerlink" href="#associations" title="Permalink to this headline">&para;</a></h5>
<p>Some pairs of nurses get along particularly well, so we wish to assign
them together as a team. In other words, for every such couple and for
each shift, both assignment variables should always be equal. Either
both nurses work the shift, or both do not.</p>
<p>In the same way we modeled <em>vacations</em>, we use the <em>pandas</em> merge
operation to create a DataFrame for which each row contains the pair of
nurse-shift assignment decision variables matching each association.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Join &#39;df_assignment&#39; Data Frame twice, based on associations to get corresponding decision variables pairs for all shifts</span>
<span class="c1"># The &#39;suffixes&#39; parameter in the second merge indicates our preference for updating the name of columns that occur both</span>
<span class="c1"># in the first and second argument Data Frames (in our case, these columns are &#39;all_nurses&#39; and &#39;assigned&#39;).</span>
<span class="n">df_preferred_assign</span> <span class="o">=</span> <span class="n">df_associations</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_assigned_reindexed</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;nurse1&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_assigned_reindexed</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nurse2&#39;</span><span class="p">,</span> <span class="s1">&#39;all_shifts&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">,</span> <span class="s1">&#39;all_shifts&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span><span class="s1">&#39;_2&#39;</span><span class="p">))</span>

<span class="c1"># Here are the first few rows of the resulting Data Frames joins</span>
<span class="n">df_preferred_assign</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nurse1</th>
      <th>nurse2</th>
      <th>all_nurses_1</th>
      <th>all_shifts</th>
      <th>assigned_1</th>
      <th>all_nurses_2</th>
      <th>assigned_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Isabelle</td>
      <td>Dee</td>
      <td>Isabelle</td>
      <td>0</td>
      <td>assign_Isabelle_0</td>
      <td>Dee</td>
      <td>assign_Dee_0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Isabelle</td>
      <td>Dee</td>
      <td>Isabelle</td>
      <td>1</td>
      <td>assign_Isabelle_1</td>
      <td>Dee</td>
      <td>assign_Dee_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Isabelle</td>
      <td>Dee</td>
      <td>Isabelle</td>
      <td>2</td>
      <td>assign_Isabelle_2</td>
      <td>Dee</td>
      <td>assign_Dee_2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Isabelle</td>
      <td>Dee</td>
      <td>Isabelle</td>
      <td>3</td>
      <td>assign_Isabelle_3</td>
      <td>Dee</td>
      <td>assign_Dee_3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Isabelle</td>
      <td>Dee</td>
      <td>Isabelle</td>
      <td>4</td>
      <td>assign_Isabelle_4</td>
      <td>Dee</td>
      <td>assign_Dee_4</td>
    </tr>
  </tbody>
</table>
</div><p>The associations constraint can now easily be formulated by iterating on
the rows of the <em>&#8220;df_preferred_assign&#8221;</em> DataFrame.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">preferred_assign</span> <span class="ow">in</span> <span class="n">df_preferred_assign</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">preferred_assign</span><span class="o">.</span><span class="n">assigned_1</span> <span class="o">==</span> <span class="n">preferred_assign</span><span class="o">.</span><span class="n">assigned_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="incompatibilities">
<h5>Incompatibilities<a class="headerlink" href="#incompatibilities" title="Permalink to this headline">&para;</a></h5>
<p>Similarly, certain pairs of nurses do not get along well, and we want to
avoid having them together on a shift. In other terms, for each shift,
both nurses of an incompatible pair cannot be assigned together to the
sift. Again, we state a logical OR between the two assignments: at most
one nurse from the pair can work the shift.</p>
<p>We first create a DataFrame whose rows contain pairs of invalid
assignment decision variables, using the same <em>pandas</em> <code class="docutils literal"><span class="pre">merge</span></code>
operations as in the previous step.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Join assignment Data Frame twice, based on incompatibilities Data Frame to get corresponding decision variables pairs</span>
<span class="c1">#  for all shifts</span>
<span class="n">df_incompatible_assign</span> <span class="o">=</span> <span class="n">df_incompatibilities</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_assigned_reindexed</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;nurse1&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_assigned_reindexed</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nurse2&#39;</span><span class="p">,</span> <span class="s1">&#39;all_shifts&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">,</span> <span class="s1">&#39;all_shifts&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span><span class="s1">&#39;_2&#39;</span><span class="p">))</span>

<span class="c1"># Here are the first few rows of the resulting Data Frames joins</span>
<span class="n">df_incompatible_assign</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nurse1</th>
      <th>nurse2</th>
      <th>all_nurses_1</th>
      <th>all_shifts</th>
      <th>assigned_1</th>
      <th>all_nurses_2</th>
      <th>assigned_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Patricia</td>
      <td>Patrick</td>
      <td>Patricia</td>
      <td>0</td>
      <td>assign_Patricia_0</td>
      <td>Patrick</td>
      <td>assign_Patrick_0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Patricia</td>
      <td>Patrick</td>
      <td>Patricia</td>
      <td>1</td>
      <td>assign_Patricia_1</td>
      <td>Patrick</td>
      <td>assign_Patrick_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Patricia</td>
      <td>Patrick</td>
      <td>Patricia</td>
      <td>2</td>
      <td>assign_Patricia_2</td>
      <td>Patrick</td>
      <td>assign_Patrick_2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Patricia</td>
      <td>Patrick</td>
      <td>Patricia</td>
      <td>3</td>
      <td>assign_Patricia_3</td>
      <td>Patrick</td>
      <td>assign_Patrick_3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Patricia</td>
      <td>Patrick</td>
      <td>Patricia</td>
      <td>4</td>
      <td>assign_Patricia_4</td>
      <td>Patrick</td>
      <td>assign_Patrick_4</td>
    </tr>
  </tbody>
</table>
</div><p>The incompatibilities constraint can now easily be formulated, by
iterating on the rows of the <em>&#8220;df_incompatible_assign&#8221;</em> DataFrame.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">incompatible_assign</span> <span class="ow">in</span> <span class="n">df_incompatible_assign</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">incompatible_assign</span><span class="o">.</span><span class="n">assigned_1</span> <span class="o">+</span> <span class="n">incompatible_assign</span><span class="o">.</span><span class="n">assigned_2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="constraints-on-work-time">
<h5>Constraints on work time<a class="headerlink" href="#constraints-on-work-time" title="Permalink to this headline">&para;</a></h5>
<p>Regulations force constraints on the total work time over a week; and we
compute this total work time in a new variable. We store the variable in
an extra column in the nurse DataFrame.</p>
<p>The variable is declared as <em>continuous</em> though it contains only integer
values. This is done to avoid adding unnecessary integer variables for
the <em>branch and bound</em> algorithm. These variables are not true decision
variables; they are used to express work constraints.</p>
<p>From a <em>pandas</em> perspective, we apply a function over the rows of the
nurse DataFrame to create this variable and store it into a new column
of the DataFrame.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># auxiliary function to create worktime variable from a row</span>
<span class="k">def</span> <span class="nf">make_var</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">varname_fmt</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mdl</span><span class="o">.</span><span class="n">continuous_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">varname_fmt</span> <span class="o">%</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># apply the function over nurse rows and store result in a new column</span>
<span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;worktime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">make_var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;worktime_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># display nurse dataframe</span>
<span class="n">df_nurses</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seniority</th>
      <th>qualification</th>
      <th>pay_rate</th>
      <th>worktime</th>
    </tr>
    <tr>
      <th>name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Anne</th>
      <td>11</td>
      <td>1</td>
      <td>25</td>
      <td>worktime_Anne</td>
    </tr>
    <tr>
      <th>Bethanie</th>
      <td>4</td>
      <td>5</td>
      <td>28</td>
      <td>worktime_Bethanie</td>
    </tr>
    <tr>
      <th>Betsy</th>
      <td>2</td>
      <td>2</td>
      <td>17</td>
      <td>worktime_Betsy</td>
    </tr>
    <tr>
      <th>Cathy</th>
      <td>2</td>
      <td>2</td>
      <td>17</td>
      <td>worktime_Cathy</td>
    </tr>
    <tr>
      <th>Cecilia</th>
      <td>9</td>
      <td>5</td>
      <td>38</td>
      <td>worktime_Cecilia</td>
    </tr>
    <tr>
      <th>Chris</th>
      <td>11</td>
      <td>4</td>
      <td>38</td>
      <td>worktime_Chris</td>
    </tr>
    <tr>
      <th>Cindy</th>
      <td>5</td>
      <td>2</td>
      <td>21</td>
      <td>worktime_Cindy</td>
    </tr>
    <tr>
      <th>David</th>
      <td>1</td>
      <td>2</td>
      <td>15</td>
      <td>worktime_David</td>
    </tr>
    <tr>
      <th>Debbie</th>
      <td>7</td>
      <td>2</td>
      <td>24</td>
      <td>worktime_Debbie</td>
    </tr>
    <tr>
      <th>Dee</th>
      <td>3</td>
      <td>3</td>
      <td>21</td>
      <td>worktime_Dee</td>
    </tr>
    <tr>
      <th>Gloria</th>
      <td>8</td>
      <td>2</td>
      <td>25</td>
      <td>worktime_Gloria</td>
    </tr>
    <tr>
      <th>Isabelle</th>
      <td>3</td>
      <td>1</td>
      <td>16</td>
      <td>worktime_Isabelle</td>
    </tr>
    <tr>
      <th>Jane</th>
      <td>3</td>
      <td>4</td>
      <td>23</td>
      <td>worktime_Jane</td>
    </tr>
    <tr>
      <th>Janelle</th>
      <td>4</td>
      <td>3</td>
      <td>22</td>
      <td>worktime_Janelle</td>
    </tr>
    <tr>
      <th>Janice</th>
      <td>2</td>
      <td>2</td>
      <td>17</td>
      <td>worktime_Janice</td>
    </tr>
    <tr>
      <th>Jemma</th>
      <td>2</td>
      <td>4</td>
      <td>22</td>
      <td>worktime_Jemma</td>
    </tr>
    <tr>
      <th>Joan</th>
      <td>5</td>
      <td>3</td>
      <td>24</td>
      <td>worktime_Joan</td>
    </tr>
    <tr>
      <th>Joyce</th>
      <td>8</td>
      <td>3</td>
      <td>29</td>
      <td>worktime_Joyce</td>
    </tr>
    <tr>
      <th>Jude</th>
      <td>4</td>
      <td>3</td>
      <td>22</td>
      <td>worktime_Jude</td>
    </tr>
    <tr>
      <th>Julie</th>
      <td>6</td>
      <td>2</td>
      <td>22</td>
      <td>worktime_Julie</td>
    </tr>
    <tr>
      <th>Juliet</th>
      <td>7</td>
      <td>4</td>
      <td>31</td>
      <td>worktime_Juliet</td>
    </tr>
    <tr>
      <th>Kate</th>
      <td>5</td>
      <td>3</td>
      <td>24</td>
      <td>worktime_Kate</td>
    </tr>
    <tr>
      <th>Nancy</th>
      <td>8</td>
      <td>4</td>
      <td>32</td>
      <td>worktime_Nancy</td>
    </tr>
    <tr>
      <th>Nathalie</th>
      <td>9</td>
      <td>5</td>
      <td>38</td>
      <td>worktime_Nathalie</td>
    </tr>
    <tr>
      <th>Nicole</th>
      <td>0</td>
      <td>2</td>
      <td>14</td>
      <td>worktime_Nicole</td>
    </tr>
    <tr>
      <th>Patricia</th>
      <td>1</td>
      <td>1</td>
      <td>13</td>
      <td>worktime_Patricia</td>
    </tr>
    <tr>
      <th>Patrick</th>
      <td>6</td>
      <td>1</td>
      <td>19</td>
      <td>worktime_Patrick</td>
    </tr>
    <tr>
      <th>Roberta</th>
      <td>3</td>
      <td>5</td>
      <td>26</td>
      <td>worktime_Roberta</td>
    </tr>
    <tr>
      <th>Suzanne</th>
      <td>5</td>
      <td>1</td>
      <td>18</td>
      <td>worktime_Suzanne</td>
    </tr>
    <tr>
      <th>Vickie</th>
      <td>7</td>
      <td>1</td>
      <td>20</td>
      <td>worktime_Vickie</td>
    </tr>
    <tr>
      <th>Wendie</th>
      <td>5</td>
      <td>2</td>
      <td>21</td>
      <td>worktime_Wendie</td>
    </tr>
    <tr>
      <th>Zoe</th>
      <td>8</td>
      <td>3</td>
      <td>29</td>
      <td>worktime_Zoe</td>
    </tr>
  </tbody>
</table>
</div><p>Define total work time</p>
<p>Work time variables must be constrained to be equal to the sum of hours
actually worked.</p>
<p>We use the <em>pandas</em> <em>groupby</em> operation to collect all assignment
decision variables for each nurse in a separate series. Then, we iterate
over nurses to post a constraint calculating the actual worktime for
each nurse as the dot product of the series of nurse-shift assignments
with the series of shift durations.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Use pandas&#39; groupby operation to enforce constraint calculating worktime for each nurse as the sum of all assigned</span>
<span class="c1">#  shifts times the duration of each shift</span>
<span class="k">for</span> <span class="n">nurse</span><span class="p">,</span> <span class="n">nurse_assignments</span> <span class="ow">in</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">):</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">df_nurses</span><span class="o">.</span><span class="n">worktime</span><span class="p">[</span><span class="n">nurse</span><span class="p">]</span> <span class="o">==</span> <span class="n">mdl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">nurse_assignments</span><span class="o">.</span><span class="n">assigned</span><span class="p">,</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">duration</span><span class="p">))</span>

<span class="c1"># print model information and check we now have 32 extra continuous variables</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>Model: nurses
 - number of variables: 1344
   - binary=1312, integer=0, continuous=32
 - number of constraints: 1547
 -   LE=1091, EQ=456, GE=0, RNG=0
 - parameters: defaults
</pre></div>
</div>
<p>Maximum work time</p>
<p>For each nurse, we add a constraint to enforce the maximum work time for
a week. Again we use the <code class="docutils literal"><span class="pre">apply</span></code> method, this time with an anonymous
lambda function.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># we use pandas&#39; apply() method to set an upper bound on all worktime variables.</span>
<span class="k">def</span> <span class="nf">set_max_work_time</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="n">v</span><span class="o">.</span><span class="n">ub</span> <span class="o">=</span> <span class="n">max_work_time</span>
    <span class="c1"># Optionally: return a string for fancy display of the constraint in the Output cell</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &lt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ub</span><span class="p">)</span>

<span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;worktime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_dtype</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">set_max_work_time</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>name
Anne            worktime_Anne &lt;= 40.0
Bethanie    worktime_Bethanie &lt;= 40.0
Betsy          worktime_Betsy &lt;= 40.0
Cathy          worktime_Cathy &lt;= 40.0
Cecilia      worktime_Cecilia &lt;= 40.0
Chris          worktime_Chris &lt;= 40.0
Cindy          worktime_Cindy &lt;= 40.0
David          worktime_David &lt;= 40.0
Debbie        worktime_Debbie &lt;= 40.0
Dee              worktime_Dee &lt;= 40.0
Gloria        worktime_Gloria &lt;= 40.0
Isabelle    worktime_Isabelle &lt;= 40.0
Jane            worktime_Jane &lt;= 40.0
Janelle      worktime_Janelle &lt;= 40.0
Janice        worktime_Janice &lt;= 40.0
Jemma          worktime_Jemma &lt;= 40.0
Joan            worktime_Joan &lt;= 40.0
Joyce          worktime_Joyce &lt;= 40.0
Jude            worktime_Jude &lt;= 40.0
Julie          worktime_Julie &lt;= 40.0
Juliet        worktime_Juliet &lt;= 40.0
Kate            worktime_Kate &lt;= 40.0
Nancy          worktime_Nancy &lt;= 40.0
Nathalie    worktime_Nathalie &lt;= 40.0
Nicole        worktime_Nicole &lt;= 40.0
Patricia    worktime_Patricia &lt;= 40.0
Patrick      worktime_Patrick &lt;= 40.0
Roberta      worktime_Roberta &lt;= 40.0
Suzanne      worktime_Suzanne &lt;= 40.0
Vickie        worktime_Vickie &lt;= 40.0
Wendie        worktime_Wendie &lt;= 40.0
Zoe              worktime_Zoe &lt;= 40.0
Name: worktime, dtype: object
</pre></div>
</div>
</div>
<div class="section" id="minimum-requirement-for-shifts">
<h5>Minimum requirement for shifts<a class="headerlink" href="#minimum-requirement-for-shifts" title="Permalink to this headline">&para;</a></h5>
<p>Each shift requires a minimum number of nurses. For each shift, the sum
over all nurses of assignments to this shift must be greater than the
minimum requirement.</p>
<p>The <em>pandas</em> <em>groupby</em> operation is invoked to collect all assignment
decision variables for each shift in a separate series. Then, we iterate
over shifts to post the constraint enforcing the minimum number of nurse
assignments for each shift.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Use pandas&#39; groupby operation to enforce minimum requirement constraint for each shift</span>
<span class="k">for</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift_nurses</span> <span class="ow">in</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_shifts&#39;</span><span class="p">):</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shift_nurses</span><span class="o">.</span><span class="n">assigned</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">min_req</span><span class="p">[</span><span class="n">shift</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="express-the-objective">
<h4>Express the objective<a class="headerlink" href="#express-the-objective" title="Permalink to this headline">&para;</a></h4>
<p>The objective mixes different (and contradictory) KPIs.</p>
<p>The first KPI is the total salary cost, computed as the sum of work
times over all nurses, weighted by pay rate.</p>
<p>We compute this KPI as an expression from the variables we previously
defined by using the panda summation over the DOcplex objects.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># again leverage pandas to create a series of expressions: costs of each nurse</span>
<span class="n">total_salary_series</span> <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">worktime</span> <span class="o">*</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">pay_rate</span>

<span class="c1"># compute global salary cost using pandas sum()</span>
<span class="c1"># Note that the result is a DOcplex expression: DOcplex if fully compatible with pandas</span>
<span class="n">total_salary_cost</span> <span class="o">=</span> <span class="n">total_salary_series</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_salary_cost</span><span class="p">,</span> <span class="s2">&quot;Total salary cost&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>DecisionKPI(name=Total salary cost,expr=25worktime_Anne+28worktime_Bethanie+17worktime_Betsy+17worktime_Cathy+38worktime_Cecilia+38worktime_Chris+21worktime_Cindy+15worktime_David+24worktime_Debbie+21worktime_Dee+25worktime_Gloria+16worktime_Isabelle+23worktime_Jane+22worktime_Janelle+17worktime_Janice+22worktime_Jemma+24worktime_Joan+29worktime_Joyce+22worktime_Jude+22worktime_Julie+31worktime_Juliet+24worktime_Kate+32worktime_Nancy+38worktime_Nathalie+14worktime_Nicole+13worktime_Patricia+19worktime_Patrick+26worktime_Roberta+18worktime_Suzanne+20worktime_Vickie+21worktime_Wendie+29worktime_Zoe)
</pre></div>
</div>
<div class="section" id="minimizing-salary-cost">
<h5>Minimizing salary cost<a class="headerlink" href="#minimizing-salary-cost" title="Permalink to this headline">&para;</a></h5>
<p>In a preliminary version of the model, we minimize the total salary
cost. This is accomplished using the <code class="docutils literal"><span class="pre">Model.minimize()</span></code> method.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">mdl</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">total_salary_cost</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>Model: nurses
 - number of variables: 1344
   - binary=1312, integer=0, continuous=32
 - number of constraints: 1588
 -   LE=1091, EQ=456, GE=41, RNG=0
 - parameters: defaults
</pre></div>
</div>
</div>
</div>
<div class="section" id="solve-with-the-decision-optimization-solve-service">
<h4>Solve with the Decision Optimization solve service<a class="headerlink" href="#solve-with-the-decision-optimization-solve-service" title="Permalink to this headline">&para;</a></h4>
<p>Now we have everything we need to solve the model, using
<code class="docutils literal"><span class="pre">Model.solve()</span></code>. The following cell solves using your local CPLEX (if
any, and provided you have added it to your <code class="docutils literal"><span class="pre">PYTHONPATH</span></code> variable). If
you do not have CPLEX installed, please enter your DOcplexcloud
credentials below in the <code class="docutils literal"><span class="pre">key</span></code> and <code class="docutils literal"><span class="pre">url</span></code> fields in order to solve on
DOcplexcloud.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Set Cplex mipgap to 1e-5 to enforce precision to be of the order of a unit (objective value magnitude is ~1e+5).</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mip</span><span class="o">.</span><span class="n">tolerances</span><span class="o">.</span><span class="n">mipgap</span> <span class="o">=</span> <span class="mf">1e-5</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">log_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;solve failed&quot;</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>Tried aggregator 2 times.
MIP Presolve eliminated 995 rows and 379 columns.
MIP Presolve modified 90 coefficients.
Aggregator did 41 substitutions.
Reduced MIP has 552 rows, 924 columns, and 2905 nonzeros.
Reduced MIP has 892 binaries, 0 generals, 0 SOSs, and 0 indicators.
Presolve time = 0.02 sec. (3.51 ticks)
Probing time = 0.00 sec. (0.60 ticks)
Tried aggregator 1 time.
Reduced MIP has 552 rows, 924 columns, and 2905 nonzeros.
Reduced MIP has 892 binaries, 32 generals, 0 SOSs, and 0 indicators.
Presolve time = 0.00 sec. (1.55 ticks)
Probing time = 0.02 sec. (0.60 ticks)
Clique table members: 479.
MIP emphasis: balance optimality and feasibility.
MIP search method: dynamic search.
Parallel mode: deterministic, using up to 8 threads.
Root relaxation solution time = 0.00 sec. (4.14 ticks)

        Nodes                                         Cuts/
   Node  Left     Objective  IInf  Best Integer    Best Bound    ItCnt     Gap

      0     0    28824.0000    41                  28824.0000      465
      0     0    28824.0000    73                    Cuts: 83      607
      0     0    28824.0000    52                    Cuts: 55      713
      0     0    28824.0000    60                    Cuts: 76      830
*     0+    0                        29096.0000    28824.0000             0.93%
*     0+    0                        29046.0000    28824.0000             0.76%
*     0+    0                        28924.0000    28824.0000             0.35%
*     0+    0                        28824.0000    28824.0000             0.00%
      0     0        cutoff          28824.0000    28824.0000      830    0.00%
Elapsed time = 0.39 sec. (165.62 ticks, tree = 0.01 MB, solutions = 4)

GUB cover cuts applied:  17
Cover cuts applied:  2
Flow cuts applied:  12
Mixed integer rounding cuts applied:  8
Zero-half cuts applied:  11
Lift and project cuts applied:  3
Gomory fractional cuts applied:  6

Root node processing (before b&amp;c):
  Real time             =    0.39 sec. (165.69 ticks)
Parallel b&amp;c, 8 threads:
  Real time             =    0.00 sec. (0.00 ticks)
  Sync time (average)   =    0.00 sec.
  Wait time (average)   =    0.00 sec.
                          ------------
Total (root+branch&amp;cut) =    0.39 sec. (165.69 ticks)
* model solved with objective: 28824.000
* KPI: Total salary cost=28824.000
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-6-investigate-the-solution-and-then-run-an-example-analysis">
<h3>Step 6: Investigate the solution and then run an example analysis<a class="headerlink" href="#step-6-investigate-the-solution-and-then-run-an-example-analysis" title="Permalink to this headline">&para;</a></h3>
<p>We take advantage of <em>pandas</em> to analyze the results. First we store the
solution values of the assignment variables into a new <em>pandas</em> Series.</p>
<p>Calling <code class="docutils literal"><span class="pre">solution_value</span></code> on a DOcplex variable returns its value in
the solution (provided the model has been successfully solved).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create a pandas Series containing actual shift assignment decision variables value</span>
<span class="n">s_assigned</span> <span class="o">=</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">assigned</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">solution_value</span><span class="p">)</span>

<span class="c1"># Create a pivot table by (nurses, shifts), using pandas&#39; &quot;unstack&quot; method to transform the &#39;all_shifts&#39; row index</span>
<span class="c1">#  into columns</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">s_assigned</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_shifts&#39;</span><span class="p">)</span>

<span class="c1"># Display the first few rows of the resulting pivot table</span>
<span class="n">df_res</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>all_shifts</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>31</th>
      <th>32</th>
      <th>33</th>
      <th>34</th>
      <th>35</th>
      <th>36</th>
      <th>37</th>
      <th>38</th>
      <th>39</th>
      <th>40</th>
    </tr>
    <tr>
      <th>all_nurses</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Anne</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Bethanie</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Betsy</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Cathy</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Cecilia</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows &times; 41 columns</p>
</div><div class="section" id="analyzing-how-worktime-is-distributed">
<h4>Analyzing how worktime is distributed<a class="headerlink" href="#analyzing-how-worktime-is-distributed" title="Permalink to this headline">&para;</a></h4>
<p>Let&#8217;s analyze how worktime is distributed among nurses.</p>
<p>First, we compute the global average work time as the total minimum
requirement in hours, divided by number of nurses.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">s_demand</span>  <span class="o">=</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">min_req</span> <span class="o">*</span> <span class="n">df_shifts</span><span class="o">.</span><span class="n">duration</span>
<span class="n">total_demand</span> <span class="o">=</span> <span class="n">s_demand</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">avg_worktime</span> <span class="o">=</span> <span class="n">total_demand</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_nurses</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;* theoretical average work time is {0:g} h&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avg_worktime</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>* theoretical average work time is 39 h
</pre></div>
</div>
<p>Let&#8217;s analyze the series of deviations to the average, stored in a
<em>pandas</em> Series.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># a pandas series of worktimes solution values</span>
<span class="n">s_worktime</span> <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">worktime</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">solution_value</span><span class="p">)</span>

<span class="c1"># returns a new series computed as deviation from average</span>
<span class="n">s_to_mean</span> <span class="o">=</span> <span class="n">s_worktime</span> <span class="o">-</span> <span class="n">avg_worktime</span>

<span class="c1"># take the absolute value</span>
<span class="n">s_abs_to_mean</span> <span class="o">=</span> <span class="n">s_to_mean</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">abs</span><span class="p">)</span>


<span class="n">total_to_mean</span> <span class="o">=</span> <span class="n">s_abs_to_mean</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;* the sum of absolute deviations from mean is {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_to_mean</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>* the sum of absolute deviations from mean is 58.0
</pre></div>
</div>
<p>To see how work time is distributed among nurses, print a histogram of
work time values. Note that, as all time data are integers, work times
in the solution can take only integer values.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span>import matplotlib.pyplot as plt
%matplotlib inline

# we can also plot as a histogram the distribution of worktimes
s_worktime.plot.hist(color=&#39;LightBlue&#39;)
plt.xlabel(&quot;worktime&quot;)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;matplotlib.text.Text at 0xe9e0518&gt;
</pre></div>
</div>
<img alt="_images/nurses_pandas_71_1.png" src="_images/nurses_pandas_71_1.png" />
</div>
<div class="section" id="how-shifts-are-distributed">
<h4>How shifts are distributed<a class="headerlink" href="#how-shifts-are-distributed" title="Permalink to this headline">&para;</a></h4>
<p>Let&#8217;s now analyze the solution from the <em>number of shifts</em> perspective.
How many shifts does each nurse work? Are these shifts fairly
distributed amongst nurses?</p>
<p>We compute a new column in our result DataFrame for the number of shifts
worked, by summing rows (the <em>&#8220;axis=1&#8221;</em> argument in the <em>sum()</em> call
indicates to <em>pandas</em> that each sum is performed by row instead of
column):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># a pandas series of #shifts worked</span>
<span class="n">df_worked</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="n">all_shifts</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_res</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_worked</span>

<span class="n">df_worked</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;#shifts worked&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;matplotlib.text.Text at 0xecad9e8&gt;
</pre></div>
</div>
<img alt="_images/nurses_pandas_73_1.png" src="_images/nurses_pandas_73_1.png" />
<p>We see that one nurse works significantly fewer shifts than others do.
What is the average number of shifts worked by a nurse? This is equal to
the total demand divided by the number of nurses.</p>
<p>Of course, this yields a fractional number of shifts that is not
practical, but nonetheless will help us quantify the <em>fairness</em> in shift
distribution.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">avg_worked</span> <span class="o">=</span> <span class="n">df_shifts</span><span class="p">[</span><span class="s2">&quot;min_req&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_nurses</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- expected avg #shifts worked is {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avg_worked</span><span class="p">))</span>

<span class="n">worked_to_avg</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">avg_worked</span>
<span class="n">total_to_mean</span> <span class="o">=</span> <span class="n">worked_to_avg</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">abs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- total absolute deviation to mean #shifts is {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_to_mean</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>-- expected avg #shifts worked is 6.875
-- total absolute deviation to mean #shifts is 18.75
</pre></div>
</div>
</div>
</div>
<div class="section" id="introducing-a-fairness-goal">
<h3>Introducing a fairness goal<a class="headerlink" href="#introducing-a-fairness-goal" title="Permalink to this headline">&para;</a></h3>
<p>As the above diagram suggests, the distribution of shifts could be
improved. We implement this by adding one extra objective, <em>fairness</em>,
which balances the shifts assigned over nurses.</p>
<p>Note that we can edit the model, that is add (or remove) constraints,
even after it has been solved.</p>
</div>
<div class="section" id="step-1-introduce-three-new-variables-per-nurse-to-model-the">
<h3>Step #1 : Introduce three new variables per nurse to model the<a class="headerlink" href="#step-1-introduce-three-new-variables-per-nurse-to-model-the" title="Permalink to this headline">&para;</a></h3>
<p>number of shifts worked and positive and negative deviations to the
average.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># add two extra variables per nurse: deviations above and below average</span>
<span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">make_var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;worked</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;overworked&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">make_var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;overw_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;underworked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">make_var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;underw_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2-post-the-constraint-that-links-these-variables-together">
<h3>Step #2 : Post the constraint that links these variables together.<a class="headerlink" href="#step-2-post-the-constraint-that-links-these-variables-together" title="Permalink to this headline">&para;</a></h3>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Use the pandas groupby operation to enforce the constraint calculating number of worked shifts for each nurse</span>
<span class="k">for</span> <span class="n">nurse</span><span class="p">,</span> <span class="n">nurse_assignments</span> <span class="ow">in</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_nurses&#39;</span><span class="p">):</span>
    <span class="c1"># nb of worked shifts is sum of assigned shifts</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">df_nurses</span><span class="o">.</span><span class="n">worked</span><span class="p">[</span><span class="n">nurse</span><span class="p">]</span> <span class="o">==</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_assignments</span><span class="o">.</span><span class="n">assigned</span><span class="p">))</span>

<span class="k">for</span> <span class="n">nurse</span> <span class="ow">in</span> <span class="n">df_nurses</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="c1"># nb worked is average + over - under</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">nurse</span><span class="o">.</span><span class="n">worked</span> <span class="o">==</span> <span class="n">avg_worked</span> <span class="o">+</span> <span class="n">nurse</span><span class="o">.</span><span class="n">overworked</span> <span class="o">-</span> <span class="n">nurse</span><span class="o">.</span><span class="n">underworked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-define-kpis-to-measure-the-result-after-solve">
<h3>Step #3 : Define KPIs to measure the result after solve.<a class="headerlink" href="#step-3-define-kpis-to-measure-the-result-after-solve" title="Permalink to this headline">&para;</a></h3>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># finally, define kpis for over and under average quantities</span>
<span class="n">total_overw</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;overworked&quot;</span><span class="p">])</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_overw</span><span class="p">,</span> <span class="s2">&quot;Total over-worked&quot;</span><span class="p">)</span>
<span class="n">total_underw</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df_nurses</span><span class="p">[</span><span class="s2">&quot;underworked&quot;</span><span class="p">])</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_underw</span><span class="p">,</span> <span class="s2">&quot;Total under-worked&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>DecisionKPI(name=Total under-worked,expr=underw_Jemma+underw_Nathalie+underw_Patrick+underw_Janice+underw_Janelle+underw_Cathy+underw_Roberta+underw_Jane+underw_Isabelle+underw_Anne+underw_Gloria+underw_Suzanne+underw_Dee+underw_Chris+underw_Nancy+underw_Debbie+underw_Vickie+underw_David+underw_Julie+underw_Cindy+underw_Cecilia+underw_Nicole+underw_Wendie+underw_Juliet+underw_Betsy+underw_Kate+underw_Zoe+underw_Jude+underw_Patricia+underw_Joyce+underw_Bethanie+underw_Joan)
</pre></div>
</div>
<p>Finally, let&#8217;s modify the objective by adding the sum of
<code class="docutils literal"><span class="pre">over_worked</span> <span class="pre">and</span> <span class="pre">under_worked</span></code> to the previous objective.</p>
<p><strong>Note:</strong> The definitions of <code class="docutils literal"><span class="pre">over_worked</span></code> and <code class="docutils literal"><span class="pre">under_worked</span></code> as
described above are not sufficient to give them an unambiguous value.
However, as all these variables are minimized, CPLEX ensures that these
variables take the minimum possible values in the solution.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">mdl</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">total_salary_cost</span> <span class="o">+</span> <span class="n">total_overw</span> <span class="o">+</span> <span class="n">total_underw</span><span class="p">)</span>  <span class="c1"># incorporate over_worked and under_worked in objective</span>
</pre></div>
</div>
<p>Our modified model is ready to solve. Again, enter your DOcplexcloud
<code class="docutils literal"><span class="pre">url</span></code> and <code class="docutils literal"><span class="pre">api_key</span></code> in the appropriate fields below to solve on
DOcplexcloud if you do not have a local CPLEX installation.</p>
<p>The <code class="docutils literal"><span class="pre">log_output=True</span></code> parameter tells CPLEX to print the log on the
standard output.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">sol2</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">log_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># solve again and get a new solution</span>
<span class="k">assert</span> <span class="n">sol2</span><span class="p">,</span> <span class="s2">&quot;Solve failed&quot;</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>1 of 4 MIP starts provided solutions.
MIP start &#39;m1&#39; defined initial solution with objective 28842.7500.
Tried aggregator 2 times.
MIP Presolve eliminated 995 rows and 379 columns.
MIP Presolve modified 90 coefficients.
Aggregator did 73 substitutions.
Reduced MIP has 584 rows, 988 columns, and 3902 nonzeros.
Reduced MIP has 892 binaries, 0 generals, 0 SOSs, and 0 indicators.
Presolve time = 0.02 sec. (4.12 ticks)
Probing time = 0.00 sec. (0.69 ticks)
Tried aggregator 1 time.
Reduced MIP has 584 rows, 988 columns, and 3902 nonzeros.
Reduced MIP has 892 binaries, 32 generals, 0 SOSs, and 0 indicators.
Presolve time = 0.00 sec. (1.74 ticks)
Probing time = 0.00 sec. (0.69 ticks)
Clique table members: 479.
MIP emphasis: balance optimality and feasibility.
MIP search method: dynamic search.
Parallel mode: deterministic, using up to 8 threads.
Root relaxation solution time = 0.02 sec. (7.88 ticks)

        Nodes                                         Cuts/
   Node  Left     Objective  IInf  Best Integer    Best Bound    ItCnt     Gap

*     0+    0                        28842.7500        0.0000           100.00%
      0     0    28827.9167    80    28842.7500    28827.9167      612    0.05%
      0     0    28829.1354    52    28842.7500     Cuts: 135      850    0.05%
      0     0    28830.5625    51    28842.7500     Cuts: 108     1118    0.04%
      0     0    28831.0000    53    28842.7500      Cuts: 46     1284    0.04%
*     0+    0                        28840.7500    28831.0000             0.03%
      0     0    28831.0000    27    28840.7500      Cuts: 25     1397    0.03%
      0     0    28831.0000    36    28840.7500      Cuts: 33     1521    0.03%
*     0+    0                        28840.5000    28831.0000             0.03%
      0     2    28831.0000     2    28840.5000    28831.0000     1521    0.03%
Elapsed time = 0.34 sec. (166.60 ticks, tree = 0.01 MB, solutions = 3)
*    12+   12                        28838.7500    28831.0000             0.03%
*    99+   98                        28834.5000    28831.0000             0.01%
*   152   135      integral     0    28831.0000    28831.0000    10716    0.00%

GUB cover cuts applied:  22
Cover cuts applied:  28
Flow cuts applied:  22
Mixed integer rounding cuts applied:  61
Zero-half cuts applied:  14
Lift and project cuts applied:  5
Gomory fractional cuts applied:  6

Root node processing (before b&amp;c):
  Real time             =    0.34 sec. (166.14 ticks)
Parallel b&amp;c, 8 threads:
  Real time             =    0.20 sec. (114.63 ticks)
  Sync time (average)   =    0.06 sec.
  Wait time (average)   =    0.07 sec.
                          ------------
Total (root+branch&amp;cut) =    0.55 sec. (280.77 ticks)
* model solved with objective: 28831.000
* KPI: Total salary cost=28824.000
* KPI: Total over-worked=3.500
* KPI: Total under-worked=3.500
</pre></div>
</div>
</div>
<div class="section" id="analyzing-new-results">
<h3>Analyzing new results<a class="headerlink" href="#analyzing-new-results" title="Permalink to this headline">&para;</a></h3>
<p>Let&#8217;s recompute the new total deviation from average on this new
solution.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create a pandas Series containing actual shift assignment decision variables value</span>
<span class="n">s_assigned2</span> <span class="o">=</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">assigned</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">solution_value</span><span class="p">)</span>

<span class="c1"># Create a pivot table by (nurses, shifts), using pandas&#39; &quot;unstack&quot; method to transform the &#39;all_shifts&#39; row index</span>
<span class="c1">#  into columns</span>
<span class="n">df_res2</span> <span class="o">=</span> <span class="n">s_assigned2</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_shifts&#39;</span><span class="p">)</span>

<span class="c1"># Add a new column to the pivot table containing the #shifts worked by summing over each row</span>
<span class="n">df_res2</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res2</span><span class="p">[</span><span class="n">all_shifts</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># total absolute deviation from average is directly read on expressions</span>
<span class="n">new_total_to_mean</span> <span class="o">=</span> <span class="n">total_overw</span><span class="o">.</span><span class="n">solution_value</span> <span class="o">+</span> <span class="n">total_underw</span><span class="o">.</span><span class="n">solution_value</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- total absolute deviation to mean #shifts is now {0} down from {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_total_to_mean</span><span class="p">,</span> <span class="n">total_to_mean</span><span class="p">))</span>

<span class="c1"># Display the first few rows of the result Data Frame</span>
<span class="n">df_res2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>-- total absolute deviation to mean #shifts is now 7.0 down from 18.75
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>all_shifts</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>32</th>
      <th>33</th>
      <th>34</th>
      <th>35</th>
      <th>36</th>
      <th>37</th>
      <th>38</th>
      <th>39</th>
      <th>40</th>
      <th>worked</th>
    </tr>
    <tr>
      <th>all_nurses</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Anne</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>Bethanie</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>Betsy</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>Cathy</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>Cecilia</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows &times; 42 columns</p>
</div><p>Let&#8217;s print the new histogram of shifts worked.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">df_res2</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0xef73f60&gt;
</pre></div>
</div>
<img alt="_images/nurses_pandas_89_1.png" src="_images/nurses_pandas_89_1.png" />
</div>
<div class="section" id="but-what-would-be-the-minimal-fairness-level">
<h3>But what would be the minimal fairness level?<a class="headerlink" href="#but-what-would-be-the-minimal-fairness-level" title="Permalink to this headline">&para;</a></h3>
<p>But what is the absolute minimum for the deviation to the ideal average
number of shifts? CPLEX can tell us: simply minimize only the the total
deviation from average, ignoring the salary cost. Of course this is
unrealistic, but it will help us quantify how far our fairness result is
to the absolute optimal fairness.</p>
<p>We modify the objective and solve for the third time (using the usual
necessary update for DOcplexcloud credentials).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">mdl</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">total_overw</span> <span class="o">+</span> <span class="n">total_underw</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">mdl</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;ENTER YOUR URL HERE&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ENTER YOUR KEY HERE&quot;</span><span class="p">),</span> <span class="s2">&quot;solve failed&quot;</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>* model solved with objective: 4.000
* KPI: Total salary cost=29642.000
* KPI: Total over-worked=4.000
* KPI: Total under-worked=0.000
</pre></div>
</div>
<p>In the fairness-optimal solution, we have zero under-average shifts and
4 over-average. Salary cost is now higher than the previous value of
28884 but this was expected as salary cost was not part of the
objective.</p>
<p>To summarize, the absolute minimum for this measure of fairness is 4,
and we have found a balance with fairness=7.</p>
<p>Finally, we display the histogram for this optimal-fairness solution.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create a pandas Series containing actual shift assignment decision variables value</span>
<span class="n">s_assigned_fair</span> <span class="o">=</span> <span class="n">df_assigned</span><span class="o">.</span><span class="n">assigned</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">solution_value</span><span class="p">)</span>

<span class="c1"># Create a pivot table by (nurses, shifts), using pandas&#39; &quot;unstack&quot; method to transform the &#39;all_shifts&#39; row index</span>
<span class="c1">#  into columns</span>
<span class="n">df_res_fair</span> <span class="o">=</span> <span class="n">s_assigned_fair</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;all_shifts&#39;</span><span class="p">)</span>

<span class="c1"># Add a new column to the pivot table containing the #shifts worked by summing over each row</span>
<span class="n">df_res_fair</span><span class="p">[</span><span class="s2">&quot;solution_value_fair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res_fair</span><span class="p">[</span><span class="n">all_shifts</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_res_fair</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res_fair</span><span class="p">[</span><span class="n">all_shifts</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_res_fair</span><span class="p">[</span><span class="s2">&quot;worked&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;plum&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0xf0d6fd0&gt;
</pre></div>
</div>
<img alt="_images/nurses_pandas_94_1.png" src="_images/nurses_pandas_94_1.png" />
<p>In the above figure, all nurses but one are assigned the average of 7
shifts, which is what we expected.</p>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">&para;</a></h2>
<p>You learned how to set up and use IBM Decision Optimization CPLEX
Modeling for Python to formulate a Mathematical Programming model and
solve it with IBM Decision Optimization on Cloud.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">&para;</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://rawgit.com/IBMDecisionOptimization/docplex-doc/master/docs/index.html">CPLEX Modeling for Python
documentation</a></li>
<li><a class="reference external" href="https://developer.ibm.com/docloud/">Decision Optimization on
Cloud</a></li>
<li>Need help with DOcplex or to report a bug? Please go
<a class="reference external" href="https://developer.ibm.com/answers/smartspace/docloud">here</a>.</li>
<li>Contact us at <a class="reference external" href="mailto:dofeedback&#37;&#52;&#48;wwpdl&#46;vnet&#46;ibm&#46;com">dofeedback<span>&#64;</span>wwpdl<span>&#46;</span>vnet<span>&#46;</span>ibm<span>&#46;</span>com</a>.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Nurse Assignment Problem</a><ul>
<li><a class="reference internal" href="#describe-the-business-problem">Describe the business problem</a></li>
<li><a class="reference internal" href="#how-decision-optimization-can-help">How decision optimization can help</a></li>
<li><a class="reference internal" href="#checking-minimum-requirements">Checking minimum requirements</a></li>
<li><a class="reference internal" href="#use-decision-optimization">Use decision optimization</a><ul>
<li><a class="reference internal" href="#step-1-download-the-library">Step 1: Download the library</a></li>
<li><a class="reference internal" href="#step-2-set-up-the-prescriptive-engine">Step 2: Set up the prescriptive engine</a></li>
<li><a class="reference internal" href="#step-3-model-the-data">Step 3: Model the data</a><ul>
<li><a class="reference internal" href="#loading-data-from-excel-with-pandas">Loading data from Excel with pandas</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-4-prepare-the-data">Step 4: Prepare the data</a><ul>
<li><a class="reference internal" href="#sub-step-1">Sub-step #1</a></li>
<li><a class="reference internal" href="#sub-step-2-compute-the-absolute-start-time-of-each-shift">Sub-step #2 : Compute the absolute start time of each shift.</a></li>
<li><a class="reference internal" href="#sub-step-3-compute-the-absolute-end-time-of-each-shift">Sub-Step #3 : Compute the absolute end time of each shift.</a></li>
<li><a class="reference internal" href="#sub-step-4-compute-the-duration-of-each-shift">Sub-step #4 : Compute the duration of each shift.</a></li>
<li><a class="reference internal" href="#sub-step-5-compute-the-minimum-demand-for-each-shift">Sub-step #5 : Compute the minimum demand for each shift.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-5-set-up-the-prescriptive-model">Step 5: Set up the prescriptive model</a><ul>
<li><a class="reference internal" href="#create-the-docplex-model">Create the DOcplex model</a></li>
<li><a class="reference internal" href="#define-the-decision-variables">Define the decision variables</a></li>
<li><a class="reference internal" href="#express-the-business-constraints">Express the business constraints</a><ul>
<li><a class="reference internal" href="#overlapping-shifts">Overlapping shifts</a></li>
<li><a class="reference internal" href="#vacations">Vacations</a></li>
<li><a class="reference internal" href="#associations">Associations</a></li>
<li><a class="reference internal" href="#incompatibilities">Incompatibilities</a></li>
<li><a class="reference internal" href="#constraints-on-work-time">Constraints on work time</a></li>
<li><a class="reference internal" href="#minimum-requirement-for-shifts">Minimum requirement for shifts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#express-the-objective">Express the objective</a><ul>
<li><a class="reference internal" href="#minimizing-salary-cost">Minimizing salary cost</a></li>
</ul>
</li>
<li><a class="reference internal" href="#solve-with-the-decision-optimization-solve-service">Solve with the Decision Optimization solve service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-6-investigate-the-solution-and-then-run-an-example-analysis">Step 6: Investigate the solution and then run an example analysis</a><ul>
<li><a class="reference internal" href="#analyzing-how-worktime-is-distributed">Analyzing how worktime is distributed</a></li>
<li><a class="reference internal" href="#how-shifts-are-distributed">How shifts are distributed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#introducing-a-fairness-goal">Introducing a fairness goal</a></li>
<li><a class="reference internal" href="#step-1-introduce-three-new-variables-per-nurse-to-model-the">Step #1 : Introduce three new variables per nurse to model the</a></li>
<li><a class="reference internal" href="#step-2-post-the-constraint-that-links-these-variables-together">Step #2 : Post the constraint that links these variables together.</a></li>
<li><a class="reference internal" href="#step-3-define-kpis-to-measure-the-result-after-solve">Step #3 : Define KPIs to measure the result after solve.</a></li>
<li><a class="reference internal" href="#analyzing-new-results">Analyzing new results</a></li>
<li><a class="reference internal" href="#but-what-would-be-the-minimal-fairness-level">But what would be the minimal fairness level?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016-2017, IBM&reg;.
    </div>
  </body>
</html>