

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>The Nurses Model &#8212; DOcplex.MP: Mathematical Programming Modeling for Python V2.21 documentation</title>
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Maximizing the profit of an oil company" href="oil_blending.html" />
    <link rel="prev" title="The Nurse Assignment Problem" href="nurses_pandas.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="oil_blending.html" title="Maximizing the profit of an oil company"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="nurses_pandas.html" title="The Nurse Assignment Problem"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.21 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="samples.html" accesskey="U">Examples of mathematical programming</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Nurses Model</a><ul>
<li><a class="reference internal" href="#describe-the-business-problem">Describe the business problem</a></li>
<li><a class="reference internal" href="#how-decision-optimization-can-help">How decision optimization can help</a></li>
<li><a class="reference internal" href="#use-decision-optimization">Use decision optimization</a><ul>
<li><a class="reference internal" href="#step-1-import-the-library">Step 1: Import the library</a></li>
<li><a class="reference internal" href="#step-2-model-the-data">Step 2: Model the data</a></li>
<li><a class="reference internal" href="#step-3-prepare-the-data">Step 3: Prepare the data</a><ul>
<li><a class="reference internal" href="#loading-data-from-excel-with-pandas">Loading data from Excel with pandas</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-4-set-up-the-prescriptive-model">Step 4: Set up the prescriptive model</a><ul>
<li><a class="reference internal" href="#create-the-docplex-model">Create the DOcplex model</a></li>
<li><a class="reference internal" href="#define-the-decision-variables">Define the decision variables</a></li>
<li><a class="reference internal" href="#express-the-business-constraints">Express the business constraints</a><ul>
<li><a class="reference internal" href="#first-constraint-define-average-work-time">First constraint: define average work time</a></li>
<li><a class="reference internal" href="#second-constraint-compute-nurse-work-time-average-and-under-over-time">Second constraint: compute nurse work time, average and under/over time</a></li>
<li><a class="reference internal" href="#third-constraint-vacations">Third constraint: vacations</a></li>
<li><a class="reference internal" href="#fourth-constraint-a-nurse-cannot-be-assigned-overlapping-shifts">Fourth constraint: a nurse cannot be assigned overlapping shifts</a></li>
<li><a class="reference internal" href="#fifth-constraint-enforce-minimum-and-maximum-requirements-for-shifts">Fifth constraint: enforce minimum and maximum requirements for shifts</a></li>
<li><a class="reference internal" href="#sixth-constraint-enforce-skill-requirements-for-selected-shifts">Sixth constraint: enforce skill requirements for selected shifts</a></li>
<li><a class="reference internal" href="#seventh-constraint-associations">Seventh constraint: associations</a></li>
<li><a class="reference internal" href="#eighth-constraint-incompatibilities">Eighth constraint: incompatibilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#express-the-objective">Express the objective</a><ul>
<li><a class="reference internal" href="#minimizing-objective">Minimizing objective</a></li>
</ul>
</li>
<li><a class="reference internal" href="#solve-with-decision-optimization">Solve with Decision Optimization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-5-investigate-the-solution-and-then-run-an-example-analysis">Step 5: Investigate the solution and then run an example analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="nurses_pandas.html"
                        title="previous chapter">The Nurse Assignment Problem</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="oil_blending.html"
                        title="next chapter">Maximizing the profit of an oil company</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-nurses-model">
<h1>The Nurses Model<a class="headerlink" href="#the-nurses-model" title="Permalink to this headline">&para;</a></h1>
<p>This tutorial includes everything you need to set up IBM Decision
Optimization CPLEX Modeling for Python (DOcplex), build a Mathematical
Programming model, and get its solution by solving the model on the
cloud with IBM ILOG CPLEX Optimizer.</p>
<p>When you finish this tutorial, you&#8217;ll have a foundational knowledge of
<em>Prescriptive Analytics</em>.</p>
<blockquote>
<div><p>This notebook is part of <a class="reference external" href="http://ibmdecisionoptimization.github.io/docplex-doc/">Prescriptive Analytics for
Python</a></p>
<p>It requires either an <a class="reference external" href="http://ibmdecisionoptimization.github.io/docplex-doc/getting_started.html">installation of CPLEX
Optimizers</a>
or it can be run on <a class="reference external" href="https://www.ibm.com/cloud/watson-studio/">IBM Watson Studio
Cloud</a> (Sign up for a
<a class="reference external" href="https://dataplatform.cloud.ibm.com/registration/stepone?context=wdp&amp;apps=all%3E">free IBM Cloud
account</a>
and you can start using Watson Studio Cloud right away).</p>
</div></blockquote>
<p>Table of contents:</p>
<ul class="simple">
<li><a class="reference internal" href="#describe-the-business-problem">Describe the business problem</a></li>
<li><a class="reference internal" href="#how-decision-optimization-can-help">How  decision optimization can help</a></li>
<li><a class="reference internal" href="#use-decision-optimization">Use decision optimization</a><ul>
<li><a class="reference internal" href="#step-1-import-the-library">Step 1: Import the library</a></li>
<li><a class="reference internal" href="#step-2-model-the-data">Step 2: Model the data</a></li>
<li><a class="reference internal" href="#step-3-prepare-the-data">Step 3: Prepare the data</a></li>
<li><a class="reference internal" href="#step-4-set-up-the-prescriptive-model">Step 4: Set up the prescriptive model</a><ul>
<li><a class="reference internal" href="#define-the-decision-variables">Define the decision variables</a></li>
<li><a class="reference internal" href="#express-the-business-constraints">Express the business constraints</a></li>
<li><a class="reference internal" href="#express-the-objective">Express the objective</a></li>
<li><a class="reference internal" href="#solve-with-decision-optimization">Solve with Decision Optimization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-5-investigate-the-solution-and-then-run-an-example-analysis">Step 5: Investigate the solution and then run an example analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
<hr class="docutils" />
<div class="section" id="describe-the-business-problem">
<h2>Describe the business problem<a class="headerlink" href="#describe-the-business-problem" title="Permalink to this headline">&para;</a></h2>
<p>This model deals with nurse scheduling. Nurses must be assigned to
hospital shifts in accordance with various skill and staffing
constraints.</p>
<p>The goal of the model is to find an efficient balance between the
different objectives:</p>
<ul class="simple">
<li>minimize the overall cost of the plan and</li>
<li>assign shifts as fairly as possible.</li>
</ul>
</div>
<div class="section" id="how-decision-optimization-can-help">
<h2>How decision optimization can help<a class="headerlink" href="#how-decision-optimization-can-help" title="Permalink to this headline">&para;</a></h2>
<ul>
<li><p class="first">Prescriptive analytics (decision optimization) technology recommends
actions that are based on desired outcomes. It takes into account
specific scenarios, resources, and knowledge of past and current
events. With this insight, your organization can make better
decisions and have greater control of business outcomes.</p>
</li>
<li><p class="first">Prescriptive analytics is the next step on the path to insight-based
actions. It creates value through synergy with predictive analytics,
which analyzes data to predict future outcomes.</p>
</li>
<li><div class="first line-block">
<div class="line">Prescriptive analytics takes that insight to the next level by
suggesting the optimal way to handle that future situation.
Organizations that can act fast in dynamic conditions and make
superior decisions in uncertain environments gain a strong
competitive advantage.</div>
<div class="line"><br /></div>
</div>
</li>
</ul>
<p>With prescriptive analytics, you can:</p>
<ul class="simple">
<li>Automate the complex decisions and trade-offs to better manage your
limited resources.</li>
<li>Take advantage of a future opportunity or mitigate a future risk.</li>
<li>Proactively update recommendations based on changing events.</li>
<li>Meet operational goals, increase customer loyalty, prevent threats
and fraud, and optimize business processes.</li>
</ul>
</div>
<div class="section" id="use-decision-optimization">
<h2>Use decision optimization<a class="headerlink" href="#use-decision-optimization" title="Permalink to this headline">&para;</a></h2>
<div class="section" id="step-1-import-the-library">
<h3>Step 1: Import the library<a class="headerlink" href="#step-1-import-the-library" title="Permalink to this headline">&para;</a></h3>
<p>Run the following code to import Decision Optimization CPLEX Modeling
library. The <em>DOcplex</em> library contains the two modeling packages,
Mathematical Programming and Constraint Programming.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">docplex.mp</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Please install docplex. See https://pypi.org/project/docplex/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2-model-the-data">
<h3>Step 2: Model the data<a class="headerlink" href="#step-2-model-the-data" title="Permalink to this headline">&para;</a></h3>
<p>Input data consists of several tables:</p>
<ul class="simple">
<li>The Departments table lists all departments in the scope of the
assignment.</li>
<li>The Skills table list all skills.</li>
<li>The Shifts table lists all shifts to be staffed. A shift contains a
department, a day in the week, plus the start and end times.</li>
<li>The Nurses table lists all nurses, identified by their names.</li>
<li>The NurseSkills table gives the skills of each nurse.</li>
<li>The SkillRequirements table lists the minimum number of persons
required for a given department and skill.</li>
<li>The NurseVacations table lists days off for each nurse.</li>
<li>The NurseAssociations table lists pairs of nurses who wish to work
together.</li>
<li>The NurseIncompatibilities table lists pairs of nurses who do not
want to work together . In addition, the plan has to satisfy a
maximum worktime for all nurses, for example 40 hours a week.</li>
</ul>
</div>
<div class="section" id="step-3-prepare-the-data">
<h3>Step 3: Prepare the data<a class="headerlink" href="#step-3-prepare-the-data" title="Permalink to this headline">&para;</a></h3>
<p>Now we need some basic data structures to store information.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="c1"># utility to conevrt a weekday string to an index in 0..6</span>
<span class="n">_all_days</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;monday&quot;</span><span class="p">,</span> <span class="s2">&quot;tuesday&quot;</span><span class="p">,</span> <span class="s2">&quot;wednesday&quot;</span><span class="p">,</span> <span class="s2">&quot;thursday&quot;</span><span class="p">,</span> <span class="s2">&quot;friday&quot;</span><span class="p">,</span> <span class="s2">&quot;saturday&quot;</span><span class="p">,</span> <span class="s2">&quot;sunday&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">day_to_day_week</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">day_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">day</span><span class="p">:</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_all_days</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">day_map</span><span class="p">[</span><span class="n">day</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">TWorkRules</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TWorkRules&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;work_time_max&quot;</span><span class="p">])</span>
<span class="n">TVacation</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TVacation&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nurse&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">])</span>
<span class="n">TNursePair</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TNursePair&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;firstNurse&quot;</span><span class="p">,</span> <span class="s2">&quot;secondNurse&quot;</span><span class="p">])</span>
<span class="n">TNurseSkill</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TNurseSkill&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nurse&quot;</span><span class="p">,</span> <span class="s2">&quot;skill&quot;</span><span class="p">])</span>
<span class="n">TSkillRequirement</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TSkillRequirement&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;skill&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">])</span>


<span class="c1"># subclass the namedtuple to refine the str() method as the nurse&#39;s name</span>
<span class="k">class</span> <span class="nc">TNurse</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TNurse1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;pay_rate&quot;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot; A subclass to redefine the default str() of namedtuple.</span>
<span class="sd">    This class is used in variable naming, so we need to redefine the str() method</span>
<span class="sd">    used by variable naming.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">TShift</span><span class="p">(</span>
    <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TShift1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;end_time&quot;</span><span class="p">,</span> <span class="s2">&quot;min_requirement&quot;</span><span class="p">,</span> <span class="s2">&quot;max_requirement&quot;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot; specialize namedtuple to redefine its str() method</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># keep first two characters in departement, uppercased</span>
        <span class="n">dept2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">department</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># keep 3 days of weekday</span>
        <span class="n">dayname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dept2</span><span class="p">,</span> <span class="n">dayname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ShiftActivity</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_abstime</span><span class="p">(</span><span class="n">day_index</span><span class="p">,</span> <span class="n">time_of_day</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert a pair (day_index, time) into a number of hours since Monday 00:00</span>

<span class="sd">        :param day_index: The index of the day from 1 to 7 (Monday is 1).</span>
<span class="sd">        :param time_of_day: An integer number of hours.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">+=</span> <span class="n">time_of_day</span>
        <span class="k">return</span> <span class="n">time</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weekday</span><span class="p">,</span> <span class="n">start_time_of_day</span><span class="p">,</span> <span class="n">end_time_of_day</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">start_time_of_day</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">start_time_of_day</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">end_time_of_day</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">end_time_of_day</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_weekday</span> <span class="o">=</span> <span class="n">weekday</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time_of_day</span> <span class="o">=</span> <span class="n">start_time_of_day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_time_of_day</span> <span class="o">=</span> <span class="n">end_time_of_day</span>
        <span class="c1"># conversion to absolute time.</span>
        <span class="n">start_day_index</span> <span class="o">=</span> <span class="n">day_to_day_week</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekday</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_abstime</span><span class="p">(</span><span class="n">start_day_index</span><span class="p">,</span> <span class="n">start_time_of_day</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_abstime</span><span class="p">(</span><span class="n">start_day_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">end_day_index</span> <span class="o">=</span> <span class="n">start_day_index</span> <span class="k">if</span> <span class="n">end_time_of_day</span> <span class="o">&gt;</span> <span class="n">start_time_of_day</span> <span class="k">else</span> <span class="n">start_day_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_abstime</span><span class="p">(</span><span class="n">end_day_index</span><span class="p">,</span> <span class="n">end_time_of_day</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="k">def</span> <span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_shift</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_shift</span><span class="p">,</span> <span class="n">ShiftActivity</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other_shift</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="n">other_shift</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span>
</pre></div>
</div>
<div class="section" id="loading-data-from-excel-with-pandas">
<h4>Loading data from Excel with pandas<a class="headerlink" href="#loading-data-from-excel-with-pandas" title="Permalink to this headline">&para;</a></h4>
<p>We load the data from an Excel file using <em>pandas</em>. Each sheet is read
into a separate <em>pandas</em> DataFrame.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">body {</span>
<span class="s2">    margin: 0;</span>
<span class="s2">    font-family: Helvetica;</span>
<span class="s2">}</span>
<span class="s2">table.dataframe {</span>
<span class="s2">    border-collapse: collapse;</span>
<span class="s2">    border: none;</span>
<span class="s2">}</span>
<span class="s2">table.dataframe tr {</span>
<span class="s2">    border: none;</span>
<span class="s2">}</span>
<span class="s2">table.dataframe td, table.dataframe th {</span>
<span class="s2">    margin: 0;</span>
<span class="s2">    border: 1px solid white;</span>
<span class="s2">    padding-left: 0.25em;</span>
<span class="s2">    padding-right: 0.25em;</span>
<span class="s2">}</span>
<span class="s2">table.dataframe th:not(:empty) {</span>
<span class="s2">    background-color: #fec;</span>
<span class="s2">    text-align: left;</span>
<span class="s2">    font-weight: normal;</span>
<span class="s2">}</span>
<span class="s2">table.dataframe tr:nth-child(2) th:empty {</span>
<span class="s2">    border-left: none;</span>
<span class="s2">    border-right: 1px dashed #888;</span>
<span class="s2">}</span>
<span class="s2">table.dataframe td {</span>
<span class="s2">    border: 2px solid #ccf;</span>
<span class="s2">    background-color: #f4f4ff;</span>
<span class="s2">}</span>
<span class="s2">    table.dataframe thead th:first-child {</span>
<span class="s2">        display: none;</span>
<span class="s2">    }</span>
<span class="s2">    table.dataframe tbody th {</span>
<span class="s2">        display: none;</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="k">import</span> <span class="n">HTML</span>
<span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;&lt;style&gt;</span><span class="si">{}</span><span class="s1">&lt;/style&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CSS</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span>
</pre></div>
</div>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
</pre></div>
</div>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span># This notebook requires pandas to work
import pandas as pd

# Make sure that xlrd package, which is a pandas optional dependency, is installed
# This package is required for Excel I/O
try:
    import xlrd
except:
    if hasattr(sys, &#39;real_prefix&#39;):
        #we are in a virtual env.
        !pip install xlrd
    else:
        !pip install --user xlrd

data_url = &quot;https://github.com/IBMDecisionOptimization/docplex-examples/blob/master/examples/mp/jupyter/nurses_data.xls?raw=true&quot;
nurse_xls_file = pd.ExcelFile(data_url)

SkillTable = nurse_xls_file.parse(&#39;Skills&#39;)
DeptTable  = nurse_xls_file.parse(&#39;Departments&#39;)
ShiftTable = nurse_xls_file.parse(&#39;Shifts&#39;)
SkillRequirementTable = nurse_xls_file.parse(&#39;SkillRequirements&#39;)
NurseTable = nurse_xls_file.parse(&#39;Nurses&#39;)
NurseSkillTable = nurse_xls_file.parse(&#39;NurseSkills&#39;)
NurseVacationTable = nurse_xls_file.parse(&#39;NurseVacations&#39;)
NurseAssociationTable = nurse_xls_file.parse(&#39;NurseAssociations&#39;)
NurseIncompatibilityTable = nurse_xls_file.parse(&#39;NurseIncompatibilities&#39;)

display(NurseTable)
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>seniority</th>
      <th>qualification</th>
      <th>pay_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>Anne</td>
      <td>11</td>
      <td>1</td>
      <td>25</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Bethanie</td>
      <td>4</td>
      <td>5</td>
      <td>28</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Betsy</td>
      <td>2</td>
      <td>2</td>
      <td>17</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Cathy</td>
      <td>2</td>
      <td>2</td>
      <td>17</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Cecilia</td>
      <td>9</td>
      <td>5</td>
      <td>38</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Chris</td>
      <td>11</td>
      <td>4</td>
      <td>38</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Cindy</td>
      <td>5</td>
      <td>2</td>
      <td>21</td>
    </tr>
    <tr>
      <td>7</td>
      <td>David</td>
      <td>1</td>
      <td>2</td>
      <td>15</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Debbie</td>
      <td>7</td>
      <td>2</td>
      <td>24</td>
    </tr>
    <tr>
      <td>9</td>
      <td>Dee</td>
      <td>3</td>
      <td>3</td>
      <td>21</td>
    </tr>
    <tr>
      <td>10</td>
      <td>Gloria</td>
      <td>8</td>
      <td>2</td>
      <td>25</td>
    </tr>
    <tr>
      <td>11</td>
      <td>Isabelle</td>
      <td>3</td>
      <td>1</td>
      <td>16</td>
    </tr>
    <tr>
      <td>12</td>
      <td>Jane</td>
      <td>3</td>
      <td>4</td>
      <td>23</td>
    </tr>
    <tr>
      <td>13</td>
      <td>Janelle</td>
      <td>4</td>
      <td>3</td>
      <td>22</td>
    </tr>
    <tr>
      <td>14</td>
      <td>Janice</td>
      <td>2</td>
      <td>2</td>
      <td>17</td>
    </tr>
    <tr>
      <td>15</td>
      <td>Jemma</td>
      <td>2</td>
      <td>4</td>
      <td>22</td>
    </tr>
    <tr>
      <td>16</td>
      <td>Joan</td>
      <td>5</td>
      <td>3</td>
      <td>24</td>
    </tr>
    <tr>
      <td>17</td>
      <td>Joyce</td>
      <td>8</td>
      <td>3</td>
      <td>29</td>
    </tr>
    <tr>
      <td>18</td>
      <td>Jude</td>
      <td>4</td>
      <td>3</td>
      <td>22</td>
    </tr>
    <tr>
      <td>19</td>
      <td>Julie</td>
      <td>6</td>
      <td>2</td>
      <td>22</td>
    </tr>
    <tr>
      <td>20</td>
      <td>Juliet</td>
      <td>7</td>
      <td>4</td>
      <td>31</td>
    </tr>
    <tr>
      <td>21</td>
      <td>Kate</td>
      <td>5</td>
      <td>3</td>
      <td>24</td>
    </tr>
    <tr>
      <td>22</td>
      <td>Nancy</td>
      <td>8</td>
      <td>4</td>
      <td>32</td>
    </tr>
    <tr>
      <td>23</td>
      <td>Nathalie</td>
      <td>9</td>
      <td>5</td>
      <td>38</td>
    </tr>
    <tr>
      <td>24</td>
      <td>Nicole</td>
      <td>0</td>
      <td>2</td>
      <td>14</td>
    </tr>
    <tr>
      <td>25</td>
      <td>Patricia</td>
      <td>1</td>
      <td>1</td>
      <td>13</td>
    </tr>
    <tr>
      <td>26</td>
      <td>Patrick</td>
      <td>6</td>
      <td>1</td>
      <td>19</td>
    </tr>
    <tr>
      <td>27</td>
      <td>Roberta</td>
      <td>3</td>
      <td>5</td>
      <td>26</td>
    </tr>
    <tr>
      <td>28</td>
      <td>Suzanne</td>
      <td>5</td>
      <td>1</td>
      <td>18</td>
    </tr>
    <tr>
      <td>29</td>
      <td>Vickie</td>
      <td>7</td>
      <td>1</td>
      <td>20</td>
    </tr>
    <tr>
      <td>30</td>
      <td>Wendie</td>
      <td>5</td>
      <td>2</td>
      <td>21</td>
    </tr>
    <tr>
      <td>31</td>
      <td>Zoe</td>
      <td>8</td>
      <td>3</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div><p>Now, we create some additional data structures to be used for building
the prescriptive model. The goal is to not depend on <em>pandas</em> when
defining decision variables and constraints. The &#8216;nurses_pandas&#8217;
notebook illustrates how to benefit from pandas to build the
prescriptive model.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">skills</span> <span class="o">=</span> <span class="p">[</span><span class="n">SkillTable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SkillTable</span><span class="p">))]</span>
<span class="n">depts</span>  <span class="o">=</span> <span class="p">[</span><span class="n">DeptTable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DeptTable</span><span class="p">))]</span>
<span class="n">nurses</span> <span class="o">=</span><span class="p">[</span><span class="n">TNurse</span><span class="p">(</span><span class="n">NurseTable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">NurseTable</span><span class="p">[</span><span class="s2">&quot;pay_rate&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">NurseTable</span><span class="p">))]</span>

<span class="n">nurses</span> <span class="o">=</span> <span class="p">[</span><span class="n">nurse</span> <span class="k">for</span> <span class="n">nurse</span> <span class="ow">in</span> <span class="n">nurses</span> <span class="k">if</span> <span class="n">nurse</span><span class="o">.</span><span class="n">pay_rate</span> <span class="o">&lt;</span><span class="mi">25</span> <span class="ow">and</span> <span class="n">nurse</span><span class="o">.</span><span class="n">pay_rate</span> <span class="o">&gt;</span><span class="mi">15</span><span class="p">]</span>
<span class="c1"># Build {nurse: [skills]} dictionary</span>
<span class="n">nurse_skills</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">nsk</span> <span class="ow">in</span> <span class="n">NurseSkillTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nskt</span><span class="o">=</span> <span class="n">TNurseSkill</span><span class="p">(</span><span class="o">*</span><span class="n">nsk</span><span class="p">)</span>
    <span class="n">nurse_skills</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">nskt</span><span class="o">.</span><span class="n">nurse</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nskt</span><span class="o">.</span><span class="n">skill</span><span class="p">)</span>

<span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="n">TShift</span><span class="p">(</span><span class="o">*</span><span class="n">shift_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">shift_row</span> <span class="ow">in</span> <span class="n">ShiftTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">skill_requirements</span> <span class="o">=</span> <span class="p">[</span><span class="n">TSkillRequirement</span><span class="p">(</span><span class="o">*</span><span class="n">skill_requirement_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">skill_requirement_row</span> <span class="ow">in</span>
                      <span class="n">SkillRequirementTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">vacations</span> <span class="o">=</span> <span class="p">[</span><span class="n">TVacation</span><span class="p">(</span><span class="o">*</span><span class="n">vacation_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">vacation_row</span> <span class="ow">in</span> <span class="n">NurseVacationTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">nurse_associations</span> <span class="o">=</span> <span class="p">[</span><span class="n">TNursePair</span><span class="p">(</span><span class="o">*</span><span class="n">na</span><span class="p">)</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">NurseAssociationTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">nurse_incompatibilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">TNursePair</span><span class="p">(</span><span class="o">*</span><span class="n">na</span><span class="p">)</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">NurseIncompatibilityTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

<span class="c1"># compute shift activities (start, end, duration) and store them in a dict indexed by shifts</span>
<span class="n">shift_activities</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">ShiftActivity</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">}</span>

<span class="c1"># map from nurse names to nurse tuples.</span>
<span class="n">nurses_by_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">}</span>

<span class="c1"># Work rules: max work time</span>
<span class="n">work_rules</span> <span class="o">=</span> <span class="n">TWorkRules</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-4-set-up-the-prescriptive-model">
<h3>Step 4: Set up the prescriptive model<a class="headerlink" href="#step-4-set-up-the-prescriptive-model" title="Permalink to this headline">&para;</a></h3>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.environment</span> <span class="k">import</span> <span class="n">Environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<pre class="literal-block">
* system is: Windows 64bit
* Python version 3.7.3, located at: c:\local\python373\python.exe
* docplex is present, version is (2, 11, 0)
* pandas is present, version is 0.25.1
</pre>
<div class="section" id="create-the-docplex-model">
<h4>Create the DOcplex model<a class="headerlink" href="#create-the-docplex-model" title="Permalink to this headline">&para;</a></h4>
<p>This model contains all the business constraints and defines the
objective.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docplex.mp.model</span> <span class="k">import</span> <span class="n">Model</span>

<span class="n">mdl</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="s2">&quot;nurses&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="define-the-decision-variables">
<h4>Define the decision variables<a class="headerlink" href="#define-the-decision-variables" title="Permalink to this headline">&para;</a></h4>
<p>The basic decisions are &#8220;which nurse works which shift&#8221;, which is
modeled by binary variables for each (nurse, shift) pair.</p>
<p>The output of the model is, for each shift, the list of nurses that work
the shift.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># One binary variable for each pair (nurse, shift) equal to 1 if nurse n is assigned to shift s</span>
<span class="n">nurse_assignment_vars</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">binary_var_matrix</span><span class="p">(</span><span class="n">nurses</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="s1">&#39;NurseAssigned&#39;</span><span class="p">)</span>

<span class="c1"># For each nurse, allocate one variable for worktime</span>
<span class="n">nurse_work_time_vars</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">continuous_var_dict</span><span class="p">(</span><span class="n">nurses</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;NurseWorkTime&#39;</span><span class="p">)</span>

<span class="c1"># And two variables for over_average and under-average work time</span>
<span class="n">nurse_over_average_time_vars</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">continuous_var_dict</span><span class="p">(</span><span class="n">nurses</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;NurseOverAverageWorkTime&#39;</span><span class="p">)</span>
<span class="n">nurse_under_average_time_vars</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">continuous_var_dict</span><span class="p">(</span><span class="n">nurses</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;NurseUnderAverageWorkTime&#39;</span><span class="p">)</span>

<span class="c1"># Finally the global average work time</span>
<span class="n">average_nurse_work_time</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">continuous_var</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;AverageWorkTime&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="express-the-business-constraints">
<h4>Express the business constraints<a class="headerlink" href="#express-the-business-constraints" title="Permalink to this headline">&para;</a></h4>
<div class="section" id="first-constraint-define-average-work-time">
<h5>First constraint: define average work time<a class="headerlink" href="#first-constraint-define-average-work-time" title="Permalink to this headline">&para;</a></h5>
<p>The average work time over all nurses will be used in particular to
calculate the over/under average work time for each nurse, and to
formulate a <em>fairness</em> rule.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nurses</span><span class="p">)</span> <span class="o">*</span> <span class="n">average_nurse_work_time</span> <span class="o">==</span>
                   <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_work_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">),</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docplex</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">LinearConstraint</span><span class="p">[</span><span class="n">average</span><span class="p">](</span><span class="mi">18</span><span class="n">AverageWorkTime</span><span class="p">,</span><span class="n">EQ</span><span class="p">,</span><span class="n">NurseWorkTime_Betsy</span><span class="o">+</span><span class="n">NurseWorkTime_Cathy</span><span class="o">+</span><span class="n">NurseWorkTime_Cindy</span><span class="o">+</span><span class="n">NurseWorkTime_Debbie</span><span class="o">+</span><span class="n">NurseWorkTime_Dee</span><span class="o">+</span><span class="n">NurseWorkTime_Isabelle</span><span class="o">+</span><span class="n">NurseWorkTime_Jane</span><span class="o">+</span><span class="n">NurseWorkTime_Janelle</span><span class="o">+</span><span class="n">NurseWorkTime_Janice</span><span class="o">+</span><span class="n">NurseWorkTime_Jemma</span><span class="o">+</span><span class="n">NurseWorkTime_Joan</span><span class="o">+</span><span class="n">NurseWorkTime_Jude</span><span class="o">+</span><span class="n">NurseWorkTime_Julie</span><span class="o">+</span><span class="n">NurseWorkTime_Kate</span><span class="o">+</span><span class="n">NurseWorkTime_Patrick</span><span class="o">+</span><span class="n">NurseWorkTime_Suzanne</span><span class="o">+</span><span class="n">NurseWorkTime_Vickie</span><span class="o">+</span><span class="n">NurseWorkTime_Wendie</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="second-constraint-compute-nurse-work-time-average-and-under-over-time">
<h5>Second constraint: compute nurse work time, average and under/over time<a class="headerlink" href="#second-constraint-compute-nurse-work-time-average-and-under-over-time" title="Permalink to this headline">&para;</a></h5>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">:</span>
    <span class="n">work_time_var</span> <span class="o">=</span> <span class="n">nurse_work_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
        <span class="n">work_time_var</span> <span class="o">==</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">shift_activities</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">),</span>
        <span class="s2">&quot;work_time_</span><span class="si">{0!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># Relate over/under average worktime variables to the worktime variables.</span>
    <span class="c1"># The trick here is that variables have zero lower bound</span>
    <span class="c1"># however, these variables are not completely defined by this constraint,</span>
    <span class="c1"># only their difference is.</span>
    <span class="c1"># If these variables are part of the objective, CPLEX will naturally minimize their value,</span>
    <span class="c1"># as expected.</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
        <span class="n">work_time_var</span> <span class="o">==</span> <span class="n">average_nurse_work_time</span> <span class="o">+</span> <span class="n">nurse_over_average_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">nurse_under_average_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
        <span class="s2">&quot;average_work_time_</span><span class="si">{0!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># State the maximum work time as a constraint, so that it can be relaxed,</span>
    <span class="c1"># should the problem become infeasible.</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">work_time_var</span> <span class="o">&lt;=</span> <span class="n">work_rules</span><span class="o">.</span><span class="n">work_time_max</span><span class="p">,</span> <span class="s2">&quot;max_time_</span><span class="si">{0!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="third-constraint-vacations">
<h5>Third constraint: vacations<a class="headerlink" href="#third-constraint-vacations" title="Permalink to this headline">&para;</a></h5>
<p>When a nurse is on vacation, he or she cannot be assigned to any shift
starting that day.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">vac_nurse_id</span><span class="p">,</span> <span class="n">vac_day</span> <span class="ow">in</span> <span class="n">vacations</span><span class="p">:</span>
        <span class="n">vac_n</span> <span class="o">=</span> <span class="n">nurses_by_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vac_nurse_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vac_n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">vac_day</span><span class="p">):</span>
                <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">vac_n</span><span class="p">,</span> <span class="n">shift</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                     <span class="s2">&quot;medium_vacations_</span><span class="si">{0!s}</span><span class="s2">_</span><span class="si">{1!s}</span><span class="s2">_</span><span class="si">{2!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vac_n</span><span class="p">,</span> <span class="n">vac_day</span><span class="p">,</span> <span class="n">shift</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="fourth-constraint-a-nurse-cannot-be-assigned-overlapping-shifts">
<h5>Fourth constraint: a nurse cannot be assigned overlapping shifts<a class="headerlink" href="#fourth-constraint-a-nurse-cannot-be-assigned-overlapping-shifts" title="Permalink to this headline">&para;</a></h5>
<p>Some shifts overlap in time and thus cannot be assigned to the same
nurse.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Post only one constraint per couple(s1, s2)</span>
<span class="n">number_of_overlaps</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">nb_shifts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_shifts</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb_shifts</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shift_activities</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">shift_activities</span><span class="p">[</span><span class="n">s2</span><span class="p">]):</span>
            <span class="n">number_of_overlaps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">:</span>
                <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">s1</span><span class="p">]</span> <span class="o">+</span> <span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">s2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;high_overlapping_</span><span class="si">{0!s}</span><span class="s2">_</span><span class="si">{1!s}</span><span class="s2">_</span><span class="si">{2!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# overlapping shifts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_of_overlaps</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># overlapping shifts: 20</span>
</pre></div>
</div>
</div>
<div class="section" id="fifth-constraint-enforce-minimum-and-maximum-requirements-for-shifts">
<h5>Fifth constraint: enforce minimum and maximum requirements for shifts<a class="headerlink" href="#fifth-constraint-enforce-minimum-and-maximum-requirements-for-shifts" title="Permalink to this headline">&para;</a></h5>
<p>Each shift requires a minimum and a maximum number of nurses. For each
shift, the sum over all nurses of assignments to this shift must be
greater than or equal to the minimum requirement and lesser than or
equal to the maximum requirement.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
    <span class="n">demand_min</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">min_requirement</span>
    <span class="n">demand_max</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max_requirement</span>
    <span class="n">total_assigned</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">)</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">total_assigned</span> <span class="o">&gt;=</span> <span class="n">demand_min</span><span class="p">,</span>
                       <span class="s2">&quot;high_req_min_</span><span class="si">{0!s}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">demand_min</span><span class="p">))</span>
    <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">total_assigned</span> <span class="o">&lt;=</span> <span class="n">demand_max</span><span class="p">,</span>
                       <span class="s2">&quot;medium_req_max_</span><span class="si">{0!s}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">demand_max</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="sixth-constraint-enforce-skill-requirements-for-selected-shifts">
<h5>Sixth constraint: enforce skill requirements for selected shifts<a class="headerlink" href="#sixth-constraint-enforce-skill-requirements-for-selected-shifts" title="Permalink to this headline">&para;</a></h5>
<p>Some shifts require at least <em>x</em> nurses with a specified skill.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">dept</span><span class="p">,</span> <span class="n">skill</span><span class="p">,</span> <span class="n">required</span><span class="p">)</span> <span class="ow">in</span> <span class="n">skill_requirements</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">required</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dsh</span> <span class="ow">in</span> <span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span> <span class="k">if</span> <span class="n">dept</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">department</span><span class="p">):</span>
            <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">skilled_nurse</span><span class="p">,</span> <span class="n">dsh</span><span class="p">]</span> <span class="k">for</span> <span class="n">skilled_nurse</span> <span class="ow">in</span>
                                       <span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">nurse_skills</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>
                                        <span class="n">skill</span> <span class="ow">in</span> <span class="n">nurse_skills</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span> <span class="o">&gt;=</span> <span class="n">required</span><span class="p">,</span>
                               <span class="s2">&quot;high_required_</span><span class="si">{0!s}</span><span class="s2">_</span><span class="si">{1!s}</span><span class="s2">_</span><span class="si">{2!s}</span><span class="s2">_</span><span class="si">{3!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dept</span><span class="p">,</span> <span class="n">skill</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">dsh</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="seventh-constraint-associations">
<h5>Seventh constraint: associations<a class="headerlink" href="#seventh-constraint-associations" title="Permalink to this headline">&para;</a></h5>
<p>Some pairs of nurses get along particularly well, so we wish to assign
them together as a team. In other words, for every such pair and for
each shift, both assignment variables should always be equal. Either
both nurses work the shift, or both do not.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each pair of associted nurses, their assignement variables are equal over all shifts.</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="p">(</span><span class="n">nurse_id1</span><span class="p">,</span> <span class="n">nurse_id2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">nurse_associations</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">nurse_id1</span> <span class="ow">in</span> <span class="n">nurses_by_id</span> <span class="ow">and</span> <span class="n">nurse_id2</span> <span class="ow">in</span> <span class="n">nurses_by_id</span><span class="p">:</span>
        <span class="n">nurse1</span> <span class="o">=</span> <span class="n">nurses_by_id</span><span class="p">[</span><span class="n">nurse_id1</span><span class="p">]</span>
        <span class="n">nurse2</span> <span class="o">=</span> <span class="n">nurses_by_id</span><span class="p">[</span><span class="n">nurse_id2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ctname</span> <span class="o">=</span> <span class="s1">&#39;medium_ct_nurse_assoc_</span><span class="si">{0!s}</span><span class="s1">_</span><span class="si">{1!s}</span><span class="s1">_</span><span class="si">{2:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nurse_id1</span><span class="p">,</span> <span class="n">nurse_id2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">nurse1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">nurse2</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">ctname</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="eighth-constraint-incompatibilities">
<h5>Eighth constraint: incompatibilities<a class="headerlink" href="#eighth-constraint-incompatibilities" title="Permalink to this headline">&para;</a></h5>
<p>Similarly, certain pairs of nurses do not get along well, and we want to
avoid having them together on a shift. In other words, for each shift,
both nurses of an incompatible pair cannot be assigned together to the
shift.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For each pair of incompatible nurses, the sum of assigned variables is less than one</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="p">(</span><span class="n">nurse_id1</span><span class="p">,</span> <span class="n">nurse_id2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">nurse_incompatibilities</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">nurse_id1</span> <span class="ow">in</span> <span class="n">nurses_by_id</span> <span class="ow">and</span> <span class="n">nurse_id2</span> <span class="ow">in</span> <span class="n">nurses_by_id</span><span class="p">:</span>
        <span class="n">nurse1</span> <span class="o">=</span> <span class="n">nurses_by_id</span><span class="p">[</span><span class="n">nurse_id1</span><span class="p">]</span>
        <span class="n">nurse2</span> <span class="o">=</span> <span class="n">nurses_by_id</span><span class="p">[</span><span class="n">nurse_id2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ctname</span> <span class="o">=</span> <span class="s1">&#39;medium_ct_nurse_incompat_</span><span class="si">{0!s}</span><span class="s1">_</span><span class="si">{1!s}</span><span class="s1">_</span><span class="si">{2:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nurse_id1</span><span class="p">,</span> <span class="n">nurse_id2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">mdl</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">nurse1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">nurse2</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctname</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="express-the-objective">
<h4>Express the objective<a class="headerlink" href="#express-the-objective" title="Permalink to this headline">&para;</a></h4>
<p>The objective mixes different (and contradictory) KPIs.</p>
<p>The first KPI is the total salary cost, computed as the sum of work
times over all nurses, weighted by pay rate. The second KPI is the total
number of assignments (nurse, shift). The third KPI is the average total
work time over all nurses. The fourth KPI represents the total number of
hours that is above the average work time (summed over all nurses),
while the fifth KPI represents the total number of hours that is below
this average. Finally, the last KPI is a measure of fairness, which is
evaluated as the total deviation from the average work time.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total_number_of_assignments</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">)</span>
<span class="n">nurse_costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">pay_rate</span> <span class="o">*</span> <span class="n">shift_activities</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">]</span>
<span class="n">total_salary_cost</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_costs</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_salary_cost</span><span class="p">,</span> <span class="s2">&quot;Total salary cost&quot;</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_number_of_assignments</span><span class="p">,</span> <span class="s2">&quot;Total number of assignments&quot;</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">average_nurse_work_time</span><span class="p">)</span>

<span class="n">total_over_average_worktime</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_over_average_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">)</span>
<span class="n">total_under_average_worktime</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nurse_under_average_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_over_average_worktime</span><span class="p">,</span> <span class="s2">&quot;Total over-average worktime&quot;</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_under_average_worktime</span><span class="p">,</span> <span class="s2">&quot;Total under-average worktime&quot;</span><span class="p">)</span>

<span class="n">total_fairness</span> <span class="o">=</span> <span class="n">total_over_average_worktime</span> <span class="o">+</span> <span class="n">total_under_average_worktime</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">add_kpi</span><span class="p">(</span><span class="n">total_fairness</span><span class="p">,</span> <span class="s2">&quot;Total fairness&quot;</span><span class="p">)</span>

<span class="n">mdl</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">nurses</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">variables</span><span class="p">:</span> <span class="mi">793</span>
   <span class="o">-</span> <span class="n">binary</span><span class="o">=</span><span class="mi">738</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="mi">55</span>
 <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">constraints</span><span class="p">:</span> <span class="mi">961</span>
   <span class="o">-</span> <span class="n">linear</span><span class="o">=</span><span class="mi">961</span>
 <span class="o">-</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">defaults</span>
 <span class="o">-</span> <span class="n">problem</span> <span class="nb">type</span> <span class="ow">is</span><span class="p">:</span> <span class="n">MILP</span>
</pre></div>
</div>
<div class="section" id="minimizing-objective">
<h5>Minimizing objective<a class="headerlink" href="#minimizing-objective" title="Permalink to this headline">&para;</a></h5>
<p>The goal is to minimize the non-weighted sum of the <em>total salary cost</em>,
<em>fairness</em> and <em>total number of assignment</em>. This is accomplished using
the <code class="docutils literal notranslate"><span class="pre">Model.minimize()</span></code> method.</p>
<p>This definition is arbitrary and could be revised. For instance, one
could emphasize minimizing salary cost by adding a weight on this term
in the objective.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdl</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">total_salary_cost</span> <span class="o">+</span> <span class="n">total_fairness</span> <span class="o">+</span> <span class="n">total_number_of_assignments</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="solve-with-decision-optimization">
<h4>Solve with Decision Optimization<a class="headerlink" href="#solve-with-decision-optimization" title="Permalink to this headline">&para;</a></h4>
<p>Now we have everything we need to solve the model, using
<code class="docutils literal notranslate"><span class="pre">Model.solve()</span></code>. The following cell solves using your local CPLEX (if
any, and provided you have added it to your <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> variable).</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set Cplex mipgap to 1e-5 to enforce precision to be of the order of a unit (objective value magnitude is ~1e+5).</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mip</span><span class="o">.</span><span class="n">tolerances</span><span class="o">.</span><span class="n">mipgap</span> <span class="o">=</span> <span class="mf">1e-5</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">log_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
    <span class="c1"># solve has failed, we try relaxation, based on constraint names</span>
    <span class="c1"># constraints are prioritized according to their names</span>
    <span class="c1"># if a name contains &quot;low&quot;, it has priority LOW</span>
    <span class="c1"># if a ct name contains &quot;medium&quot; it has priority MEDIUM</span>
    <span class="c1"># same for HIGH</span>
    <span class="c1"># if a constraint has no name or does not match any, it is not relaxable.</span>
    <span class="kn">from</span> <span class="nn">docplex.mp.relaxer</span> <span class="k">import</span> <span class="n">Relaxer</span>
    <span class="n">relaxer</span> <span class="o">=</span> <span class="n">Relaxer</span><span class="p">(</span><span class="n">prioritizer</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># self.enable_trace()</span>
    <span class="c1">#self.parameters.mip.tolerances.mipgap = 0.03 # 3%</span>
    <span class="n">relaxed_sol</span> <span class="o">=</span> <span class="n">relaxer</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">mdl</span><span class="p">)</span>
    <span class="n">relaxed_ok</span> <span class="o">=</span> <span class="n">relaxed_sol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">relaxed_ok</span><span class="p">,</span> <span class="s2">&quot;relaxation failed&quot;</span>
    <span class="n">relaxer</span><span class="o">.</span><span class="n">print_information</span><span class="p">()</span>

<span class="n">mdl</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPXPARAM_Read_DataCheck</span>                          <span class="mi">1</span>
<span class="n">CPXPARAM_MIP_Tolerances_MIPGap</span>                   <span class="mf">1.0000000000000001e-05</span>
<span class="n">Bound</span> <span class="n">infeasibility</span> <span class="n">column</span> <span class="s1">&#39;NurseWorkTime_Betsy&#39;</span><span class="o">.</span>
<span class="n">Presolve</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.29</span> <span class="n">ticks</span><span class="p">)</span>

<span class="n">Root</span> <span class="n">node</span> <span class="n">processing</span> <span class="p">(</span><span class="n">before</span> <span class="n">b</span><span class="o">&amp;</span><span class="n">c</span><span class="p">):</span>
  <span class="n">Real</span> <span class="n">time</span>             <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.45</span> <span class="n">ticks</span><span class="p">)</span>
<span class="n">Parallel</span> <span class="n">b</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">12</span> <span class="n">threads</span><span class="p">:</span>
  <span class="n">Real</span> <span class="n">time</span>             <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">ticks</span><span class="p">)</span>
  <span class="n">Sync</span> <span class="n">time</span> <span class="p">(</span><span class="n">average</span><span class="p">)</span>   <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span>
  <span class="n">Wait</span> <span class="n">time</span> <span class="p">(</span><span class="n">average</span><span class="p">)</span>   <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span>
                          <span class="o">------------</span>
<span class="n">Total</span> <span class="p">(</span><span class="n">root</span><span class="o">+</span><span class="n">branch</span><span class="o">&amp;</span><span class="n">cut</span><span class="p">)</span> <span class="o">=</span>    <span class="mf">0.00</span> <span class="n">sec</span><span class="o">.</span> <span class="p">(</span><span class="mf">0.45</span> <span class="n">ticks</span><span class="p">)</span>
<span class="ne">Warning</span><span class="p">:</span> <span class="mi">55</span> <span class="n">constraint</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">relaxed</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">:</span> <span class="n">average</span><span class="p">:</span> <span class="mi">18</span><span class="n">AverageWorkTime</span> <span class="o">==</span> <span class="n">NurseWorkTime_Betsy</span><span class="o">+</span><span class="n">NurseWorkTime_Cathy</span><span class="o">+</span><span class="n">NurseWorkTime_Cindy</span><span class="o">+</span><span class="n">NurseWorkTime_Debbie</span><span class="o">+</span><span class="n">NurseWorkTime_Dee</span><span class="o">+</span><span class="n">NurseWorkTime_Isabelle</span><span class="o">+</span><span class="n">NurseWorkTime_Jane</span><span class="o">+</span><span class="n">NurseWorkTime_Janelle</span><span class="o">+</span><span class="n">NurseWorkTime_Janice</span><span class="o">+</span><span class="n">NurseWorkTime_Jemma</span><span class="o">+</span><span class="n">NurseWorkTime_Joan</span><span class="o">+</span><span class="n">NurseWorkTime_Jude</span><span class="o">+</span><span class="n">NurseWorkTime_Julie</span><span class="o">+</span><span class="n">NurseWorkTime_Kate</span><span class="o">+</span><span class="n">NurseWorkTime_Patrick</span><span class="o">+</span><span class="n">NurseWorkTime_Suzanne</span><span class="o">+</span><span class="n">NurseWorkTime_Vickie</span><span class="o">+</span><span class="n">NurseWorkTime_Wendie</span><span class="p">)</span>
<span class="o">*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">relaxations</span><span class="p">:</span> <span class="mi">35</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Mon_18_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Mon_08_10</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Mon_12_8</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CARD_Mon_08_10</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">6.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CARD_Mon_12_8</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">6.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Tue_08_4</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Tue_18_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Tue_08_10</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">4.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Tue_12_8</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CARD_Tue_08_4</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CARD_Tue_18_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Wed_18_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Thu_02_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Thu_18_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Thu_08_10</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Thu_12_8</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Fri_18_3</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Fri_08_10</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_CONS_Fri_12_8</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Sat_02_5</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Sat_12_7</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">7.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Sat_20_12</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">4.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Sun_02_5</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_req_min_EMER_Sun_12_7</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">7.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Mon_02</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Mon_18</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Tue_18</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Wed_12</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Wed_18</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Thu_18</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Fri_18</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Sat_02</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Sat_12</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Sun_02</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
 <span class="o">-</span> <span class="n">relaxed</span><span class="p">:</span> <span class="n">high_required_Emergency_Cardiac</span> <span class="n">Care_1_EMER_Sun_12</span><span class="p">,</span> <span class="k">with</span> <span class="n">relaxation</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="o">*</span> <span class="n">total</span> <span class="n">absolute</span> <span class="n">relaxation</span><span class="p">:</span> <span class="mf">97.0</span>
<span class="o">*</span> <span class="n">model</span> <span class="n">nurses</span> <span class="n">solved</span> <span class="k">with</span> <span class="n">objective</span> <span class="o">=</span> <span class="mf">14097.333</span>
<span class="o">*</span>  <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">salary</span> <span class="n">cost</span>            <span class="o">=</span> <span class="mf">13940.000</span>
<span class="o">*</span>  <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">assignments</span>  <span class="o">=</span> <span class="mf">134.000</span>
<span class="o">*</span>  <span class="n">KPI</span><span class="p">:</span> <span class="n">AverageWorkTime</span>              <span class="o">=</span> <span class="mf">37.667</span>
<span class="o">*</span>  <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">over</span><span class="o">-</span><span class="n">average</span> <span class="n">worktime</span>  <span class="o">=</span> <span class="mf">11.667</span>
<span class="o">*</span>  <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">under</span><span class="o">-</span><span class="n">average</span> <span class="n">worktime</span> <span class="o">=</span> <span class="mf">11.667</span>
<span class="o">*</span>  <span class="n">KPI</span><span class="p">:</span> <span class="n">Total</span> <span class="n">fairness</span>               <span class="o">=</span> <span class="mf">23.333</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-5-investigate-the-solution-and-then-run-an-example-analysis">
<h3>Step 5: Investigate the solution and then run an example analysis<a class="headerlink" href="#step-5-investigate-the-solution-and-then-run-an-example-analysis" title="Permalink to this headline">&para;</a></h3>
<p>Let&#8217;s display some charts to visualize the results: a Gantt chart
displaying the assignment of nurses to shifts in a Gantt chart, and
another chart showing the number of assigned nurses to each department
over time.</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">min</span><span class="p">(</span><span class="n">shift_activities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">shift_activities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">day_start_time</span><span class="p">)</span>
<span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day_start_time</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shift_activities</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mi">24</span>
</pre></div>
</div>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># Build set of all departments and assign a color to each of them to be used in figures</span>
<span class="n">departments</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">department</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">}</span>
<span class="n">colorByDepartment</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">]):</span>
    <span class="n">colorByDepartment</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

<span class="c1"># Build dictionary with number of assigned nurses for each shift</span>
<span class="n">nbAssignmentsByShift</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nurses</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">solution_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nbAssignmentsByShift</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbAssignmentsByShift</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># Build a dictionary with the list of each shift corresponding to each department</span>
<span class="n">shiftsByDepartment</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
    <span class="n">shiftsByDepartment</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">department</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="c1"># Shared code</span>
<span class="k">def</span> <span class="nf">createLabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">):</span>
    <span class="n">shiftInfoByDay</span> <span class="o">=</span> <span class="p">{</span><span class="n">s1</span><span class="o">.</span><span class="n">day</span> <span class="p">:</span> <span class="n">s1</span> <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1"># Python 2</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="n">shift_activities</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">day_start_time</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shiftInfoByDay</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()],</span>
              <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shiftInfoByDay</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="n">shift_activities</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">day_start_time</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shiftInfoByDay</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
              <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shiftInfoByDay</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day_start_time</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shift_activities</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span>
              <span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day_start_time</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shift_activities</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">30</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="c1"># Plot shift assignments for each nurse</span>
<span class="k">def</span> <span class="nf">displayNursesAssignmentsGantt</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ylabels</span><span class="p">,</span> <span class="n">tickloc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nurses</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nurse_assignment_vars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">solution_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">shift_activity</span> <span class="o">=</span> <span class="n">shift_activities</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">shift_activity</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="n">shift_activity</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">shift_activity</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">colorByDepartment</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">department</span><span class="p">])</span>

        <span class="n">ylabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (worked: </span><span class="si">{}</span><span class="s2"> hours)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">nurse_work_time_vars</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">solution_value</span><span class="p">))</span>
        <span class="n">tickloc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nurses</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">tickloc</span><span class="p">,</span> <span class="n">ylabels</span><span class="p">)</span>

    <span class="c1"># Create labels on x/y axis</span>
    <span class="n">createLabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;SHIFTS ASSIGNMENTS&#39;</span><span class="p">,</span> <span class="s1">&#39;DAY OF WEEK&#39;</span><span class="p">,</span> <span class="s1">&#39;NURSES&#39;</span><span class="p">)</span>

<span class="c1"># Plot number of assigned nurses for each shift, by department</span>
<span class="k">def</span> <span class="nf">displayDepartmentsAssignments</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ylabels</span><span class="p">,</span> <span class="n">tickloc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">maxNbAssignements</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nbAssignmentsByShift</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">departments</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shiftsByDepartment</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
            <span class="n">shift_activity</span> <span class="o">=</span> <span class="n">shift_activities</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">shift_activity</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">nbAssignmentsByShift</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxNbAssignements</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="n">width</span><span class="o">=</span><span class="n">shift_activity</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">shift_activity</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">color</span><span class="o">=</span><span class="n">colorByDepartment</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">department</span><span class="p">])</span>
        <span class="n">ylabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="n">tickloc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">departments</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">tickloc</span><span class="p">,</span> <span class="n">ylabels</span><span class="p">)</span>

    <span class="c1"># Create labels on x/y axis</span>
    <span class="n">createLabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;NUMBER OF ASSIGNED NURSES&#39;</span><span class="p">,</span> <span class="s1">&#39;DAY OF WEEK&#39;</span><span class="p">,</span> <span class="s1">&#39;DEPARTMENTS&#39;</span><span class="p">)</span>

<span class="c1"># Display figures as two sub-plots so that they are vertically aligned</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">12</span><span class="p">])</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">displayNursesAssignmentsGantt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">displayDepartmentsAssignments</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/nurses_scheduling_47_0.png" src="_images/nurses_scheduling_47_0.png" />
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">&para;</a></h2>
<p>You learned how to set up and use IBM Decision Optimization CPLEX
Modeling for Python to formulate a Mathematical Programming model and
solve it with IBM Decision Optimization on Cloud.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">&para;</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://ibmdecisionoptimization.github.io/docplex-doc/">CPLEX Modeling for Python
documentation</a></li>
<li><a class="reference external" href="https://developer.ibm.com/docloud/">Decision Optimization on
Cloud</a></li>
<li>Need help with DOcplex or to report a bug? Please go
<a class="reference external" href="https://stackoverflow.com/questions/tagged/docplex">here</a>.</li>
<li>Contact us at <a class="reference external" href="mailto:dofeedback&#37;&#52;&#48;wwpdl&#46;vnet&#46;ibm&#46;com">dofeedback<span>&#64;</span>wwpdl<span>&#46;</span>vnet<span>&#46;</span>ibm<span>&#46;</span>com</a>.</li>
</ul>
<p>Copyright &copy; 2017-2019 IBM. IPLA licensed Sample Materials.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="oil_blending.html" title="Maximizing the profit of an oil company"
             >next</a> |</li>
        <li class="right" >
          <a href="nurses_pandas.html" title="The Nurse Assignment Problem"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.21 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="samples.html" >Examples of mathematical programming</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2021, IBM&reg;.
    </div>
  </body>
</html>