

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>docplex.cp.fzn.fzn_parser &#8212; DOcplex.CP: Constraint Programming Modeling for Python V2.15 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">DOcplex.CP: Constraint Programming Modeling for Python V2.15 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for docplex.cp.fzn.fzn_parser</h1><div class="highlight"><pre>
<span></span><span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Source file provided under Apache License, Version 2.0, January 2004,</span>
<span class="c1"># http://www.apache.org/licenses/</span>
<span class="c1"># (c) Copyright IBM Corp. 2017, 2018</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Author: Olivier OUDOT, IBM Analytics, France Lab, Sophia-Antipolis</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parser converting a FZN file to internal model representation.</span>

<span class="sd">This parser does not support the complete set of predicates described in the specifications of FlatZinc</span>
<span class="sd">that can be found here: http://www.minizinc.org/downloads/doc-1.6/flatzinc-spec.pdf</span>

<span class="sd">Basically, it supports essentially integer expressions, some floating point expressions and custom</span>
<span class="sd">predicates related to scheduling.</span>

<span class="sd">The predicates that are supported are:</span>

<span class="sd"> * *array predicates*</span>

<span class="sd">   array_bool_and, array_bool_element, array_bool_or, array_bool_xor,</span>
<span class="sd">   array_float_element, array_int_element, array_set_element,</span>
<span class="sd">   array_var_bool_element, array_var_float_element, array_var_int_element, array_var_set_element.</span>

<span class="sd"> * *boolean predicates*</span>

<span class="sd">   bool2int, bool_and, bool_clause, bool_eq, bool_eq_reif, bool_le, bool_le_reif,</span>
<span class="sd">   bool_lin_eq, bool_lin_le, bool_lt, bool_lt_reif, bool_not, bool_or, bool_xor.</span>

<span class="sd"> * *integer predicates*</span>

<span class="sd">   int_abs, int_div, int_eq, int_eq_reif, int_le, int_le_reif, int_lin_eq, int_lin_eq_reif,</span>
<span class="sd">   int_lin_le, int_lin_le_reif, int_lin_ne, int_lin_ne_reif, int_lt, int_lt_reif, int_max, int_min,</span>
<span class="sd">   int_mod, int_ne, int_ne_reif, int_plus, int_times, int2float.</span>

<span class="sd"> * *float predicates*</span>

<span class="sd">   float_abs, float_exp, float_ln, float_log10, float_log2, float_sqrt, float_eq, float_eq_reif,</span>
<span class="sd">   float_le, float_le_reif, float_lin_eq, float_lin_eq_reif, float_lin_le, float_lin_le_reif, float_lin_lt,</span>
<span class="sd">   float_lin_lt_reif, float_lin_ne, float_lin_ne_reif, float_lt, float_lt_reif, float_max, float_min,</span>
<span class="sd">   float_ne, float_ne_reif, float_plus.</span>

<span class="sd"> * *set predicates*</span>

<span class="sd">   set_in, set_in_reif.</span>

<span class="sd"> * *custom predicates*</span>

<span class="sd">   all_different_int, subcircuit, count_eq_const, table_int, inverse,</span>
<span class="sd">   lex_lesseq_bool, lex_less_bool, lex_lesseq_int, lex_less_int, int_pow, cumulative</span>


<span class="sd">Detailed description</span>
<span class="sd">--------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">docplex.cp.fzn.fzn_tokenizer</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">docplex.cp.expression</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">docplex.cp.solution</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">docplex.cp.model</span> <span class="k">import</span> <span class="n">CpoModel</span>
<span class="kn">import</span> <span class="nn">docplex.cp.modeler</span> <span class="k">as</span> <span class="nn">modeler</span>
<span class="kn">import</span> <span class="nn">docplex.cp.config</span> <span class="k">as</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">docplex.cp.expression</span> <span class="k">as</span> <span class="nn">expression</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">docplex.cp.utils</span> <span class="k">import</span> <span class="n">xrange</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<span class="c1">###############################################################################</span>
<span class="c1">## Constants</span>
<span class="c1">###############################################################################</span>

<span class="c1">###############################################################################</span>
<span class="c1">## Public classes</span>
<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="FznParserException"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParserException">[docs]</a><span class="k">class</span> <span class="nc">FznParserException</span><span class="p">(</span><span class="n">CpoException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The base class for exceptions raised by the CPO parser</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new exception</span>
<span class="sd">        Args:</span>
<span class="sd">            msg: Error message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FznParserException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<span class="c1"># Parameter descriptor</span>
<span class="n">FznParameter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;FznParameter&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>   <span class="c1"># Variable name</span>
                                                       <span class="s1">&#39;type&#39;</span><span class="p">,</span>   <span class="c1"># Variable type (string)</span>
                                                       <span class="s1">&#39;size&#39;</span><span class="p">,</span>   <span class="c1"># Array size (if array), None for single value</span>
                                                       <span class="s1">&#39;value&#39;</span><span class="p">,</span>  <span class="c1"># Value</span>
                                                       <span class="p">))</span>

<div class="viewcode-block" id="FznObject"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznObject">[docs]</a><span class="k">class</span> <span class="nc">FznObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Descriptor of a FZN object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="FznParameter"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParameter">[docs]</a><span class="k">class</span> <span class="nc">FznParameter</span><span class="p">(</span><span class="n">FznObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Descriptor of a FZN parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>   <span class="c1"># Parameter name</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">,</span>   <span class="c1"># Parameter type</span>
                 <span class="s1">&#39;size&#39;</span><span class="p">,</span>   <span class="c1"># Array size (if array), None for variable</span>
                 <span class="s1">&#39;value&#39;</span><span class="p">,</span>  <span class="c1"># Initial value (if any)</span>
                 <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FZN parameter</span>
<span class="sd">        Args:</span>
<span class="sd">            name:   Name of the parameter</span>
<span class="sd">            type:   Type of the parameter</span>
<span class="sd">            size:   Array size, None if not array</span>
<span class="sd">            value:  Parameter value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;(type=&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, size=&#39;</span><span class="p">)</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, value=[&#39;</span><span class="p">)</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, value=&#39;</span><span class="p">)</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FznVariable"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznVariable">[docs]</a><span class="k">class</span> <span class="nc">FznVariable</span><span class="p">(</span><span class="n">FznObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Descriptor of a FZN variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>           <span class="c1"># Variable name</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">,</span>           <span class="c1"># Variable type (String)</span>
                 <span class="s1">&#39;domain&#39;</span><span class="p">,</span>         <span class="c1"># Domain</span>
                 <span class="s1">&#39;size&#39;</span><span class="p">,</span>           <span class="c1"># Array size (if array), None for variable</span>
                 <span class="s1">&#39;value&#39;</span><span class="p">,</span>          <span class="c1"># Initial value (if any)</span>
                 <span class="s1">&#39;annotations&#39;</span><span class="p">,</span>    <span class="c1"># Dictionary of annotations</span>

                 <span class="c1"># Attributes needed for model reduction</span>
                 <span class="s1">&#39;ref_vars&#39;</span><span class="p">,</span>   <span class="c1"># Tuple of variables referenced by this variable</span>
                 <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FZN variable</span>
<span class="sd">        Args:</span>
<span class="sd">            name:         Name of the variable</span>
<span class="sd">            type:         Variable type</span>
<span class="sd">            domain:       Variable domain</span>
<span class="sd">            annotations:  Declaration annotations (dictionary)</span>
<span class="sd">            size:         Array size, None if not array</span>
<span class="sd">            value:        Initial value, None if none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="FznVariable.is_defined"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznVariable.is_defined">[docs]</a>    <span class="k">def</span> <span class="nf">is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the variable is introduced</span>
<span class="sd">        Return:</span>
<span class="sd">            True if variable is introduced, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;is_defined_var&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span></div>

<div class="viewcode-block" id="FznVariable.is_introduced"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznVariable.is_introduced">[docs]</a>    <span class="k">def</span> <span class="nf">is_introduced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the variable is introduced</span>
<span class="sd">        Return:</span>
<span class="sd">            True if variable is introduced, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;var_is_introduced&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span></div>

<div class="viewcode-block" id="FznVariable.is_output"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznVariable.is_output">[docs]</a>    <span class="k">def</span> <span class="nf">is_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the variable is introduced</span>
<span class="sd">        Return:</span>
<span class="sd">            True if variable is introduced, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;output_var&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;output_array&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_domain_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the variable domain bounds</span>
<span class="sd">        Return:</span>
<span class="sd">            Tuple of values, or single value if identical</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="n">dmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">dmin</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">dmax</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;(type=&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;, dom=&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_defined</span><span class="p">():</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, defined&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_introduced</span><span class="p">():</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, introduced&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, value=[&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FznVariable</span><span class="p">):</span>
                        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, size=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, value=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FznConstraint"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznConstraint">[docs]</a><span class="k">class</span> <span class="nc">FznConstraint</span><span class="p">(</span><span class="n">FznObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Descriptor of a FZN constraint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;predicate&#39;</span><span class="p">,</span>  <span class="c1"># Name of the predicate</span>
                 <span class="s1">&#39;args&#39;</span><span class="p">,</span>       <span class="c1"># Arguments</span>
                 <span class="s1">&#39;defvar&#39;</span><span class="p">,</span>     <span class="c1"># Name of the variable defined by this constraint</span>

                 <span class="c1"># Attributes needed for model reduction</span>
                 <span class="s1">&#39;ref_vars&#39;</span><span class="p">,</span>   <span class="c1"># Tuple of variables referenced by this constraint, but not defined</span>
                 <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FZN constraint</span>
<span class="sd">        Args:</span>
<span class="sd">            predicate:    Name of the predicate</span>
<span class="sd">            args:         List or arguments</span>
<span class="sd">            annotations:  Declaration annotations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="n">predicate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defvar</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defines_var&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_vars</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ref_vars_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterator on the variables that are referenced in the arguments of this constraint.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Iterator on all variables referenced by this constraint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_array</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">a</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">FznVariable</span><span class="p">,</span> <span class="n">FznParameter</span><span class="p">)):</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defvar</span><span class="p">:</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">lstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defvar</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FznObjective"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznObjective">[docs]</a><span class="k">class</span> <span class="nc">FznObjective</span><span class="p">(</span><span class="n">FznObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Descriptor of a FZN objective</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;operation&#39;</span><span class="p">,</span>   <span class="c1"># Objective operation in &#39;satisfy&#39;, &#39;minimize&#39;, &#39;maximize&#39;</span>
                 <span class="s1">&#39;expr&#39;</span><span class="p">,</span>        <span class="c1"># Target expression</span>
                 <span class="s1">&#39;annotations&#39;</span><span class="p">,</span> <span class="c1"># Annotations</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FZN constraint</span>
<span class="sd">        Args:</span>
<span class="sd">            operation:   Objective operation in &#39;satisfy&#39;, &#39;minimize&#39;, &#39;maximize&#39;</span>
<span class="sd">            expr:        Target expression</span>
<span class="sd">            annotations: Annotations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation</span>   <span class="o">=</span> <span class="n">operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span>        <span class="o">=</span> <span class="n">expr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span></div>


<div class="viewcode-block" id="FznReader"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznReader">[docs]</a><span class="k">class</span> <span class="nc">FznReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reader of FZN file format &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;source_file&#39;</span><span class="p">,</span>  <span class="c1"># Source file</span>
                 <span class="s1">&#39;tokenizer&#39;</span><span class="p">,</span>    <span class="c1"># Reading tokenizer</span>
                 <span class="s1">&#39;token&#39;</span><span class="p">,</span>        <span class="c1"># Last read token</span>
                 <span class="s1">&#39;var_map&#39;</span><span class="p">,</span>      <span class="c1"># Dictionary of variables.</span>
                                 <span class="c1"># Key is variable name, value is variable descriptor</span>
                 <span class="s1">&#39;parameters&#39;</span><span class="p">,</span>   <span class="c1"># List of parameters</span>
                 <span class="s1">&#39;variables&#39;</span><span class="p">,</span>    <span class="c1"># List of variables</span>
                 <span class="s1">&#39;constraints&#39;</span><span class="p">,</span>  <span class="c1"># List of model constraints</span>
                 <span class="s1">&#39;objective&#39;</span><span class="p">,</span>    <span class="c1"># Model objective</span>
                 <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FZN reader</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FznReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="FznReader.parse"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznReader.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse a FZN file</span>

<span class="sd">        Args:</span>
<span class="sd">            cfile: FZN file to read</span>
<span class="sd">        Raises:</span>
<span class="sd">            FznParserException: Parsing exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store file name if first file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="n">cfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">FznTokenizer</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">cfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_document</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FznReader.parse_string"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznReader.parse_string">[docs]</a>    <span class="k">def</span> <span class="nf">parse_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse a string</span>

<span class="sd">        Result of the parsing is added to the current result model.</span>

<span class="sd">        Args:</span>
<span class="sd">            str: String to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">FznTokenizer</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_document</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FznReader.write"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznReader.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write the model.</span>

<span class="sd">        If the given output is a string, it is considered as a file name that is opened by this method</span>
<span class="sd">        using &#39;utf-8&#39; encoding.</span>

<span class="sd">        Args:</span>
<span class="sd">            out (Optional): Target output stream or file name. If not given, default value is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check file</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">open_utf8</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c1"># Check default output</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

        <span class="c1"># Write model content</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_read_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read all FZN document</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_predicate</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_parameter_or_variable</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_constraint</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_objective</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">FznParserException</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">log_exceptions</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_EOF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Unexpected token &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_read_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read a predicate declaration</span>

<span class="sd">        This function is called with first token already read and terminates with next token already read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a predicate has been read, False if nothing to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_KEYWORD_PREDICATE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Read predicate declaration</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TOKEN_SEMICOLON</span><span class="p">,</span> <span class="n">TOKEN_EOF</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_SEMICOLON</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Semicolon &#39;;&#39; expected at the end of a predicate declaration.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_read_parameter_or_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read a parameter or variable declaration</span>

<span class="sd">        This function is called with first token already read and terminates with next token already read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a parameter has been read, False if nothing to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_KEYWORD</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Read array size if any</span>
        <span class="n">arsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_array_size</span><span class="p">()</span>

        <span class="c1"># Check if variable declaration</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_VAR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_variable</span><span class="p">(</span><span class="n">arsize</span><span class="p">)</span>

        <span class="c1"># Check type name</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TOKEN_KEYWORD_BOOL</span><span class="p">,</span> <span class="n">TOKEN_KEYWORD_FLOAT</span><span class="p">,</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">,</span> <span class="n">TOKEN_KEYWORD_SET</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">tok</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_SET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_KEYWORD_OF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">)</span>

        <span class="c1"># Check separating colon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_COLON</span><span class="p">)</span>

        <span class="c1"># Check parameter name</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_SYMBOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Symbol expected as parameter name.&quot;</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_ASSIGN</span><span class="p">)</span>

        <span class="c1"># Read expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arsize</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">_domain_iterator</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_SET</span><span class="p">:</span>
            <span class="n">arsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN_SEMICOLON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Build result</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">FznParameter</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">arsize</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_read_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arsize</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read a variable declaration</span>

<span class="sd">        This function is called with first token already read and terminates with next token already read.</span>

<span class="sd">        Args:</span>
<span class="sd">            arsize:  Array size if any</span>
<span class="sd">        Returns:</span>
<span class="sd">            True if a variable has been read, False if nothing to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read type and domain</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_var_domain</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN_COLON</span><span class="p">)</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_SYMBOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Symbol expected as variable name.&quot;</span><span class="p">)</span>
        <span class="n">vid</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Check annotations</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_annotations</span><span class="p">()</span>
        <span class="c1"># print(&quot;Annotations: {}&quot;.format(annotations))</span>

        <span class="c1"># Check expression</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_ASSIGN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">()</span>

        <span class="c1"># Read ending semicolon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN_SEMICOLON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Create variable</span>
        <span class="n">fv</span> <span class="o">=</span> <span class="n">FznVariable</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">arsize</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_map</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="n">fv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_read_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read a constraint</span>

<span class="sd">        This function is called with first token already read and terminates with next token already read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a variable has been read, False if nothing to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check constraint token</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_KEYWORD_CONSTRAINT</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Read constraint name</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_SYMBOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Constraint name &#39;</span><span class="si">{}</span><span class="s2">&#39; should be a symbol.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
        <span class="n">cname</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Read parameters</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_PARENT_OPEN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_PARENT_CLOSE</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_COMMA</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Check annotations</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_annotations</span><span class="p">()</span>
        <span class="n">defvar</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defines_var&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Read ending semicolon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN_SEMICOLON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Store constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FznConstraint</span><span class="p">(</span><span class="n">cname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">annotations</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_read_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read solve objective</span>

<span class="sd">        This function is called with first token already read and terminates with next token already read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a variable has been read, False if nothing to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check constraint token</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_KEYWORD_SOLVE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Check annotations</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_annotations</span><span class="p">()</span>

        <span class="c1"># Read solve objective</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TOKEN_KEYWORD_SATISFY</span><span class="p">,</span> <span class="n">TOKEN_KEYWORD_MINIMIZE</span><span class="p">,</span> <span class="n">TOKEN_KEYWORD_MAXIMIZE</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span>
                <span class="s2">&quot;Solve objective &#39;</span><span class="si">{}</span><span class="s2">&#39; should be a symbol in &#39;satisfy&#39;, &#39;minimize&#39;, &#39;maximize&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">tok</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Read expression if any</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_SATISFY</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">()</span>

        <span class="c1"># Read ending semicolon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN_SEMICOLON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Store objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">FznObjective</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_read_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read an expression</span>

<span class="sd">        First expression token is already read.</span>
<span class="sd">        Function exits with current token following the last expression token</span>

<span class="sd">        Returns:</span>
<span class="sd">            Expression that has been read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="c1"># Check int constant</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># Check set const</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_INTERVAL</span><span class="p">:</span>
                <span class="n">tok2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tok2</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Set upper bound </span><span class="si">{}</span><span class="s2"> should be an integer constant.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tok2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">v1</span><span class="p">,)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">==</span> <span class="n">v2</span> <span class="k">else</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v1</span>

        <span class="c1"># Check float constant</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">TOKEN_TYPE_FLOAT</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Set of integer constant</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_BRACE_OPEN</span><span class="p">:</span>
            <span class="n">lints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
            <span class="k">while</span> <span class="n">tok</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_BRACE_CLOSE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Set element </span><span class="si">{}</span><span class="s2"> should be an integer constant.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
                <span class="n">lints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_COMMA</span><span class="p">:</span>
                    <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">lints</span>

        <span class="c1"># Check symbols</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">TOKEN_TYPE_SYMBOL</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># Check array access</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_HOOK_OPEN</span><span class="p">:</span>
                <span class="c1"># Access corresponding FZN element</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Unknown symbol &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
                <span class="n">tok2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tok2</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Array index &#39;</span><span class="si">{}</span><span class="s2">&#39; should be an integer constant.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_HOOK_CLOSE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="c1"># Build array access as a tuple (arr_name, index)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">tok2</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># Check annotation function call</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_PARENT_OPEN</span><span class="p">:</span>
                <span class="n">lexprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_PARENT_CLOSE</span><span class="p">:</span>
                    <span class="n">lexprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_COMMA</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lexprs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if corresponds to FZN element</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>

        <span class="c1"># Array of expressions</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_HOOK_OPEN</span><span class="p">:</span>
            <span class="n">lexprs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_HOOK_CLOSE</span><span class="p">:</span>
                <span class="n">lexprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_COMMA</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">lexprs</span>

        <span class="c1"># Check boolean constant</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_TRUE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_FALSE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Invalid expression start: &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_read_array_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read an array size declaration</span>

<span class="sd">        First expression token is already read.</span>
<span class="sd">        Function exits with current token following the last expression token</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array size as int if given,</span>
<span class="sd">            -1 if size is not precised,</span>
<span class="sd">            None if no array specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check array token</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_KEYWORD_ARRAY</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Read array specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_HOOK_OPEN</span><span class="p">)</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">:</span>
            <span class="n">arsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Array size should start by  &#39;1&#39;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_INTERVAL</span><span class="p">)</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Array size &#39;</span><span class="si">{}</span><span class="s2">&#39; should be integer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
            <span class="n">arsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_HOOK_CLOSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">(),</span> <span class="n">TOKEN_KEYWORD_OF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">arsize</span>


    <span class="k">def</span> <span class="nf">_read_var_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read the domain of a variable.</span>

<span class="sd">        First expression token is already read.</span>
<span class="sd">        Function exits with current token following the last expression token</span>

<span class="sd">        Returns:</span>
<span class="sd">            Type token and variable domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get token</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">tok</span>

        <span class="c1"># Check boolean domain</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_BOOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">BINARY_DOMAIN</span>

        <span class="c1"># Check undefined domain</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">DEFAULT_INTEGER_VARIABLE_DOMAIN</span>

        <span class="c1"># Read set of integers or interval</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_BRACE_OPEN</span><span class="p">:</span>
            <span class="n">lint</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">())</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">llen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lint</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">llen</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">llen</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lint</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">lint</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">dom</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lint</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lint</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lint</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">return</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>

        <span class="c1"># Check integer domain</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Variable domain should start by an integer constant.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_INTERVAL</span><span class="p">:</span>
            <span class="n">tok2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tok2</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_INTEGER</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Domain upper bound </span><span class="si">{}</span><span class="s2"> should be an integer constant.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tok2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v1</span> <span class="o">==</span> <span class="n">v2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">,</span> <span class="p">(</span><span class="n">v1</span><span class="p">,)</span>
            <span class="k">return</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">,</span> <span class="p">((</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TOKEN_KEYWORD_INT</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">),)</span>


    <span class="k">def</span> <span class="nf">_read_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read a list of annotations</span>

<span class="sd">        First expression token is already read.</span>
<span class="sd">        Function exits with current token following the last expression token</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of annotations. Key is name, value is tuple or parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Check annotation start token</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_DOUBLECOLON</span><span class="p">:</span>
            <span class="c1"># Read annotation name</span>
            <span class="n">anm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">anm</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_TYPE_SYMBOL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Annotation name &#39;</span><span class="si">{}</span><span class="s2">&#39; should be a symbol.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anm</span><span class="p">))</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="n">TOKEN_PARENT_OPEN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TOKEN_PARENT_CLOSE</span><span class="p">:</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_expression</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="n">TOKEN_COMMA</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_token</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">anm</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span> <span class="nf">_next_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read next token</span>
<span class="sd">        Returns:</span>
<span class="sd">            Next read token, None if end of input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">next_token</span><span class="p">()</span>
        <span class="c1"># print(&quot;Line {}, col {}, tok &#39;{}&#39;&quot;.format(self.tokenizer.line_number, self.tokenizer.read_index, self.token))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>


    <span class="k">def</span> <span class="nf">_check_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">etok</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check that a read token is a given one an raise an exception if not</span>
<span class="sd">        Args:</span>
<span class="sd">            tok: Read token</span>
<span class="sd">            etok: Expected token</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tok</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">etok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_exception</span><span class="p">(</span><span class="s2">&quot;Read token &#39;</span><span class="si">{}</span><span class="s2">&#39; instead of expected &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">etok</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_raise_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Raise a Parsing exception</span>
<span class="sd">        Args:</span>
<span class="sd">            msg:  Exception message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">build_error_string</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div>



<div class="viewcode-block" id="FznParser"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParser">[docs]</a><span class="k">class</span> <span class="nc">FznParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reader of FZN file format &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span>          <span class="c1"># Read model</span>
                 <span class="s1">&#39;compiled&#39;</span><span class="p">,</span>       <span class="c1"># Model compiled indicator</span>
                 <span class="s1">&#39;reader&#39;</span><span class="p">,</span>         <span class="c1"># FZN reader</span>
                 <span class="s1">&#39;cpo_exprs&#39;</span><span class="p">,</span>      <span class="c1"># Dictionary of CPO expressions. Key=name, value=CPO expr</span>
                 <span class="s1">&#39;reduce&#39;</span><span class="p">,</span>         <span class="c1"># Reduce model indicator</span>
                 <span class="s1">&#39;interval_gen&#39;</span><span class="p">,</span>   <span class="c1"># Name generator for interval var expressions</span>
                 <span class="s1">&#39;cumul_gen&#39;</span><span class="p">,</span>      <span class="c1"># Name generator for cumul atom expressions</span>

                 <span class="s1">&#39;parameters&#39;</span><span class="p">,</span>     <span class="c1"># List of parameters</span>
                 <span class="s1">&#39;variables&#39;</span><span class="p">,</span>      <span class="c1"># List of variables</span>
                 <span class="s1">&#39;constraints&#39;</span><span class="p">,</span>    <span class="c1"># List of model constraints</span>
                 <span class="s1">&#39;objective&#39;</span><span class="p">,</span>      <span class="c1"># Model objective</span>

                 <span class="s1">&#39;cur_constraint&#39;</span><span class="p">,</span> <span class="c1"># Currently compiled constraint descriptor</span>

                 <span class="s1">&#39;def_var_exprs&#39;</span><span class="p">,</span>  <span class="c1"># List of expressions waiting for defvars to be defined</span>
                 <span class="s1">&#39;cpo_variables&#39;</span><span class="p">,</span>  <span class="c1"># Set of names of variables that are translated as real CPO variables</span>
                 <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FZN format parser</span>

<span class="sd">        Args:</span>
<span class="sd">            mdl:  Model to fill, None (default) to create a new one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FznParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">mdl</span> <span class="k">if</span> <span class="n">mdl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">CpoModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">FznReader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval_gen</span> <span class="o">=</span> <span class="n">IdAllocator</span><span class="p">(</span><span class="s2">&quot;IntervalVar_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumul_gen</span> <span class="o">=</span> <span class="n">IdAllocator</span><span class="p">(</span><span class="s2">&quot;VarCumulAtom_&quot;</span><span class="p">)</span>

        <span class="c1"># Do not store location information (would store parser instead of real lines)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">source_loc</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Set model reduction indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">fzn_reduce</span>


<div class="viewcode-block" id="FznParser.get_model"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParser.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the model that have been parsed</span>

<span class="sd">        Return:</span>
<span class="sd">            CpoModel result of the parsing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_to_model</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span></div>


<div class="viewcode-block" id="FznParser.parse"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse a FZN file</span>

<span class="sd">        Args:</span>
<span class="sd">            cfile: FZN file to read</span>
<span class="sd">        Raises:</span>
<span class="sd">            FznParserException: Parsing exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">source_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="n">cfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="FznParser.parse_string"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParser.parse_string">[docs]</a>    <span class="k">def</span> <span class="nf">parse_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse a string</span>

<span class="sd">        Result of the parsing is added to the current result model.</span>

<span class="sd">        Args:</span>
<span class="sd">            str: String to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">parse_string</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span></div>


<div class="viewcode-block" id="FznParser.get_output_variables"><a class="viewcode-back" href="../../../../docplex.cp.fzn.fzn_parser.py.html#docplex.cp.fzn.fzn_parser.FznParser.get_output_variables">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the list of model output variables</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of output variables, in declaration order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_output</span><span class="p">()]</span></div>


    <span class="k">def</span> <span class="nf">_write_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print read model (short version)</span>
<span class="sd">        Args:</span>
<span class="sd">            out (optional): Output stream. Default is stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span><span class="o">.</span><span class="n">get_cpo_string</span><span class="p">(</span><span class="n">short_output</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_cpo_expr_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; For testing, get the map of CPO expressions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span>


    <span class="k">def</span> <span class="nf">_compile_to_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile FZN model into CPO model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">def_var_exprs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Reduce model if required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_model</span><span class="p">()</span>

        <span class="c1"># print(&quot;=== Variables:&quot;)</span>
        <span class="c1"># for v in self.variables:</span>
        <span class="c1">#     print(&quot; : {}&quot;.format(v))</span>
        <span class="c1"># print(&quot;=== Constraints:&quot;)</span>
        <span class="c1"># for c in self.constraints:</span>
        <span class="c1">#     print(&quot; : {}&quot;.format(c))</span>
        <span class="c1"># sys.stdout.flush()</span>

        <span class="c1"># Compile parameters</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_parameter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Compile variables</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_variable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Compile constraints</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compile_variable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compile_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compile_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Compile objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_compile_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile a FZN parameter into CPO model</span>
<span class="sd">        Args:</span>
<span class="sd">            fp: Flatzinc parameter, object of class FznParameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fp</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Type_IntArray</span> <span class="k">if</span> <span class="n">fp</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">Type_Int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fp</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Type_FloatArray</span> <span class="k">if</span> <span class="n">fp</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">Type_Float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">build_cpo_expr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Add to map</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>


    <span class="k">def</span> <span class="nf">_compile_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile a FZN variable into CPO model</span>
<span class="sd">        Args:</span>
<span class="sd">            fv: Flatzinc variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if variable is array</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># Build array of variables</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="c1"># Check if there is a reference to a not yet defined variable</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">def_var_exprs</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">def_var_exprs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
                            <span class="k">return</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">Type_IntVarArray</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type_IntVar</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">)</span> <span class="k">else</span> <span class="n">Type_IntExprArray</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Build array of variables</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">integer_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">Type_IntVarArray</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Build single variable</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Type_Int</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Type_Bool</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if value is another variable</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                    <span class="c1"># Retrieve existing variable</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">CpoIntVar</span><span class="p">),</span> <span class="s2">&quot;Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create new variable</span>
                    <span class="n">dom</span> <span class="o">=</span> <span class="n">_build_domain</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="n">fv</span><span class="o">.</span><span class="n">domain</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">integer_var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">dom</span><span class="p">)</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">[</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>


    <span class="k">def</span> <span class="nf">_compile_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile a FZN constraint into CPO model</span>
<span class="sd">        Args:</span>
<span class="sd">            fv: Flatzinc constraint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Search in local methods</span>
        <span class="n">cmeth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_compile_pred_&quot;</span> <span class="o">+</span> <span class="n">fc</span><span class="o">.</span><span class="n">predicate</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmeth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="s2">&quot;Predicate &#39;</span><span class="si">{}</span><span class="s2">&#39; is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">predicate</span><span class="p">))</span>

        <span class="c1"># Call compile method</span>
        <span class="n">cmeth</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_compile_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile a FZN objective into CPO model</span>
<span class="sd">        Args:</span>
<span class="sd">            fo: Flatzinc objective</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&quot;Compile objective {}&quot;.format(fo))</span>
        <span class="k">if</span> <span class="n">fo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">operation</span> <span class="o">!=</span> <span class="s1">&#39;satisfy&#39;</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">oxpr</span> <span class="o">=</span> <span class="n">modeler</span><span class="o">.</span><span class="n">maximize</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;maximize&#39;</span> <span class="k">else</span> <span class="n">modeler</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">oxpr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_reduce_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reduce model size by factorizing expressions when possible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Access main model elements</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>

        <span class="c1"># Build reduction data related to variables</span>
        <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="c1"># Build list of variables that are referenced by this one</span>
            <span class="n">fv</span><span class="o">.</span><span class="n">ref_vars</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fv</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">))</span> <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="p">()</span>
            <span class="c1"># Set in defined variables if output</span>
            <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">is_output</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># In constraints, replace reference to arrays by arrays themselves</span>
        <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Initialize set of variables defined in constraints</span>
        <span class="n">def_var_map</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># Key is variable, value is constraint where variable is defined</span>
        <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="c1"># print(&quot;Scan constraint {}&quot;.format(fc))</span>
            <span class="n">defvar</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span>
            <span class="k">if</span> <span class="n">defvar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">def_var_map</span><span class="p">[</span><span class="n">defvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span>
            <span class="c1"># Build list of all variables referenced by this constraint</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">nbrefdvar</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">_ref_vars_iterator</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">defvar</span><span class="p">:</span>
                    <span class="n">nbrefdvar</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">ref_vars</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="c1"># Special case for cumulative. All variables are supposed defined by the constraint.</span>
            <span class="k">if</span> <span class="n">fc</span><span class="o">.</span><span class="n">predicate</span> <span class="o">==</span> <span class="s1">&#39;cumulative&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">ref_vars</span><span class="p">:</span>
                    <span class="n">def_var_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span>
            <span class="c1"># print(&quot;   result list of ref variables: {}&quot;.format(fc.ref_vars))</span>
            <span class="c1"># If defined variable is referenced twice in the constraint, remove it as defined (keep as declared variable)</span>
            <span class="k">if</span> <span class="n">nbrefdvar</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">defvar</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Determine connected variable subsets</span>
        <span class="c1">#self._determine_connex_variables(def_var_map)</span>

        <span class="c1"># Scan variables to move them after definition of their dependencies when needed</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># New list of variables</span>
        <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="c1">#print(&quot;Scan variable {}, Refvars: {}&quot;.format(fv, [v.name for v in fv.ref_vars]))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">def_var_map</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fv</span><span class="o">.</span><span class="n">ref_vars</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_in_constraints</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">def_var_map</span><span class="p">):</span>
                    <span class="c1"># Remove from list of variables (moved in constraints)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Keep it as a model variable</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>

        <span class="c1"># Reorder constraints</span>
        <span class="c1">#print(&quot;\nScan constraints. Defined vars: {}&quot;.format([v.name for v in defined_vars]))</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
        <span class="n">nbct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">movedcstr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># Constraints already moved</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">cx</span> <span class="o">&lt;</span> <span class="n">nbct</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
            <span class="c1">#print(&quot;Scan constraint {}. Refvars: {}&quot;.format(fc, [v.name for v in fc.ref_vars]))</span>
            <span class="c1">#print(&quot;Defined vars: {}&quot;.format([v.name for v in defined_vars]))</span>
            <span class="c1"># Process case of variable that has been inserted in constraints</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="n">def_var_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Search if constraint can be moved</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">movedcstr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">predicate</span> <span class="o">!=</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">def_var_map</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">ref_vars</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_in_constraints</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">def_var_map</span><span class="p">):</span>
                    <span class="c1"># Move constraint after all is defined</span>
                    <span class="k">del</span> <span class="n">constraints</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
                    <span class="n">movedcstr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
                    <span class="n">cx</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Constraint stays where it is</span>
                    <span class="k">if</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">:</span>
                        <span class="n">def_var_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># print(&quot;Reduction ended.&quot;)</span>
        <span class="c1"># print(&quot;   Variables:&quot;)</span>
        <span class="c1"># for v in self.variables:</span>
        <span class="c1">#     print(&quot;      {}&quot;.format(v))</span>
        <span class="c1"># print(&quot;   Constraints:&quot;)</span>
        <span class="c1"># for c in self.constraints:</span>
        <span class="c1">#     print(&quot;      {}&quot;.format(c))</span>


    <span class="k">def</span> <span class="nf">_insert_in_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">varsctsr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert a constraint or a variable in constraints after all its members are defined</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:         FZN constraint or variable to insert</span>
<span class="sd">            cx:         Start insertion index</span>
<span class="sd">            varsctsr:   Map of constraints where each variable is defined</span>
<span class="sd">        Return:</span>
<span class="sd">            True if insertion was successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build set of constraints to skip to wait for variable definition</span>
        <span class="n">cset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varsctsr</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">ref_vars</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varsctsr</span><span class="p">)</span>

        <span class="c1"># Check no dependency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cset</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Search in next constraints</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)):</span>
            <span class="n">cset</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cset</span><span class="p">:</span>
                <span class="c1"># Insert after this place</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fc</span><span class="p">)</span>
                <span class="c1"># print(&quot;   inserted at best rank {}&quot;.format(cx + 1))</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Impossible to insert</span>
        <span class="c1"># print(&quot;   impossible to insert&quot;)</span>
        <span class="k">return</span> <span class="kc">False</span>


    <span class="k">def</span> <span class="nf">_determine_connex_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">def_var_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Search connex sub-graphes in variables dependencies and put all multi-variables connex parts as cpo variables</span>
<span class="sd">        Args:</span>
<span class="sd">            def_var_map: Map of constraints where variable is defined</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create result map. Key is variable descriptor, value is set of connected variable descriptors</span>
        <span class="n">lcomps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># For each variable, build the list of depending variables</span>
        <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">fv</span><span class="p">]</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
                <span class="n">sv</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sv</span><span class="o">.</span><span class="n">ref_vars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lcomps</span><span class="p">:</span>
                            <span class="n">dset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lcomps</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">fc</span> <span class="o">=</span> <span class="n">def_var_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fc</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">ref_vars</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
                            <span class="c1">#print(&quot;   cstr.ref: {}&quot;.format(v))</span>
                            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lcomps</span><span class="p">:</span>
                                <span class="n">dset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lcomps</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">lcomps</span><span class="p">[</span><span class="n">fv</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span>

        <span class="c1"># Sort all variables list in ascending cardinality order</span>
        <span class="c1">#print(&quot;Variables graphs:&quot;)</span>
        <span class="c1">#for k, v in lcomps.items():</span>
        <span class="c1">#    print(&quot;   {}: {}&quot;.format(k.name, [x.name for x in v]))</span>
        <span class="n">lcomps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lcomps</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="c1"># Remove each set in next ones</span>
        <span class="n">nbcomps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lcomps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbcomps</span><span class="p">):</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">lcomps</span><span class="p">[</span><span class="n">x1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbcomps</span><span class="p">):</span>
                    <span class="n">lcomps</span><span class="p">[</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcomps</span><span class="p">[</span><span class="n">x2</span><span class="p">]</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>

        <span class="c1"># Set as model variables all that are in component with at least two variables</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">lcomps</span><span class="p">:</span>
            <span class="c1">#print(&quot;   graph component: {}&quot;.format([x.name for x in c]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1">#print(&quot;CPO model variables identified: {}&quot;.format([v for v in self.cpo_variables]))</span>


    <span class="k">def</span> <span class="nf">_get_cpo_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve a CPO expression from its FZN representation</span>
<span class="sd">        Args:</span>
<span class="sd">            expr:  FZN expression</span>
<span class="sd">        Returns:</span>
<span class="sd">            Corresponding CPO expression</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#print(&quot;   _get_cpo_expr({}, type={})&quot;.format(expr, type(expr)))</span>

        <span class="c1"># Check basic types</span>
        <span class="n">etyp</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">etyp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FznVariable</span><span class="p">,</span> <span class="n">FznParameter</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="s2">&quot;Can not find element </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="c1"># Integer constant</span>
        <span class="k">if</span> <span class="n">etyp</span> <span class="ow">in</span> <span class="n">INTEGER_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CpoValue</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Type_Int</span><span class="p">)</span>

        <span class="c1"># Array</span>
        <span class="k">if</span> <span class="n">etyp</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">build_cpo_expr</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">])</span>

        <span class="c1"># Check array access</span>
        <span class="k">if</span> <span class="n">etyp</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># Check tuple of integers</span>
            <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># Access to array element</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="s2">&quot;Can not find array </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Boolean</span>
        <span class="k">if</span> <span class="n">etyp</span> <span class="ow">in</span> <span class="n">BOOL_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CpoValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Type_Bool</span><span class="p">)</span> <span class="k">if</span> <span class="n">expr</span> <span class="k">else</span> <span class="n">CpoValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Type_Bool</span><span class="p">)</span>

        <span class="c1"># String</span>
        <span class="k">if</span> <span class="n">etyp</span> <span class="ow">in</span> <span class="n">STRING_TYPES</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="s2">&quot;Can not find element </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="c1"># Unknown</span>
        <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="s2">&quot;Can not find element </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

    <span class="c1"># Array predicates</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_bool_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_array_xxx_element</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_int_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_array_xxx_element</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_float_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_array_xxx_element</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_var_bool_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_array_xxx_element</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_var_int_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_array_xxx_element</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_var_float_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_array_xxx_element</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_bool_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">min_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_array_bool_or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">max_of</span><span class="p">)</span>

    <span class="c1"># Bool predicates</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">logical_and</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">logical_or</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_xor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_not</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">logical_not</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_xxx_eq</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_eq_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_le_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_lin_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_lin_le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool_lt_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_bool2int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_xxx_eq</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="c1"># Float predicates</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">abs_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">exponent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_ln</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_log10</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">/</span> <span class="n">modeler</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_log2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">/</span> <span class="n">modeler</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_xxx_eq</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_eq_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_le_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">lesst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_eq_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_le_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_lt_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lin_ne_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_lt_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">max_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">min_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_ne_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_float_plus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">plus</span><span class="p">)</span>

    <span class="c1"># Int predicates</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">abs_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">int_div</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_xxx_eq</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_eq_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_le_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lin_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lin_le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lin_ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lin_eq_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lin_le_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less_or_equal</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lin_ne_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_scal_prod</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_lt_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">less</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">max_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">min_of</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">mod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_ne_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_plus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">plus</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int2float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_xxx_eq</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>


    <span class="c1"># Set predicates</span>

    <span class="k">def</span> <span class="nf">_compile_pred_set_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">allowed_assignments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_set_in_reif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">allowed_assignments</span><span class="p">)</span>


    <span class="c1"># Custom predicates</span>

    <span class="k">def</span> <span class="nf">_compile_pred_all_different_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_1</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">all_diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_count_eq_const</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_lex_lesseq_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">lexicographic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_lex_lesseq_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">lexicographic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_int_pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_op_assign_arg_2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">power</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_pred_cumulative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Requires that a set of tasks given by start times s, durations d, and resource requirements r,</span>
<span class="sd">        never require more than a global resource bound b at any one time.</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:  Constraint descriptor, with arguments</span>
<span class="sd">                stime:  Tasks start time</span>
<span class="sd">                tdur:   Tasks tasks durations</span>
<span class="sd">                rreq:   Task resource requirements</span>
<span class="sd">                bnd:    Global resource bound</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&quot;Process cumulative constraint {}&quot;.format(fc))</span>

        <span class="c1"># Access constraint arguments</span>
        <span class="n">stime</span><span class="p">,</span> <span class="n">tdur</span><span class="p">,</span> <span class="n">rreq</span><span class="p">,</span> <span class="n">bnd</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># Create interval vars and cumul atoms</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">_get_fzn_array</span><span class="p">(</span><span class="n">stime</span><span class="p">)</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">_get_fzn_array</span><span class="p">(</span><span class="n">tdur</span><span class="p">)</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">_get_fzn_array</span><span class="p">(</span><span class="n">rreq</span><span class="p">)</span>
        <span class="c1">#print(&quot;ls: {}\nld: {}\nlr: {}&quot;.format(ls, [s for s in ld], lr))</span>
        <span class="n">cumul_atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
            <span class="n">vname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Get start time</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_get_domain_bounds</span><span class="p">()</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="c1"># Get duration</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">_get_domain_bounds</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vname</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="c1"># Get requirement</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">_get_domain_bounds</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vname</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="c1">#print(&quot;ds: {}, dd: {}, dr: {}&quot;.format(ds, dd, dr))</span>

            <span class="c1"># Create interval variable</span>
            <span class="k">if</span> <span class="n">vname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_gen</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="s2">&quot;Itv_&quot;</span> <span class="o">+</span> <span class="n">vname</span>
                <span class="k">if</span> <span class="n">vname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">:</span>
                    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">nname</span> <span class="o">=</span> <span class="n">vname</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span>
                    <span class="k">while</span> <span class="n">nname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">:</span>
                        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">nname</span> <span class="o">=</span> <span class="n">vname</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
                    <span class="n">vname</span> <span class="o">=</span> <span class="n">nname</span>
            <span class="c1"># Create interval variable</span>
            <span class="n">ivar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ivar</span><span class="p">:</span>
                <span class="c1"># Check it is the same</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="n">CpoIntervalVar</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ivar</span><span class="o">.</span><span class="n">get_start</span><span class="p">()</span> <span class="o">==</span> <span class="n">ds</span> <span class="ow">and</span> <span class="n">ivar</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span> <span class="o">==</span> <span class="n">dd</span> <span class="ow">and</span> <span class="n">ivar</span><span class="o">.</span><span class="n">get_end</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">INTERVAL_MIN</span><span class="p">,</span> <span class="n">INTERVAL_MAX</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ivar</span> <span class="o">=</span> <span class="n">interval_var</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="n">INTERVAL_MIN</span><span class="p">,</span> <span class="n">INTERVAL_MAX</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">vname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivar</span>

            <span class="c1"># Create pulse</span>
            <span class="n">pulse</span> <span class="o">=</span> <span class="n">modeler</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>
            <span class="n">cumul_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pulse</span><span class="p">)</span>
            <span class="c1"># Replace previous variable by access to interval variable</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">start_of</span><span class="p">(</span><span class="n">ivar</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">size_of</span><span class="p">(</span><span class="n">ivar</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">height_at_start</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="n">pulse</span><span class="p">))</span>

        <span class="c1"># Create final constraint</span>
        <span class="n">cumf</span> <span class="o">=</span> <span class="n">CpoFunctionCall</span><span class="p">(</span><span class="n">Oper_sum</span><span class="p">,</span> <span class="n">Type_CumulFunction</span><span class="p">,</span> <span class="p">(</span><span class="n">CpoValue</span><span class="p">(</span><span class="n">cumul_atoms</span><span class="p">,</span> <span class="n">Type_CumulAtomArray</span><span class="p">),))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">greater_or_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">bnd</span><span class="p">),</span> <span class="n">cumf</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_compile_pred_subcircuit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constrains the elements of x to define a subcircuit where x[i] = j means that j is the successor of i and x[i] = i means that i is not in the circuit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">CpoFunctionCall</span><span class="p">(</span><span class="n">Oper__sub_circuit</span><span class="p">,</span> <span class="n">Type_Constraint</span><span class="p">,</span> <span class="p">(</span><span class="n">build_cpo_expr</span><span class="p">(</span><span class="n">x</span><span class="p">),)</span> <span class="p">))</span>


    <span class="k">def</span> <span class="nf">_compile_pred_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constrains two arrays of int variables, f and invf, to represent inverse functions. All the values in each array must be within the index set of the other array.</span>
<span class="sd">        Args:</span>
<span class="sd">            f:     First function as array of int</span>
<span class="sd">            invf:  Inverse function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">invf</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">invf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">invf</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">CpoFunctionCall</span><span class="p">(</span><span class="n">Oper_inverse</span><span class="p">,</span> <span class="n">Type_Constraint</span><span class="p">,</span> <span class="p">(</span><span class="n">build_cpo_expr</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">build_cpo_expr</span><span class="p">(</span><span class="n">invf</span><span class="p">))))</span>


    <span class="k">def</span> <span class="nf">_compile_pred_bool_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implementation of bool_clause predicate</span>
<span class="sd">        Args:</span>
<span class="sd">            a:  First array of booleans</span>
<span class="sd">            b:  Second array of booleans</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># Default implementation</span>
        <span class="n">exprs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">sum_of</span><span class="p">(</span><span class="n">exprs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Alternative implementation</span>
        <span class="c1"># self._add_to_model( (modeler.max_of(a) &gt; 0) | (modeler.min_of(b) == 0) )</span>

        <span class="c1"># Other alternative implementation</span>
        <span class="c1"># expr = None</span>
        <span class="c1"># for x in _get_value(a):</span>
        <span class="c1">#     x = x &gt; 0</span>
        <span class="c1">#     expr = x if expr is None else modeler.logical_or(expr, x)</span>
        <span class="c1"># for x in _get_value(b):</span>
        <span class="c1">#     x = x == 0</span>
        <span class="c1">#     expr = x if expr is None else modeler.logical_or(expr, x)</span>
        <span class="c1"># self._add_to_model(expr)</span>


    <span class="k">def</span> <span class="nf">_compile_pred_table_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement custom predicate table_int</span>
<span class="sd">        Args:</span>
<span class="sd">            vars:    Array of variables</span>
<span class="sd">            values:  List of values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">vars</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># Split value array in tuples</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">tsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tsize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">tsize</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">tsize</span><span class="p">)]</span>
            <span class="c1"># Build allowed assignment expression</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">allowed_assignments</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">tuples</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_compile_pred_lex_less_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Requires that the array vars1 is strictly lexicographically less than array vars2</span>
<span class="sd">        Args:</span>
<span class="sd">            vars1:  First array of variables</span>
<span class="sd">            vars2:  Second array of variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vars1</span><span class="p">,</span> <span class="n">vars2</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># Add 0 and 1 at the end of arrays to force inequality</span>
        <span class="n">vars1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">vars1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vars2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">vars2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">lexicographic</span><span class="p">(</span><span class="n">vars1</span><span class="p">,</span> <span class="n">vars2</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_compile_pred_lex_less_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_pred_lex_less_bool</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_domain_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get min and max bounds of an expression, integer variable or integer</span>
<span class="sd">        Args:</span>
<span class="sd">            expr: CPO integer variable or expression</span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple (min, max)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Case of variable or variable replaced by an expression</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CpoIntVar</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_domain_min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">get_domain_max</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CpoFunctionCall</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">operation</span> <span class="ow">is</span> <span class="n">Oper_start_of</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_start</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">operation</span> <span class="ow">is</span> <span class="n">Oper_size_of</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span>
            <span class="c1"># if x.is_kind_of(Type_BoolExpr):</span>
            <span class="c1">#     return (0, 1)</span>
            <span class="n">cpov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpov</span><span class="p">,</span> <span class="n">CpoIntVar</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">cpov</span><span class="o">.</span><span class="n">get_domain_min</span><span class="p">(),</span> <span class="n">cpov</span><span class="o">.</span><span class="n">get_domain_max</span><span class="p">())</span>
            <span class="k">raise</span> <span class="n">FznParserException</span><span class="p">(</span><span class="s2">&quot;Unknow expression to take bounds from: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CpoValue</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>


    <span class="k">def</span> <span class="nf">_assign_to_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set a identifier with an expression</span>
<span class="sd">        Args:</span>
<span class="sd">            var:  Target FZN variable</span>
<span class="sd">            expr: CPO expression to assign</span>
<span class="sd">        Returns:</span>
<span class="sd">            None. If needed, changes are done in reader context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&quot;_assign_to_var {} expression {}&quot;.format(var, expr))</span>

        <span class="c1"># Retrieve existing expression</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span>
        <span class="n">vexpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>

        <span class="c1"># Check if reduction</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vexpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vexpr</span><span class="p">,</span> <span class="n">CpoIntVar</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">vexpr</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assign new name to expression</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
            <span class="c1"># Constrain expression to variable domain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constrain_expr_domain</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_make_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dvar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make equal two FZN expressions</span>
<span class="sd">        Args:</span>
<span class="sd">            var:   FZN variable or value</span>
<span class="sd">            expr:  CPO expression to be equal with</span>
<span class="sd">            dvar:  Define variable, None if none</span>
<span class="sd">        Returns:</span>
<span class="sd">            None. If needed, changes are done in reader context.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if var is not a variable</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">FznVariable</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># Check no reduction</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dvar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">var</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">expr</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Assign to variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_constrain_expr_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constrain the domain of an expression to the domain of a variable</span>
<span class="sd">        Args:</span>
<span class="sd">            expr: CPO expression to constrain</span>
<span class="sd">            var:  CPO or FZN integer var to take domain from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">domain</span>
        <span class="c1">#print(&quot;   constrain expression {} to domain {}&quot;.format(expr, dom))</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">_domain_min</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">_domain_max</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>

        <span class="c1"># Check boolean expression</span>
        <span class="k">if</span> <span class="n">dmin</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dmax</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_kind_of</span><span class="p">(</span><span class="n">Type_BoolExpr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dmin</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dmax</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Add appropriate constraint</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Single segment</span>
            <span class="c1"># Use range</span>
            <span class="k">if</span> <span class="n">dmin</span> <span class="o">==</span> <span class="n">dmax</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">dmin</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use allowed assignment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">allowed_assignments</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">_domain_iterator</span><span class="p">(</span><span class="n">dom</span><span class="p">)))</span>


    <span class="k">def</span> <span class="nf">_compile_op_assign_arg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile operation with single argument equal to a result</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:  Constraint descriptor</span>
<span class="sd">            op:  CPO operation to apply to first argument</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Access constraint arguments</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># Assign to expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_compile_op_assign_arg_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile operation with two arguments equal to a result</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:  Constraint descriptor</span>
<span class="sd">            op:  CPO operation to apply to arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Access constraint arguments</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># Assign to expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_compile_op_arg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile operation with one arguments and no result</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:  Constraint descriptor</span>
<span class="sd">            op:  CPO operation to apply to argument</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>


    <span class="k">def</span> <span class="nf">_compile_op_arg_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile operation with two arguments and no result</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:  Constraint descriptor</span>
<span class="sd">            op:  CPO operation to apply to arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>


    <span class="k">def</span> <span class="nf">_compile_array_xxx_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile access to array element &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">modeler</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_compile_xxx_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile all equality predicates &quot;&quot;&quot;</span>

        <span class="c1"># Access constraint arguments</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># Check default case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># Process trivial cases</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Retrieve defined variable</span>
        <span class="n">defvar</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span>
        <span class="k">if</span> <span class="n">defvar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">defvar</span> <span class="ow">is</span> <span class="n">a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_compile_scal_prod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">reif</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile a scalar product</span>
<span class="sd">        Args:</span>
<span class="sd">            fc:  Constraint</span>
<span class="sd">            op:  Comparison operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Access constraint arguments</span>
        <span class="k">if</span> <span class="n">reif</span><span class="p">:</span>
            <span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">reif</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># Check no reduction</span>
        <span class="n">defvar</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">defvar</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">defvar</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">modeler</span><span class="o">.</span><span class="n">scal_prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">coefs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="nb">vars</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">reif</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">reif</span><span class="p">),</span> <span class="n">expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Get array elements</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">_get_fzn_array</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="n">_get_fzn_array</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>

        <span class="c1"># Check if defined variable is the result</span>
        <span class="k">if</span> <span class="n">defvar</span> <span class="ow">is</span> <span class="n">res</span> <span class="ow">or</span> <span class="n">defvar</span> <span class="ow">is</span> <span class="n">reif</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_scal_prod_expr</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Arrange expression to have defined variable on the left</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">defvar</span><span class="p">)</span>
            <span class="n">vcoef</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[</span><span class="n">vx</span><span class="p">]</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[:</span><span class="n">vx</span><span class="p">]</span> <span class="o">+</span> <span class="nb">vars</span><span class="p">[</span><span class="n">vx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[:</span><span class="n">vx</span><span class="p">]</span> <span class="o">+</span> <span class="n">coefs</span><span class="p">[</span><span class="n">vx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">res</span> <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vcoef</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vcoef</span> <span class="o">=</span> <span class="o">-</span><span class="n">vcoef</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="o">-</span><span class="n">expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="o">-</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coefs</span><span class="p">])</span>

            <span class="c1"># Build result</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_scal_prod_expr</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vcoef</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span> <span class="o">/</span> <span class="n">vcoef</span>

        <span class="c1"># Check reif</span>
        <span class="k">if</span> <span class="n">reif</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">defvar</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check equality with a variable</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">modeler</span><span class="o">.</span><span class="n">equal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_to_var</span><span class="p">(</span><span class="n">defvar</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_model</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">defvar</span><span class="p">)))</span>


    <span class="k">def</span> <span class="nf">_build_scal_prod_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build a scal prod expression</span>
<span class="sd">        Args:</span>
<span class="sd">            coefs:  Array of coefficients (integers)</span>
<span class="sd">            vars:   Array of FZN variables</span>
<span class="sd">            res:    Initial result value (integer)</span>
<span class="sd">        Returns:</span>
<span class="sd">            New CPO scal_prod expression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build array of CPO variables</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cpo_expr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">]</span>

        <span class="c1"># Check developed scal_prod</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coefs</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">_mutl_by_int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">-</span> <span class="n">_mutl_by_int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">_mutl_by_int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># Build normal scal_prod</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">modeler</span><span class="o">.</span><span class="n">scal_prod</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="nb">vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">expr</span>
        <span class="k">return</span> <span class="n">expr</span>


    <span class="k">def</span> <span class="nf">_add_to_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an expression to the CPO model</span>
<span class="sd">        Args:</span>
<span class="sd">            expr: CPO expression to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&quot;_add_to_model({})&quot;.format(expr))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        
        <span class="c1"># Scan expression to identify used variables</span>
        <span class="n">estack</span> <span class="o">=</span> <span class="p">[</span><span class="n">expr</span><span class="p">]</span>
        <span class="n">doneset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of expressions already processed</span>
        <span class="k">while</span> <span class="n">estack</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">estack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">doneset</span><span class="p">:</span>
                <span class="n">doneset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">is_variable</span><span class="p">:</span>
                    <span class="c1">#print(&quot;   add CPO variable {}&quot;.format(e))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cpo_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># Stack children expressions</span>
                <span class="n">estack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write current parser status</span>
<span class="sd">        Args:</span>
<span class="sd">            out (optional):  Write output. sys.stdout if not given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Reader status:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   CPO expressions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpo_exprs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;      </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   Model expressions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_all_expressions</span><span class="p">():</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;      </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span></div>


<span class="c1">###############################################################################</span>
<span class="c1">## Utility functions</span>
<span class="c1">###############################################################################</span>

<span class="k">def</span> <span class="nf">_get_fzn_array</span><span class="p">(</span><span class="n">fzo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the list of objects of an FZN object</span>
<span class="sd">    Args:</span>
<span class="sd">        fzo: FZN object</span>
<span class="sd">    Returns:</span>
<span class="sd">        Array of FZN objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fzo</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fzo</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">fzo</span><span class="o">.</span><span class="n">value</span>


<span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the python value of an expression</span>
<span class="sd">    Args:</span>
<span class="sd">        expr: Expression (python or CPO)</span>
<span class="sd">    Returns:</span>
<span class="sd">        Python value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">CpoValue</span><span class="p">)</span> <span class="k">else</span> <span class="n">expr</span>


<span class="k">def</span> <span class="nf">_build_domain</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Build a variable domain from an initial value</span>
<span class="sd">    Args:</span>
<span class="sd">        v: Variable initial value</span>
<span class="sd">    Returns:</span>
<span class="sd">        Variable domain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>


<span class="c1"># def _build_cpo_value(v):</span>
<span class="c1">#     &quot;&quot;&quot; Build a value from a single Python value</span>
<span class="c1">#     Args:</span>
<span class="c1">#         v: Value</span>
<span class="c1">#     Returns:</span>
<span class="c1">#         Corresponding CPO value</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if v is True:</span>
<span class="c1">#         v = 1</span>
<span class="c1">#     elif v is False:</span>
<span class="c1">#         v = 0</span>
<span class="c1">#     return build_cpo_expr(v)</span>


<span class="k">def</span> <span class="nf">_mutl_by_int</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create an expression that multiply an expression by an integer</span>
<span class="sd">    Args:</span>
<span class="sd">        expr: Expression to constrain</span>
<span class="sd">        val:  Integer value to multiply expression with</span>
<span class="sd">    Returns:</span>
<span class="sd">        New expression</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">expr</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="n">expr</span>


</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">DOcplex.CP: Constraint Programming Modeling for Python V2.15 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, IBM.
    </div>
  </body>
</html>