

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>docplex.mp.sparktrans.transformers &#8212; DOcplex.MP: Mathematical Programming Modeling for Python V2.18 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.18 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for docplex.mp.sparktrans.transformers</h1><div class="highlight"><pre>
<span></span><span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Source file provided under Apache License, Version 2.0, January 2004,</span>
<span class="c1"># http://www.apache.org/licenses/</span>
<span class="c1"># (c) Copyright IBM Corp. 2018</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyspark</span> <span class="k">import</span> <span class="n">keyword_only</span>  <span class="c1">## &lt; 2.0 -&gt; pyspark.ml.util.keyword_only</span>
    <span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="k">import</span> <span class="n">Transformer</span>
    <span class="kn">from</span> <span class="nn">pyspark.ml.param.shared</span> <span class="k">import</span> <span class="n">Param</span>

    <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">SparkSession</span>
    <span class="n">spark_version</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span><span class="o">.</span><span class="n">version</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">spark_version</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">keyword_only</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> 
    <span class="n">Transformer</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">Param</span> <span class="o">=</span> <span class="n">SparkSession</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">docplex.mp.constants</span> <span class="k">import</span> <span class="n">ObjectiveSense</span>
<span class="kn">from</span> <span class="nn">docplex.mp.sktrans.modeler</span> <span class="k">import</span> <span class="n">make_modeler</span>
<span class="kn">from</span> <span class="nn">docplex.mp.utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">docplex.mp.sparktrans.spark_utils</span> <span class="k">import</span> <span class="n">make_solution</span>


<span class="k">def</span> <span class="nf">convert_to_list_or_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_spark_dataframe</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">is_pandas_series</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">is_numpy_ndarray</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span>


<div class="viewcode-block" id="CplexTransformerBase"><a class="viewcode-back" href="../../../../docplex.mp.sparktrans.transformers.html#docplex.mp.sparktrans.transformers.CplexTransformerBase">[docs]</a><span class="k">class</span> <span class="nc">CplexTransformerBase</span><span class="p">(</span><span class="n">Transformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Root class for CPLEX transformers for PySpark</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@keyword_only</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhsCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ubs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">modeler</span><span class="o">=</span><span class="s2">&quot;cplex&quot;</span><span class="p">,</span> <span class="n">solveParams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CplexTransformerBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhsCol</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rhsCol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minCol</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;minCol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxCol</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;maxCol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbs</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lbs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubs</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ubs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;types&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sense</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeler</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;modeler&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solveParams</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;solveParams&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">rhsCol</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">minCol</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">maxCol</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">lbs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">ubs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">modeler</span><span class="o">=</span><span class="n">modeler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">solveParams</span><span class="o">=</span><span class="p">{})</span>

        <span class="k">if</span> <span class="n">spark_version</span> <span class="o">&lt;</span> <span class="s1">&#39;2.2&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">_input_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setParams</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">docplex_modeler</span> <span class="o">=</span> <span class="n">make_modeler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getModeler</span><span class="p">())</span>

    <span class="nd">@keyword_only</span>
    <span class="k">def</span> <span class="nf">setParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhsCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ubs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solveParams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modeler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spark_version</span> <span class="o">&lt;</span> <span class="s1">&#39;2.2&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">_input_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setRhsCol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rhsCol</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getRhsCol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhsCol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setMinCol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">minCol</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getMinCol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minCol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setMaxCol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxCol</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getMaxCol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxCol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setLbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lbs</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getLbs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lbs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setUbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ubs</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getUbs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setSense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sense</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getSense</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sense</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setModeler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modeler</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getModeler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setSolveParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solveParams</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getSolveParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solveParams</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Main method to solve Linear Programming problems.</span>
<span class="sd">        Transforms the input dataset.</span>

<span class="sd">        :param dataset: the matrix describing the  constraints of the problem, which is an instance</span>
<span class="sd">                of :py:class:`pyspark.sql.DataFrame`</span>
<span class="sd">        :returns: transformed dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objSense</span> <span class="o">=</span> <span class="n">ObjectiveSense</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSense</span><span class="p">())</span>

        <span class="n">var_lbs</span> <span class="o">=</span> <span class="n">convert_to_list_or_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLbs</span><span class="p">())</span>
        <span class="n">var_ubs</span> <span class="o">=</span> <span class="n">convert_to_list_or_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getUbs</span><span class="p">())</span>
        <span class="n">var_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTypes</span><span class="p">()</span>

        <span class="n">min_max_cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getMinCol</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxCol</span><span class="p">()]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMinCol</span><span class="p">()</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getRhsCol</span><span class="p">()]</span>
        <span class="n">coef_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">min_max_cols</span><span class="p">]</span>
        <span class="n">nb_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_colnames</span><span class="p">)</span>

        <span class="c1"># Get min and max values as lists</span>
        <span class="n">minVals</span><span class="p">,</span> <span class="n">maxVals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_min_max_lists</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Get coefficients for objective evaluation</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getY</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">convert_to_list_or_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getY</span><span class="p">())</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">costs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span> <span class="o">==</span> <span class="n">nb_vars</span><span class="p">)</span>

        <span class="c1"># Build matrix of coefficients</span>
        <span class="n">cts_mat</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">coef_colnames</span><span class="p">])</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Call build matrix and solve</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSolveParams</span><span class="p">()</span>  <span class="c1"># User-defined engine parameters</span>
        <span class="k">if</span> <span class="n">minVals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docplex_modeler</span><span class="o">.</span><span class="n">build_matrix_linear_model_and_solve</span><span class="p">(</span><span class="n">nb_vars</span><span class="p">,</span> <span class="n">var_lbs</span><span class="p">,</span> <span class="n">var_ubs</span><span class="p">,</span> <span class="n">var_types</span><span class="p">,</span>
                                                                              <span class="n">coef_colnames</span><span class="p">,</span>
                                                                              <span class="n">cts_mat</span><span class="p">,</span> <span class="n">maxVals</span><span class="p">,</span>
                                                                              <span class="n">objsense</span><span class="o">=</span><span class="n">objSense</span><span class="p">,</span> <span class="n">costs</span><span class="o">=</span><span class="n">costs</span><span class="p">,</span>
                                                                              <span class="n">cast_to_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                              <span class="n">solution_maker</span><span class="o">=</span><span class="n">make_solution</span><span class="p">,</span>
                                                                              <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docplex_modeler</span><span class="o">.</span><span class="n">build_matrix_range_model_and_solve</span><span class="p">(</span><span class="n">nb_vars</span><span class="p">,</span> <span class="n">var_lbs</span><span class="p">,</span> <span class="n">var_ubs</span><span class="p">,</span> <span class="n">var_types</span><span class="p">,</span> <span class="n">coef_colnames</span><span class="p">,</span>
                                                                             <span class="n">cts_mat</span><span class="o">=</span><span class="n">cts_mat</span><span class="p">,</span>
                                                                             <span class="n">range_mins</span><span class="o">=</span><span class="n">minVals</span><span class="p">,</span> <span class="n">range_maxs</span><span class="o">=</span><span class="n">maxVals</span><span class="p">,</span>
                                                                             <span class="n">objsense</span><span class="o">=</span><span class="n">objSense</span><span class="p">,</span> <span class="n">costs</span><span class="o">=</span><span class="n">costs</span><span class="p">,</span>
                                                                             <span class="n">cast_to_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                             <span class="n">solution_maker</span><span class="o">=</span><span class="n">make_solution</span><span class="p">,</span>
                                                                             <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># &#39;result&#39; is a list: create a Spark DataFrame from it</span>
        <span class="n">sparkCtx</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sql_ctx</span>
        <span class="k">return</span> <span class="n">sparkCtx</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">coef_colnames</span><span class="p">,</span> <span class="n">result</span><span class="p">),</span> <span class="n">schema</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="CplexTransformer"><a class="viewcode-back" href="../../../../docplex.mp.sparktrans.transformers.html#docplex.mp.sparktrans.transformers.CplexTransformer">[docs]</a><span class="k">class</span> <span class="nc">CplexTransformer</span><span class="p">(</span><span class="n">CplexTransformerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A PySpark transformer class to solve linear problems.</span>

<span class="sd">    This transformer class solves LP problems of</span>
<span class="sd">    type::</span>

<span class="sd">            Ax &lt;= B</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@keyword_only</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhsCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ubs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">modeler</span><span class="o">=</span><span class="s2">&quot;cplex&quot;</span><span class="p">,</span> <span class="n">solveParams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of LPTransformer to solve linear problems.</span>

<span class="sd">        :param rhsCol: the name of the column in the input Spark DataFrame containing the upper bounds for the constraints.</span>
<span class="sd">        :param y: an optional sequence of scalars describing the cost vector</span>
<span class="sd">        :param lbs: an optional sequence of scalars describing the lower bounds for decision variables</span>
<span class="sd">        :param ubs: an optional sequence of scalars describing the upper bounds for decision variables</span>
<span class="sd">        :param types: a string for variable types within [BICSN]*</span>
<span class="sd">        :param sense: defines the objective sense. Accepts &#39;min&quot; or &quot;max&quot; (not case-sensitive),</span>
<span class="sd">            or an instance of docplex.mp.ObjectiveSense</span>
<span class="sd">        :param solveParams: optional keyword arguments to pass additional parameters for Cplex engine.</span>

<span class="sd">        Note:</span>
<span class="sd">            The Spark dataframe representing the matrix is supposed to have shape (M,N+1) where M is the number of rows</span>
<span class="sd">            and N the number of variables. The column named by the &#39;rhsCol&#39; parameter contains the right hand sides of the problem</span>
<span class="sd">            (the B in Ax &lt;= B)</span>
<span class="sd">            The optional vector y contains the N cost coefficients for each column variables.</span>

<span class="sd">        Example:</span>
<span class="sd">            Passing the Spark DataFrame = ([[1,2,3], [4,5,6]], [&#39;x&#39;, &#39;y&#39;, &#39;max&#39;]), rhsCol = &#39;max&#39;, y= [11,12] means</span>
<span class="sd">            solving the linear problem:</span>

<span class="sd">                minimize 11x + 12y</span>
<span class="sd">                s.t.</span>
<span class="sd">                        1x + 2y &lt;= 3</span>
<span class="sd">                        4x + 5y &lt;= 6</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spark_version</span> <span class="o">&lt;</span> <span class="s1">&#39;2.2&#39;</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CplexTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CplexTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_min_max_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRhsCol</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRhsCol</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s1">&#39;&quot;rhsCol&quot; parameter is not specified&#39;</span>

        <span class="n">maxVals</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRhsCol</span><span class="p">())</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxVals</span></div>


<div class="viewcode-block" id="CplexRangeTransformer"><a class="viewcode-back" href="../../../../docplex.mp.sparktrans.transformers.html#docplex.mp.sparktrans.transformers.CplexRangeTransformer">[docs]</a><span class="k">class</span> <span class="nc">CplexRangeTransformer</span><span class="p">(</span><span class="n">CplexTransformerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A PySpark transformer class to solve range-based linear problems.</span>

<span class="sd">    This transformer class solves LP problems of</span>
<span class="sd">    type::</span>

<span class="sd">            B &lt;= Ax &lt;= C</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@keyword_only</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxCol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ubs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">modeler</span><span class="o">=</span><span class="s2">&quot;cplex&quot;</span><span class="p">,</span> <span class="n">solveParams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of LPRangeTransformer to solve range-based linear problems.</span>

<span class="sd">        :param minCol: the name of the column in the input Spark DataFrame containing the lower bounds for the constraints.</span>
<span class="sd">        :param maxCol: the name of the column in the input Spark DataFrame containing the upper bounds for the constraints.</span>
<span class="sd">        :param y: an optional sequence of scalars describing the cost vector</span>
<span class="sd">        :param lbs: an optional sequence of scalars describing the lower bounds for decision variables</span>
<span class="sd">        :param ubs: an optional sequence of scalars describing the upper bounds for decision variables</span>
<span class="sd">        :param types: a string for variable types within [BICSN]*</span>
<span class="sd">        :param sense: defines the objective sense. Accepts &#39;min&quot; or &quot;max&quot; (not case-sensitive),</span>
<span class="sd">            or an instance of docplex.mp.ObjectiveSense</span>
<span class="sd">        :param solveParams: optional keyword arguments to pass additional parameters for Cplex engine.</span>

<span class="sd">        Note:</span>
<span class="sd">            The matrix X is supposed to have shape (M,N+2) where M is the number of rows</span>
<span class="sd">            and N the number of variables.</span>
<span class="sd">            The column named by the &#39;minCol&#39; and &#39;maxCol&#39; parameters contain the minimum (resp.maximum) values for the</span>
<span class="sd">            row ranges, that m and M in:</span>
<span class="sd">                    m &lt;= Ax &lt;= M</span>
<span class="sd">            The optional vector y contains the N cost coefficients for each column variables.</span>

<span class="sd">        Example:</span>
<span class="sd">            Passing the Spark DataFrame = ([[1,2,3,30], [4,5,6,60]], [&#39;x&#39;, &#39;y&#39;, &#39;min&#39;, &#39;max&#39;]), minCol = &#39;min&#39;,</span>
<span class="sd">            maxCol = &#39;max&#39;, y= [11,12] means solving the linear problem:</span>

<span class="sd">                minimize 11x + 12y</span>
<span class="sd">                s.t.</span>
<span class="sd">                        3 &lt;= 1x + 2y &lt;= 30</span>
<span class="sd">                        6 &lt;= 4x + 5y &lt;= 60</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spark_version</span> <span class="o">&lt;</span> <span class="s1">&#39;2.2&#39;</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CplexRangeTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CplexRangeTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_min_max_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMinCol</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMinCol</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s1">&#39;&quot;minCol&quot; parameter is not specified&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxCol</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxCol</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s1">&#39;&quot;maxCol&quot; parameter is not specified&#39;</span>

        <span class="n">minVals</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMinCol</span><span class="p">())</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">maxVals</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMaxCol</span><span class="p">())</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">minVals</span><span class="p">,</span> <span class="n">maxVals</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">DOcplex.MP: Mathematical Programming Modeling for Python V2.18 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2019, IBM&reg;.
    </div>
  </body>
</html>